{% extends "base.html" %}
{% block title %}Hỗ trợ khẩn cấp - ShieldCall VN{% endblock %}

{% block content %}
<div x-data="emergencyChat()" class="animate-fadein max-w-3xl mx-auto space-y-10">
    <!-- Page Header -->
    <div class="text-center space-y-4" data-aos="fade-up">
        <div class="inline-flex items-center justify-center w-24 h-24 rounded-[2.5rem] bg-red-500/10 text-red-500 border border-red-500/20 shadow-2xl shadow-red-500/10 mb-2" data-aos="zoom-in" data-aos-delay="100">
            <i class="bi bi-exclamation-octagon-fill text-5xl"></i>
        </div>
        <h1 class="text-4xl font-black text-red-500 tracking-tight leading-none uppercase" data-aos="fade-up" data-aos-delay="200">Hỗ trợ khẩn cấp</h1>
        <p class="text-white/40 text-sm font-bold tracking-widest uppercase" data-aos="fade-up" data-aos-delay="300">Giữ bình tĩnh và thực hiện ngay các bước bảo vệ dưới đây</p>
    </div>

    <!-- Steps Progression -->
    <div class="space-y-6">
        <!-- Step 1: STOP -->
        <div class="liquid-card p-8 border-l-8 border-red-500 bg-red-500/[0.02] hover:bg-red-500/[0.04] transition-all" data-aos="fade-up" data-aos-delay="400">
            <div class="flex flex-col sm:flex-row gap-8 items-start">
                <div class="w-12 h-12 rounded-2xl bg-red-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-red-500/20">01</div>
                <div class="space-y-4 flex-1">
                    <h2 class="text-xl font-black text-red-400 uppercase tracking-wide">Ngừng mọi giao dịch ngay lập tức</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex items-center gap-3 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-x-circle-fill text-red-500"></i>
                            <span class="text-xs font-black text-white/70 uppercase tracking-widest">Không chuyển thêm tiền</span>
                        </div>
                        <div class="flex items-center gap-3 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-x-circle-fill text-red-500"></i>
                            <span class="text-xs font-black text-white/70 uppercase tracking-widest">Không cung cấp OTP</span>
                        </div>
                        <div class="flex items-center gap-3 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-x-circle-fill text-red-500"></i>
                            <span class="text-xs font-black text-white/70 uppercase tracking-widest">Không click link lạ</span>
                        </div>
                        <div class="flex items-center gap-3 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-x-circle-fill text-red-500"></i>
                            <span class="text-xs font-black text-white/70 uppercase tracking-widest">Không tải app lạ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: BANK -->
        <div class="liquid-card p-8 border-l-8 border-yellow-500 bg-yellow-500/[0.02] hover:bg-yellow-500/[0.04] transition-all" data-aos="fade-up" data-aos-delay="500">
            <div class="flex flex-col sm:flex-row gap-8 items-start">
                <div class="w-12 h-12 rounded-2xl bg-yellow-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-yellow-500/20">02</div>
                <div class="space-y-5 flex-1 w-full">
                    <div class="space-y-1">
                        <h2 class="text-xl font-black text-yellow-400 uppercase tracking-wide">Gọi Hotline Ngân Hàng để Khoá Thẻ</h2>
                        <p class="text-xs font-bold text-white/40 uppercase tracking-widest">Liên hệ ngay để tạm ngừng mọi dịch vụ tài chính liên quan</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <a href="tel:1900545413" class="flex justify-between items-center p-4 rounded-2xl bg-white/[0.04] border border-white/5 hover:bg-white/10 transition-all group">
                            <span class="text-xs font-black text-white/80 uppercase">Vietcombank</span>
                            <span class="text-xs font-black text-cyan-400 group-hover:scale-110 transition-transform"><i class="bi bi-telephone-fill mr-1"></i> 1900 545 413</span>
                        </a>
                        <a href="tel:1800588822" class="flex justify-between items-center p-4 rounded-2xl bg-white/[0.04] border border-white/5 hover:bg-white/10 transition-all group">
                            <span class="text-xs font-black text-white/80 uppercase">Techcombank</span>
                            <span class="text-xs font-black text-cyan-400 group-hover:scale-110 transition-transform"><i class="bi bi-telephone-fill mr-1"></i> 1800 588 822</span>
                        </a>
                        <a href="tel:19009247" class="flex justify-between items-center p-4 rounded-2xl bg-white/[0.04] border border-white/5 hover:bg-white/10 transition-all group">
                            <span class="text-xs font-black text-white/80 uppercase">BIDV</span>
                            <span class="text-xs font-black text-cyan-400 group-hover:scale-110 transition-transform"><i class="bi bi-telephone-fill mr-1"></i> 1900 9247</span>
                        </a>
                        <a href="tel:1900558868" class="flex justify-between items-center p-4 rounded-2xl bg-white/[0.04] border border-white/5 hover:bg-white/10 transition-all group">
                            <span class="text-xs font-black text-white/80 uppercase">VietinBank</span>
                            <span class="text-xs font-black text-cyan-400 group-hover:scale-110 transition-transform"><i class="bi bi-telephone-fill mr-1"></i> 1900 558 868</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: POLICE -->
        <div class="liquid-card p-8 border-l-8 border-cyan-500 bg-cyan-500/[0.02] hover:bg-cyan-500/[0.04] transition-all" data-aos="fade-up" data-aos-delay="600">
            <div class="flex flex-col sm:flex-row gap-8 items-start">
                <div class="w-12 h-12 rounded-2xl bg-cyan-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-cyan-500/20">03</div>
                <div class="space-y-5 flex-1">
                    <h2 class="text-xl font-black text-cyan-400 uppercase tracking-wide">Trình báo Cơ quan Chức năng</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex items-center gap-6 p-5 rounded-[2rem] bg-white/[0.04] border border-white/5">
                            <div class="w-14 h-14 rounded-[1.25rem] bg-cyan-500/10 flex items-center justify-center text-cyan-400 text-2xl">
                                <i class="bi bi-megaphone-fill"></i>
                            </div>
                            <div>
                                <div class="text-lg font-black text-white">GỌI 113</div>
                                <p class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mt-1">Phòng Cảnh sát Hình sự — 24/7</p>
                            </div>
                        </div>
                        <a href="https://canhbao.ncsc.gov.vn" target="_blank" class="flex items-center gap-6 p-5 rounded-[2rem] bg-white/[0.04] border border-white/5 hover:bg-white/10 transition-all group">
                            <div class="w-14 h-14 rounded-[1.25rem] bg-cyan-500/10 flex items-center justify-center text-cyan-400 text-2xl group-hover:scale-110 transition-transform">
                                <i class="bi bi-globe"></i>
                            </div>
                            <div>
                                <div class="text-lg font-black text-white">canhbao.ncsc.gov.vn</div>
                                <p class="text-[10px] font-black text-cyan-400/60 uppercase tracking-[0.2em] mt-1">Cổng phản ánh lừa đảo quốc gia <i class="bi bi-arrow-right ml-1"></i></p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: EVIDENCE -->
        <div class="liquid-card p-8 border-l-8 border-green-500 bg-green-500/[0.02] hover:bg-green-500/[0.04] transition-all" data-aos="fade-up" data-aos-delay="700">
            <div class="flex flex-col sm:flex-row gap-8 items-start">
                <div class="w-12 h-12 rounded-2xl bg-green-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-green-500/20">04</div>
                <div class="space-y-4 flex-1">
                    <h2 class="text-xl font-black text-green-400 uppercase tracking-wide">Lưu bằng chứng & Bảo mật lại</h2>
                    <div class="space-y-3">
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-camera-fill text-green-500 text-xl"></i>
                            <div class="text-xs font-black text-white/70 uppercase tracking-widest">Chụp màn hình tin nhắn & giao dịch</div>
                        </div>
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-key-fill text-green-500 text-xl"></i>
                            <div class="text-xs font-black text-white/70 uppercase tracking-widest">Đổi mật khẩu tài khoản bị rò rỉ</div>
                        </div>
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/[0.03] border border-white/5">
                            <i class="bi bi-shield-lock-fill text-green-500 text-xl"></i>
                            <div class="text-xs font-black text-white/70 uppercase tracking-widest">Kích hoạt xác thực 2 lớp (2FA)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: SHIELDCALL -->
        <div class="liquid-card p-8 border-l-8 border-purple-500 bg-purple-500/[0.02] hover:bg-purple-500/[0.04] transition-all" data-aos="fade-up" data-aos-delay="800">
            <div class="flex flex-col sm:flex-row gap-8 items-start">
                <div class="w-12 h-12 rounded-2xl bg-purple-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-purple-500/20">05</div>
                <div class="space-y-5 flex-1">
                    <div class="space-y-1">
                        <h2 class="text-xl font-black text-purple-400 uppercase tracking-wide">Báo cáo trên ShieldCall VN</h2>
                        <p class="text-xs font-bold text-white/40 uppercase tracking-widest">Chia sẻ trải nghiệm để bảo vệ người khác khỏi kịch bản tương tự</p>
                    </div>
                    <a href="/report/" class="liquid-btn inline-flex py-4 px-10 bg-red-500 text-black font-black uppercase text-xs tracking-widest shadow-xl shadow-red-500/20 hover:bg-red-400 transition-all">
                        <i class="bi bi-flag-fill mr-2"></i> Gửi Báo Cáo Ngay
                    </a>
                </div>
            </div>
        </div>

        <!-- Step 6: AI EMERGENCY CHAT -->
        <div class="liquid-card p-0 border-l-8 border-cyan-500 bg-cyan-500/[0.02] overflow-hidden" data-aos="fade-up" data-aos-delay="900">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row gap-8 items-start p-8 pb-0">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-500 text-black flex items-center justify-center font-black text-lg shrink-0 shadow-lg shadow-cyan-500/20">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="space-y-2 flex-1">
                    <h2 class="text-xl font-black text-cyan-400 uppercase tracking-wide">Trò chuyện với AI hỗ trợ</h2>
                    <p class="text-xs font-bold text-white/40 uppercase tracking-widest">Mô tả tình huống để nhận hướng dẫn xử lý chi tiết từ ShieldCall AI</p>
                </div>
            </div>

            <!-- Quick Prompts -->
            <div class="flex flex-wrap gap-2 px-8 pt-5 pb-3">
                <button @click="sendQuick('Tôi vừa bị lừa chuyển tiền qua mạng, tôi cần làm gì ngay bây giờ?')"
                    class="px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all">
                    <i class="bi bi-cash-coin mr-1"></i> Bị lừa chuyển tiền
                </button>
                <button @click="sendQuick('Tôi đã cung cấp thông tin cá nhân và OTP cho kẻ lạ, làm sao để bảo vệ tài khoản?')"
                    class="px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500/20 transition-all">
                    <i class="bi bi-person-exclamation mr-1"></i> Lộ thông tin cá nhân
                </button>
                <button @click="sendQuick('Tôi nhận được cuộc gọi từ người tự xưng là công an/ngân hàng yêu cầu chuyển tiền, đây có phải lừa đảo không?')"
                    class="px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 hover:bg-cyan-500/20 transition-all">
                    <i class="bi bi-telephone-x mr-1"></i> Cuộc gọi giả mạo
                </button>
                <button @click="sendQuick('Tài khoản ngân hàng/mạng xã hội của tôi bị hack, tôi phải làm gì?')"
                    class="px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest bg-purple-500/10 text-purple-400 border border-purple-500/20 hover:bg-purple-500/20 transition-all">
                    <i class="bi bi-shield-exclamation mr-1"></i> Bị hack tài khoản
                </button>
            </div>

            <!-- Chat Messages Area -->
            <div x-ref="emergencyChatMessages" class="h-[380px] overflow-y-auto px-8 py-4 space-y-4 scroll-smooth bg-black/10">
                <!-- Welcome message -->
                <template x-if="messages.length === 1 && !messages[0].fromUser">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center shrink-0 shadow-md">
                            <i class="bi bi-robot text-black text-sm"></i>
                        </div>
                        <div class="flex-1 bg-white/5 border border-white/10 rounded-2xl rounded-bl-none p-4">
                            <div class="text-xs sm:text-[13px] leading-relaxed text-white/80 ai-markdown" x-html="messages[0].html"></div>
                        </div>
                    </div>
                </template>

                <template x-for="(msg, i) in messages" :key="i">
                    <div x-show="i > 0 || messages.length > 1 || msg.fromUser" class="flex" :class="msg.fromUser ? 'justify-end' : 'justify-start'">
                        <!-- Bot message -->
                        <div x-show="!msg.fromUser" class="flex items-start gap-3 max-w-[90%]">
                            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center shrink-0 shadow-md">
                                <i class="bi bi-robot text-black text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <!-- Thinking block -->
                                <div x-show="msg.isThinking || msg.thinkingContent" class="mb-2 p-3 rounded-xl bg-cyan-500/5 border border-cyan-500/10">
                                    <div class="flex items-center gap-2 cursor-pointer" @click="msg.thinkingCollapsed = !msg.thinkingCollapsed">
                                        <i class="bi text-[10px]" :class="msg.isThinking ? 'bi-lightning-charge-fill animate-pulse text-cyan-400' : (msg.thinkingCollapsed ? 'bi-chevron-right text-white/40' : 'bi-chevron-down text-white/40')"></i>
                                        <span class="text-[9px] font-black uppercase tracking-widest" :class="msg.isThinking ? 'text-cyan-400' : 'text-white/40'" x-text="msg.isThinking ? 'Đang suy luận...' : 'Quá trình suy luận'"></span>
                                    </div>
                                    <div x-show="!msg.thinkingCollapsed" x-transition class="mt-2 text-[11px] text-white/30 leading-relaxed whitespace-pre-wrap" x-text="msg.thinkingContent"></div>
                                </div>
                                <!-- Status -->
                                <div x-show="msg.status" class="mb-1">
                                    <span class="text-[9px] font-black uppercase tracking-widest text-cyan-400 animate-pulse" x-text="msg.status"></span>
                                </div>
                                <!-- Content -->
                                <div class="bg-white/5 border border-white/10 rounded-2xl rounded-bl-none p-4">
                                    <div class="text-xs sm:text-[13px] leading-relaxed text-white/80 ai-markdown" :class="{'inline': msg.streaming}" x-html="msg.html || msg.text"></div>
                                    <span x-show="msg.streaming" class="streaming-cursor"></span>
                                </div>
                                <div class="text-[9px] text-white/20 mt-1 font-bold" x-text="msg.time"></div>
                            </div>
                        </div>
                        <!-- User message -->
                        <div x-show="msg.fromUser" class="max-w-[80%]">
                            <div class="bg-gradient-to-br from-cyan-500/20 to-purple-500/20 border border-cyan-500/20 rounded-2xl rounded-br-none p-4">
                                <div class="text-xs sm:text-[13px] leading-relaxed text-white/90" x-text="msg.text"></div>
                            </div>
                            <div class="text-[9px] text-white/20 mt-1 font-bold text-right" x-text="msg.time"></div>
                        </div>
                    </div>
                </template>

                <!-- Typing indicator -->
                <div x-show="typing" class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center shrink-0">
                        <i class="bi bi-robot text-black text-sm"></i>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-2xl rounded-bl-none px-5 py-3">
                        <div class="flex gap-1.5">
                            <span class="w-2 h-2 rounded-full bg-cyan-400/60 animate-bounce" style="animation-delay:0ms"></span>
                            <span class="w-2 h-2 rounded-full bg-cyan-400/60 animate-bounce" style="animation-delay:150ms"></span>
                            <span class="w-2 h-2 rounded-full bg-cyan-400/60 animate-bounce" style="animation-delay:300ms"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-white/5 bg-black/20">
                <form @submit.prevent="send()" class="flex items-center gap-3">
                    <input type="text" x-model="input" :disabled="typing"
                        placeholder="Mô tả tình huống khẩn cấp của bạn..."
                        class="flex-1 px-5 py-3.5 text-sm font-medium bg-white/[0.03] border border-white/10 rounded-2xl focus:border-cyan-500/40 focus:bg-white/[0.05] transition-all placeholder:text-white/20 disabled:opacity-50">
                    <button type="submit" :disabled="typing || (!input.trim())"
                        class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-black font-bold shadow-lg shadow-cyan-500/20 hover:scale-105 transition-all disabled:opacity-30 disabled:hover:scale-100 shrink-0">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function emergencyChat() {
    return {
        input: '',
        typing: false,
        sessionId: null,
        messages: [
            {
                fromUser: false,
                text: '',
                html: '',
                time: new Date().toLocaleTimeString('vi', { hour: '2-digit', minute: '2-digit' }),
                status: '',
                isThinking: false,
                thinkingContent: '',
                thinkingCollapsed: false,
                streaming: false
            }
        ],
        init() {
            const welcome = '**Xin chào!** Tôi là ShieldCall AI — trợ lý khẩn cấp của bạn.\n\nHãy mô tả tình huống bạn đang gặp phải, hoặc chọn một trong các nút phía trên để được hướng dẫn xử lý ngay. Tôi luôn sẵn sàng hỗ trợ bạn 24/7.';
            this.messages[0].text = welcome;
            if (window.renderMd) {
                this.messages[0].html = window.renderMd(welcome);
            } else {
                this.messages[0].html = welcome;
            }
            this.sessionId = 'emergency-' + (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : Math.random().toString(36).substring(2));
        },
        now() { return new Date().toLocaleTimeString('vi', { hour: '2-digit', minute: '2-digit' }); },
        scrollDown() {
            this.$nextTick(() => {
                const el = this.$refs.emergencyChatMessages;
                if (el) el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
            });
        },
        sendQuick(text) {
            this.input = text;
            this.send();
        },
        async send() {
            const text = this.input.trim();
            if (!text || this.typing) return;

            this.messages.push({
                fromUser: true,
                text: text,
                html: text,
                time: this.now()
            });
            this.input = '';
            this.scrollDown();
            this.typing = true;

            const botMsg = {
                fromUser: false,
                text: '',
                html: '',
                time: this.now(),
                status: '',
                isThinking: false,
                thinkingContent: '',
                thinkingCollapsed: false,
                streaming: true
            };
            this.messages.push(botMsg);
            this.scrollDown();

            try {
                const payload = {
                    user_message: text,
                    session_id: this.sessionId,
                    context: 'chat',
                    scan_context: 'EMERGENCY MODE: Người dùng đang ở trang Hỗ trợ khẩn cấp. Họ có thể đang là nạn nhân của lừa đảo. Hãy trả lời bằng tiếng Việt, ngắn gọn, rõ ràng, và đưa ra các bước hành động cụ thể. Ưu tiên an toàn tài chính và bảo mật thông tin cá nhân.'
                };
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
                    || document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('csrftoken='))?.split('=')[1]
                    || '';
                const response = await fetch('/api/v1/chat/stream/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(payload),
                    cache: 'no-store'
                });

                if (!response.ok) {
                    botMsg.text = 'Lỗi kết nối (HTTP ' + response.status + '). Vui lòng thử lại.';
                    botMsg.html = botMsg.text;
                    botMsg.streaming = false;
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                const lastIdx = this.messages.length - 1;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || !trimmed.startsWith('data: ')) continue;
                        try {
                            const data = JSON.parse(trimmed.substring(6));

                            if (data.session_id) this.sessionId = data.session_id;

                            if (data.status) {
                                const statusMap = {
                                    'searching_knowledge': 'Đang tra cứu kiến thức...',
                                    'searching_web': 'Đang tìm kiếm thông tin...',
                                    'checking_safety': 'Đang kiểm tra an toàn...',
                                    'reasoning': 'Đang suy luận...',
                                    'thinking': 'Đang suy luận...'
                                };
                                this.messages[lastIdx].status = statusMap[data.status] || data.status;
                                if (data.status === 'thinking' || data.status === 'reasoning') {
                                    this.messages[lastIdx].isThinking = true;
                                }
                            }

                            if (data.chunk) {
                                const chunk = data.chunk;
                                if (chunk.startsWith('__STATUS__:')) {
                                    const sv = chunk.substring(11);
                                    const sm = { 'searching_knowledge': 'Đang tra cứu...', 'searching_web': 'Đang tìm kiếm...', 'thinking': 'Đang suy luận...', 'reasoning': 'Đang suy luận...' };
                                    this.messages[lastIdx].status = sm[sv] || sv;
                                } else if (chunk.startsWith('__THINK__:')) {
                                    this.messages[lastIdx].isThinking = true;
                                    this.messages[lastIdx].thinkingContent += chunk.substring(10);
                                } else if (chunk.startsWith('__SEARCH_RESULTS__:') || chunk.startsWith('__METADATA__:')) {
                                    // skip metadata display in emergency chat
                                } else if (!chunk.startsWith('__')) {
                                    this.messages[lastIdx].text += chunk;
                                    if (window.renderMd) {
                                        this.messages[lastIdx].html = window.renderMd(this.messages[lastIdx].text);
                                    }
                                }
                            }

                            if (data.done) {
                                this.messages[lastIdx].status = '';
                                this.messages[lastIdx].isThinking = false;
                                this.messages[lastIdx].thinkingCollapsed = true;
                                this.messages[lastIdx].streaming = false;
                            }
                            this.scrollDown();
                        } catch (e) { /* parse error */ }
                    }
                }
            } catch (err) {
                botMsg.text = 'Lỗi kết nối mạng. Vui lòng kiểm tra Internet và thử lại.';
                botMsg.html = botMsg.text;
            } finally {
                const lastIdx = this.messages.length - 1;
                if (this.messages[lastIdx] && !this.messages[lastIdx].fromUser) {
                    this.messages[lastIdx].status = '';
                    this.messages[lastIdx].streaming = false;
                }
                this.typing = false;
                this.scrollDown();
            }
        }
    };
}
</script>
{% endblock %}