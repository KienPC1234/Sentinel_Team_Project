{% extends "base.html" %}
{% block title %}Tra cứu hệ thống — ShieldCall VN{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 space-y-8 animate-fadein" x-data="scanLookup()">

    <!-- Header -->
    <div class="text-center space-y-4" data-aos="fade-up">
        <div class="relative inline-block" data-aos="zoom-in" data-aos-delay="100">
            <div class="absolute inset-0 bg-cyan-500 blur-3xl opacity-20 rounded-full scale-150"></div>
            <div class="relative inline-flex items-center justify-center w-20 h-20 rounded-[2rem] bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 shadow-lg shadow-cyan-500/10">
                <i class="bi bi-search-heart text-4xl"></i>
            </div>
        </div>
        <h1 class="text-4xl font-black text-white tracking-tight leading-none" data-aos="fade-up" data-aos-delay="200">
            Tra cứu <span class="glow-text text-cyan-400">Hệ thống</span>
        </h1>
        <p class="text-white/40 max-w-lg mx-auto text-sm leading-relaxed" data-aos="fade-up" data-aos-delay="300">
            Nhập số tài khoản, số điện thoại, URL website, email — tìm kiếm trong toàn bộ lịch sử quét và báo cáo cộng đồng.
        </p>
    </div>

    <!-- Search Bar -->
    <div class="liquid-card p-4 sm:p-6" data-aos="fade-up" data-aos-delay="400">
        <form @submit.prevent="doSearch()" class="flex flex-col sm:flex-row gap-3">
            <div class="flex-1 relative">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-white/20 pointer-events-none">
                    <i class="bi bi-search"></i>
                </div>
                <input type="text" x-model="query" placeholder="Nhập STK, SĐT, URL, email, từ khoá..." 
                       class="w-full bg-white/[0.03] border border-white/10 text-white text-sm font-bold rounded-2xl pl-11 pr-4 py-4 focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/20 transition-all placeholder:text-white/20"
                       @keyup.enter="doSearch()">
            </div>
            <button type="submit" class="px-8 py-4 rounded-2xl bg-cyan-500 hover:bg-cyan-400 text-black font-black text-xs uppercase tracking-widest transition-all hover:scale-[1.02] shadow-lg shadow-cyan-500/25 shrink-0"
                    :disabled="searching">
                <span x-show="!searching"><i class="bi bi-search mr-2"></i>TRA CỨU</span>
                <span x-show="searching" class="spinner w-4 h-4 border-black inline-block"></span>
            </button>
        </form>

        <!-- Filters -->
        <div class="mt-4 flex flex-col sm:flex-row gap-4">
            <!-- Type Filter -->
            <div class="flex flex-wrap gap-1.5 p-1.5 bg-white/[0.03] border border-white/5 rounded-2xl">
                <template x-for="t in typeOptions" :key="t.value">
                    <button @click="typeFilter = t.value; doSearch()" 
                            class="px-3.5 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                            :class="typeFilter === t.value ? 'bg-white/10 text-white' : 'text-white/30 hover:text-white/50'" 
                            x-text="t.label"></button>
                </template>
            </div>
            <!-- Risk Filter -->
            <div class="flex flex-wrap gap-1.5 p-1.5 bg-white/[0.03] border border-white/5 rounded-2xl ml-auto">
                <button @click="riskFilter = 'all'; doSearch()" class="px-3.5 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        :class="riskFilter === 'all' ? 'bg-white/10 text-white' : 'text-white/30 hover:text-white/50'">Tất cả</button>
                <button @click="riskFilter = 'high'; doSearch()" class="px-3.5 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        :class="riskFilter === 'high' ? 'bg-red-500/20 text-red-400' : 'text-white/30 hover:text-white/50'">Nguy hiểm</button>
                <button @click="riskFilter = 'medium'; doSearch()" class="px-3.5 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        :class="riskFilter === 'medium' ? 'bg-yellow-500/20 text-yellow-400' : 'text-white/30 hover:text-white/50'">Cảnh báo</button>
                <button @click="riskFilter = 'low'; doSearch()" class="px-3.5 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                        :class="riskFilter === 'low' ? 'bg-green-500/20 text-green-400' : 'text-white/30 hover:text-white/50'">An toàn</button>
            </div>
        </div>
    </div>

    <!-- Results Count -->
    <div x-show="searched && !searching" class="flex items-center justify-between px-1" x-cloak>
        <p class="text-white/30 text-xs font-bold">
            <span x-text="total"></span> kết quả
            <span x-show="query" class="text-white/15">cho "<span class="text-cyan-400/60" x-text="query"></span>"</span>
        </p>
        <a href="/scam-radar/" class="text-white/20 text-xs font-bold hover:text-cyan-400/60 transition-colors flex items-center gap-1.5">
            <i class="bi bi-broadcast"></i> Quay lại Radar
        </a>
    </div>

    <!-- Loading -->
    <div x-show="searching" class="text-center py-16" x-cloak>
        <div class="spinner w-10 h-10 mx-auto text-cyan-400 mb-4"></div>
        <p class="text-white/30 text-xs font-black uppercase tracking-widest">Đang tìm kiếm...</p>
    </div>

    <!-- Results Grid -->
    <div x-show="searched && !searching && results.length > 0" class="space-y-3" x-cloak>
        <template x-for="item in results" :key="item.kind + '-' + item.id">
            <a :href="item.url" class="block liquid-card p-0 overflow-hidden hover:bg-white/[0.03] transition-all group">
                <div class="flex items-stretch">
                    <!-- Risk Indicator Bar -->
                    <div class="w-1.5 shrink-0"
                         :class="item.risk_level === 'RED' ? 'bg-red-500' : item.risk_level === 'YELLOW' ? 'bg-yellow-400' : 'bg-green-400'"></div>
                    
                    <div class="flex-1 p-5 flex items-center gap-5 min-w-0">
                        <!-- Type Icon -->
                        <div class="w-11 h-11 rounded-xl flex items-center justify-center shrink-0 border"
                             :class="{
                                 'bg-cyan-500/10 text-cyan-400 border-cyan-500/20': item.type === 'phone',
                                 'bg-blue-500/10 text-blue-400 border-blue-500/20': item.type === 'domain',
                                 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20': item.type === 'account',
                                 'bg-purple-500/10 text-purple-400 border-purple-500/20': item.type === 'email',
                                 'bg-green-500/10 text-green-400 border-green-500/20': item.type === 'message',
                                 'bg-violet-500/10 text-violet-400 border-violet-500/20': item.type === 'audio',
                                 'bg-orange-500/10 text-orange-400 border-orange-500/20': item.type === 'file' || item.type === 'qr',
                             }">
                            <i :class="{
                                'bi bi-telephone': item.type === 'phone',
                                'bi bi-globe2': item.type === 'domain',
                                'bi bi-bank2': item.type === 'account',
                                'bi bi-envelope': item.type === 'email',
                                'bi bi-chat-left-text': item.type === 'message',
                                'bi bi-soundwave': item.type === 'audio',
                                'bi bi-file-earmark': item.type === 'file' || item.type === 'qr',
                            }"></i>
                        </div>

                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-black text-white/90 truncate group-hover:text-cyan-400 transition-colors" x-text="item.target"></span>
                                <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-widest shrink-0"
                                      :class="item.kind === 'scan' ? 'bg-cyan-500/10 text-cyan-400/70 border border-cyan-500/10' : 'bg-yellow-500/10 text-yellow-400/70 border border-yellow-500/10'"
                                      x-text="item.kind === 'scan' ? 'AI SCAN' : 'BÁO CÁO'"></span>
                            </div>
                            <div class="flex items-center gap-3 text-[10px] text-white/30 font-bold">
                                <span x-text="item.type_display"></span>
                                <span>&middot;</span>
                                <span x-text="item.time_ago"></span>
                                <template x-if="item.scam_type">
                                    <span class="text-white/15" x-text="'· ' + item.scam_type"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Score + Arrow -->
                        <div class="flex items-center gap-4 shrink-0">
                            <div class="text-right">
                                <div class="text-lg font-black leading-none"
                                     :class="item.risk_level === 'RED' ? 'text-red-400' : item.risk_level === 'YELLOW' ? 'text-yellow-400' : 'text-green-400'"
                                     x-text="item.risk_score"></div>
                                <div class="text-[8px] font-black uppercase tracking-widest mt-0.5"
                                     :class="item.risk_level === 'RED' ? 'text-red-400/50' : item.risk_level === 'YELLOW' ? 'text-yellow-400/50' : 'text-green-400/50'"
                                     x-text="item.risk_display"></div>
                            </div>
                            <i class="bi bi-chevron-right text-white/10 group-hover:text-cyan-400/40 transition-colors"></i>
                        </div>
                    </div>
                </div>
            </a>
        </template>

        <!-- Load More -->
        <div x-show="hasNext" class="text-center pt-4">
            <button @click="loadMore()" class="px-8 py-3 rounded-2xl bg-white/5 border border-white/10 text-white/40 text-xs font-black uppercase tracking-widest hover:bg-white/10 hover:text-white/60 transition-all"
                    :disabled="loadingMore">
                <span x-show="!loadingMore">Tải thêm</span>
                <span x-show="loadingMore" class="spinner w-4 h-4 inline-block"></span>
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div x-show="searched && !searching && results.length === 0" class="text-center py-20 space-y-4" x-cloak>
        <div class="w-20 h-20 rounded-[2rem] bg-white/[0.02] border border-white/5 flex items-center justify-center mx-auto text-white/10">
            <i class="bi bi-inbox text-4xl"></i>
        </div>
        <h3 class="text-white/30 text-sm font-black">Không tìm thấy kết quả</h3>
        <p class="text-white/15 text-xs">Thử từ khoá khác hoặc thay đổi bộ lọc</p>
    </div>

    <!-- Initial State (before first search) -->
    <div x-show="!searched && !searching" class="space-y-6 pt-4" data-aos="fade-up" data-aos-delay="500">
        <h3 class="text-[10px] font-black text-white/20 uppercase tracking-[0.2em] text-center">Hoặc chọn nhanh</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <a href="/scan/phone/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 border border-cyan-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-telephone text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Số điện thoại</div>
            </a>
            <a href="/scan/bank/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-yellow-500/10 flex items-center justify-center text-yellow-400 border border-yellow-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-bank2 text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Tài khoản NH</div>
            </a>
            <a href="/scan/website/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-globe2 text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Website/URL</div>
            </a>
            <a href="/scan/email/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-envelope text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Email</div>
            </a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <a href="/scan/message/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400 border border-green-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-chat-left-text text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Tin nhắn</div>
            </a>
            <a href="/scan/audio/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center text-violet-400 border border-violet-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-soundwave text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Âm thanh</div>
            </a>
            <a href="/scan/file/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400 border border-orange-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-file-earmark-zip text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">Tệp tin</div>
            </a>
            <a href="/scan/qr/" class="liquid-card p-5 text-center hover:bg-white/[0.04] transition-all group">
                <div class="w-12 h-12 rounded-xl bg-rose-500/10 flex items-center justify-center text-rose-400 border border-rose-500/20 mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="bi bi-qr-code text-xl"></i>
                </div>
                <div class="text-xs font-black text-white/70 group-hover:text-white transition-colors">QR / Ảnh</div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function scanLookup() {
    return {
        query: new URLSearchParams(window.location.search).get('q') || '',
        typeFilter: new URLSearchParams(window.location.search).get('type') || 'all',
        riskFilter: new URLSearchParams(window.location.search).get('risk') || 'all',
        searching: false,
        searched: false,
        results: [],
        total: 0,
        page: 1,
        hasNext: false,
        loadingMore: false,

        typeOptions: [
            { value: 'all', label: 'Tất cả' },
            { value: 'phone', label: 'SĐT' },
            { value: 'account', label: 'Ngân hàng' },
            { value: 'domain', label: 'Website' },
            { value: 'email', label: 'Email' },
            { value: 'message', label: 'Tin nhắn' },
            { value: 'audio', label: 'Âm thanh' },
            { value: 'file', label: 'Tệp tin' },
        ],

        init() {
            // Auto-search if query param present
            if (this.query) {
                this.doSearch();
            }
        },

        async doSearch() {
            this.page = 1;
            this.results = [];
            this.searching = true;
            this.searched = true;

            // Update URL without reload
            const params = new URLSearchParams();
            if (this.query) params.set('q', this.query);
            if (this.typeFilter !== 'all') params.set('type', this.typeFilter);
            if (this.riskFilter !== 'all') params.set('risk', this.riskFilter);
            const qs = params.toString();
            history.replaceState(null, '', qs ? '?' + qs : window.location.pathname);

            await this.fetchResults();
            this.searching = false;
        },

        async loadMore() {
            this.loadingMore = true;
            this.page++;
            await this.fetchResults(true);
            this.loadingMore = false;
        },

        async fetchResults(append = false) {
            try {
                const params = new URLSearchParams({
                    q: this.query,
                    type: this.typeFilter,
                    risk: this.riskFilter,
                    page: this.page,
                });
                const res = await fetch('/api/v1/scan/lookup/?' + params.toString());
                const data = await res.json();
                if (data && !data.error) {
                    if (append) {
                        this.results = this.results.concat(data.results || []);
                    } else {
                        this.results = data.results || [];
                    }
                    this.total = data.total || 0;
                    this.hasNext = data.has_next || false;
                }
            } catch (e) {
                console.error('Lookup fetch error:', e);
                showToast('Lỗi kết nối hệ thống.', 'error');
            }
        },
    };
}
</script>
{% endblock %}
