{% extends "base.html" %}
{% block title %}Kiểm tra Tin nhắn{% endblock %}
{% block head_extra %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 lg:grid lg:grid-cols-[1fr_340px] lg:gap-8 lg:items-start">
<div class="animate-fadein space-y-10" 
     x-data="{
    message:'', 
    files:[], 
    loading:false, 
    result:null, 
    error:'', 
    aiText:'', 
    aiLoading:false, 
    previewImage:null,
    isDragging: false,
    scanId: null,
    ws: null,
    wsConnected: false,
    wsState: 'idle',
    reconnectAttempts: 0,
    maxReconnectAttempts: 6,
    reconnectTimer: null,
    statusPollTimer: null,
    progress: [],

    removeFile(index) {
        this.files.splice(index, 1);
        if (this.$refs.imgInput) {
            const dt = new DataTransfer();
            this.files.forEach(file => dt.items.add(file));
            this.$refs.imgInput.files = dt.files;
        }
    },

    addFiles(newFiles) {
        const uniqueFiles = Array.from(newFiles).filter(newFile => 
            !this.files.some(existingFile => existingFile.name === newFile.name && existingFile.size === newFile.size)
        );
        this.files.push(...uniqueFiles);
        if (this.$refs.imgInput) {
            const dt = new DataTransfer();
            this.files.forEach(file => dt.items.add(file));
            this.$refs.imgInput.files = dt.files;
        }
    },

    clearFiles() {
        this.files = [];
        if (this.$refs.imgInput) {
            this.$refs.imgInput.value = null;
        }
    },

    handleDrop(e) {
        this.isDragging = false;
        if (e.dataTransfer.files.length) {
            this.addFiles(e.dataTransfer.files);
        }
    },

    handlePaste(e) {
        if (e.clipboardData && e.clipboardData.items) {
            const items = e.clipboardData.items;
            const imageFiles = [];
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    imageFiles.push(items[i].getAsFile());
                }
            }
            if (imageFiles.length) {
                e.preventDefault();
                this.addFiles(imageFiles);
            }
        }
    },

    async pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim()) {
                this.message = this.message ? (this.message + '\n' + text) : text;
                showToast('Đã dán nội dung từ clipboard!', 'success');
            } else {
                showToast('Clipboard trống hoặc không có văn bản.', 'warning');
            }
        } catch (err) {
            showToast('Không thể truy cập clipboard. Vui lòng dán bằng Ctrl+V.', 'warning');
        }
    },

    stopReconnect() {
        if (this.reconnectTimer) { clearTimeout(this.reconnectTimer); this.reconnectTimer = null; }
    },
    stopStatusPolling() {
        if (this.statusPollTimer) { clearInterval(this.statusPollTimer); this.statusPollTimer = null; }
    },
    startStatusPolling() {
        if (!this.scanId || this.statusPollTimer) return;
        this.statusPollTimer = setInterval(() => this.fetchScanStatus(), 4000);
    },
    fetchScanStatus() {
        if (!this.scanId || !this.loading) return;
        fetch(`/api/v1/scan/status/${this.scanId}/`, { method: 'GET', headers: { 'X-CSRFToken': getCSRFToken() } })
        .then(r => { if (!r.ok) return null; return r.json(); })
        .then(data => {
            if (!data) return;
            if (data.status === 'completed' && data.result) {
                this.result = data.result;
                this.loading = false;
                this.wsState = 'completed';
                this.stopStatusPolling();
                this.stopReconnect();
                if (this.ws) this.ws.close();
            } else if (data.status === 'failed') {
                this.loading = false;
                this.wsState = 'failed';
                this.stopStatusPolling();
                showToast('Phân tích thất bại.', 'error');
            }
        }).catch(() => {});
    },
    scheduleReconnect() {
        if (!this.scanId || !this.loading) return;
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            this.wsState = 'disconnected';
            this.progress.push({ message: 'Mất kết nối WS. Chuyển sang chế độ polling.', step: 'warning' });
            this.startStatusPolling();
            return;
        }
        this.reconnectAttempts += 1;
        this.wsState = 'reconnecting';
        const delay = Math.min(10000, 1000 * Math.pow(2, this.reconnectAttempts - 1));
        this.stopReconnect();
        this.reconnectTimer = setTimeout(() => this.connectWebSocket(this.scanId, true), delay);
    },
    connectWebSocket(scanId, isReconnect = false) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/scan/${scanId}/`;
        this.scanId = scanId;
        this.wsState = isReconnect ? 'reconnecting' : 'connecting';
        if (!isReconnect) this.progress.push({ message: 'Đang kết nối với máy chủ...', step: 'init' });
        this.ws = new WebSocket(wsUrl);
        this.ws.onopen = () => {
            this.wsConnected = true; this.wsState = 'connected';
            this.reconnectAttempts = 0; this.stopReconnect();
            if (isReconnect) this.progress.push({ message: 'Đã kết nối lại.', step: 'reconnected' });
            // Ask server for current status to catch results missed during disconnection
            this.ws.send(JSON.stringify({ type: 'get_status' }));
        };
        this.ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.step !== 'ping') {
                this.stopStatusPolling();
                this.progress.push({ message: data.message, step: data.step });
                this.$nextTick(() => {
                    if (this.$refs.msgProgressLog) this.$refs.msgProgressLog.scrollTop = this.$refs.msgProgressLog.scrollHeight;
                });
            }
            if (data.step === 'completed' && data.data) {
                this.result = data.data;
                this.loading = false;
                this.wsState = 'completed';
                this.stopReconnect(); this.stopStatusPolling();
                this.ws.close();
            }
            if (data.step === 'error') {
                showToast(data.message, 'error');
                this.loading = false; this.wsState = 'failed';
                this.stopReconnect(); this.stopStatusPolling();
                this.ws.close();
            }
        };
        this.ws.onerror = () => { this.wsConnected = false; };
        this.ws.onclose = () => {
            this.wsConnected = false;
            if (this.loading) { this.scheduleReconnect(); this.startStatusPolling(); }
        };
    },

    submitScan() {
        if (!this.message.trim() && !this.files.length) { showToast('Vui lòng nhập tin nhắn hoặc tải ảnh', 'warning'); return; }
        var tsToken = document.querySelector('[name=cf-turnstile-response]').value;
        if (!tsToken) { showToast('Vui lòng hoàn thành xác minh anti-spam', 'warning'); return; }
        if (window.turnstile) { try { window.turnstile.reset(); } catch(e) {} }
        this.loading = true; this.result = null; this.aiText = ''; this.aiLoading = false;
        this.progress = []; this.wsState = 'idle'; this.scanId = null;
        var fd = new FormData();
        if (this.message.trim()) fd.append('message', this.message.trim());
        fd.append('cf-turnstile-response', tsToken);
        var imageFiles = this.files;
        for (var i = 0; i < imageFiles.length; i++) {
            fd.append('image', imageFiles[i]);
        }
        var self = this;
        fetch('/api/v1/scan/message/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: fd
        })
        .then(function(r) { if (!r.ok) return r.json().then(function(e) { throw e }).catch(function() { throw {error: 'Lỗi server (' + r.status + ')'}; }); return r.json(); })
        .then(function(data) {
            if (data.scan_id) {
                self.scanId = data.scan_id;
                self.connectWebSocket(data.scan_id);
                self.startStatusPolling();
            } else if (data.risk_score !== undefined) {
                self.result = data; self.loading = false;
            }
        })
        .catch(function(e) { showToast(e.error || 'Có lỗi xảy ra.', 'error'); self.loading = false; });
    },

    init() {
    }
}"
     @dragover.prevent="isDragging = true"
     @dragleave.prevent="isDragging = false"
     @drop.prevent="handleDrop($event)"
     @paste.window="handlePaste($event)">
    <!-- Page Header -->
    <div class="text-center space-y-4" data-aos="fade-up">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-purple-500/10 text-purple-400 mb-2 border border-purple-500/20 shadow-lg shadow-purple-500/10" data-aos="zoom-in" data-aos-delay="100">
            <i class="bi bi-chat-left-dots text-4xl"></i>
        </div>
        <h1 class="text-4xl font-black text-white tracking-tight" data-aos="fade-up" data-aos-delay="200">
            Kiểm tra <span class="glow-text">Tin nhắn Scam</span>
        </h1>
        <p class="text-white/40 max-w-md mx-auto text-sm leading-relaxed" data-aos="fade-up" data-aos-delay="300">
            Phân tích ngữ nghĩa, nhận diện hành vi lừa đảo qua nội dung tin nhắn hoặc ảnh chụp màn hình.
        </p>
    </div>

    <!-- Multi-Mode Input Area -->
    <div class="liquid-card p-6 sm:p-8" data-aos="fade-up" data-aos-delay="400"
         :class="{ 'border-purple-500 border-dashed ring-4 ring-purple-500/20': isDragging }">
        <form @submit.prevent="submitScan()">
            <!-- Modal Xem Ảnh To -->
            <div x-show="previewImage" style="display: none;" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" @click="previewImage = null" @keydown.escape.window="previewImage = null">
                <img :src="previewImage" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-transform duration-300 transform scale-100" @click.stop>
                <button type="button" class="absolute top-6 right-6 text-white/50 hover:text-white bg-black/50 w-10 h-10 rounded-full flex items-center justify-center" @click="previewImage = null">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="relative">
                    <textarea class="liquid-input w-full min-h-[160px] p-6 text-lg font-medium leading-relaxed" 
                        placeholder="Dán nội dung tin nhắn nghi ngờ vào đây..." x-model="message"></textarea>
                    
                    <!-- Clipboard Paste Button -->
                    <button type="button" @click="pasteFromClipboard()" 
                        class="absolute top-3 right-3 flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-purple-500/10 text-purple-400 text-[10px] font-black uppercase tracking-wider border border-purple-500/20 hover:bg-purple-500/20 hover:text-purple-300 transition-all z-10"
                        title="Dán văn bản từ clipboard">
                        <i class="bi bi-clipboard-plus"></i> DÁN TỪ CLIPBOARD
                    </button>
                    
                    <!-- Floating Badge -->
                    <div class="absolute bottom-4 right-4 text-[10px] font-black text-white/20 uppercase tracking-widest pointer-events-none">
                        Text Content Analyzer
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <label class="liquid-btn flex-1 py-4 px-8 text-sm font-bold bg-white/5 border-white/10 hover:bg-white/10 cursor-pointer text-center group">
                        <span class="flex items-center justify-center gap-3">
                            <i class="bi bi-image text-xl group-hover:scale-110 transition-transform"></i>
                            <span x-text="isDragging ? 'THẢ ẢNH VÀO ĐÂY' : (files.length ? 'ĐÃ CHỌN ' + files.length + ' ẢNH' : 'HOẶC KÉO THẢ NHIỀU ẢNH CHỤP')"></span>
                        </span>
                        <input type="file" x-ref="imgInput" accept="image/*" class="hidden" multiple
                            @change="files = Array.from($event.target.files); $event.target.value = null;">
                    </label>
                    <template x-if="files.length > 0">
                        <button type="button" @click="clearFiles()" class="liquid-btn bg-red-500/10 text-red-400 px-6 py-4 font-black hover:bg-red-500/20">
                            <i class="bi bi-trash mr-2"></i> XÓA TẤT CẢ
                        </button>
                    </template>
                    <button type="submit" class="liquid-btn bg-purple-500 text-black px-12 py-4 font-black hover:bg-purple-400" :disabled="loading">
                        <span x-show="!loading"><i class="bi bi-cpu mr-2"></i> PHÂN TÍCH</span>
                        <span x-show="loading" class="spinner w-5 h-5 border-black"></span>
                    </button>
                </div>

                <!-- Scrollable Horizontal Gallery -->
                <div x-show="files && files.length > 0" 
                     class="mt-4 w-full overflow-x-auto pb-4 custom-scrollbar">
                    <div class="flex gap-3 min-w-min px-1">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="relative shrink-0 w-20 h-20 group cursor-pointer" @click="previewImage = URL.createObjectURL(file)">
                                <img :src="URL.createObjectURL(file)" class="w-full h-full object-cover rounded-xl border border-white/10 group-hover:border-purple-500/50 transition-colors shadow-lg shadow-black/50">
                                <div class="absolute top-0 right-0 p-2 z-10"> <!-- Increased padding and z-index -->
                                    <button type="button" @click.stop="removeFile(index)" class="bg-red-500/80 hover:bg-red-600/80 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs shadow-md">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                                    <i class="bi bi-zoom-in text-white text-xl"></i>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Turnstile Widget -->
                <div class="mt-4 flex justify-center">
                    <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITEKEY }}" :data-theme="document.documentElement.getAttribute('data-theme') || 'dark'"></div>
                </div>
            </div>
        </form>
    </div>

    <!-- Progress Console -->
    <template x-if="loading && progress.length > 0">
        <div class="liquid-card p-6 border-purple-500/20 bg-purple-500/[0.02]">
            <div class="mb-4 flex items-center justify-between gap-3">
                <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-widest">Tiến trình phân tích thời gian thực</h4>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-white/30 font-mono" x-text="progress.length + ' bước'"></span>
                    <div class="text-[10px] font-black uppercase tracking-wider px-2 py-1 rounded border"
                         :class="wsState==='connected' ? 'text-green-400 border-green-500/30 bg-green-500/10' : (wsState==='reconnecting' || wsState==='connecting') ? 'text-yellow-400 border-yellow-500/30 bg-yellow-500/10' : 'text-red-400 border-red-500/30 bg-red-500/10'"
                         x-text="wsState==='connected' ? 'WS' : (wsState==='reconnecting' ? '...' : (wsState==='connecting' ? '...' : 'Poll'))"></div>
                </div>
            </div>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mb-4">
                <div class="h-full bg-purple-500/50 transition-all duration-500 rounded-full" :style="'width:' + Math.min(95, progress.length * 12) + '%'"></div>
            </div>
            <div class="space-y-2.5 font-mono text-[11px] max-h-[250px] overflow-y-auto custom-scrollbar" x-ref="msgProgressLog">
                <template x-for="(item, index) in progress" :key="index">
                    <div class="flex items-start gap-3 animate-fadein">
                        <span class="flex-shrink-0 mt-0.5" :class="item.step === 'completed' ? 'text-green-500' : item.step?.includes('warning') ? 'text-yellow-500' : item.step === 'error' ? 'text-red-500' : item.step?.includes('ok') || item.step?.includes('done') ? 'text-green-400' : 'text-purple-500/50'">
                            <i :class="item.step === 'completed' ? 'bi bi-check-circle-fill' : item.step?.includes('warning') ? 'bi bi-exclamation-triangle-fill' : item.step === 'error' ? 'bi bi-x-circle-fill' : item.step?.includes('ok') || item.step?.includes('done') ? 'bi bi-check2' : (index === progress.length - 1 ? 'bi bi-arrow-right' : 'bi bi-dot')"></i>
                        </span>
                        <span class="text-white/80 flex-1" x-text="item.message"></span>
                        <i x-show="index === progress.length - 1 && item.step !== 'completed' && !item.step?.includes('ok') && !item.step?.includes('done')" class="bi bi-three-dots animate-pulse text-purple-400 flex-shrink-0"></i>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <!-- Result Display -->
    <template x-if="result">
        <div class="space-y-8 animate-fadein">
            <div class="liquid-card overflow-hidden">
                <!-- Status Header -->
                <div class="p-8 text-center border-b border-white/5 bg-white/[0.02] relative overflow-hidden">
                    <div class="absolute inset-0 opacity-10 -z-10 blur-[80px]"
                        :class="result.risk_level==='RED'?'bg-red-500':result.risk_level==='YELLOW'?'bg-yellow-500':'bg-green-500'"></div>
                    
                    <div class="inline-block px-8 py-3 rounded-full text-xs font-black tracking-[0.3em] uppercase mb-6"
                        :class="result.risk_level==='RED'?'bg-red-500/20 text-red-500 border border-red-500/30':result.risk_level==='YELLOW'?'bg-yellow-500/20 text-yellow-500 border border-yellow-500/30':'bg-green-500/20 text-green-500 border border-green-500/30'"
                        x-text="result.risk_level"></div>
                    
                    <div class="text-5xl font-black text-white mb-2" x-text="result.risk_score + '/100'"></div>
                    <div class="text-[10px] text-white/30 font-black tracking-widest uppercase mb-8">Chỉ số nghi vấn tin nhắn</div>
                </div>

                <!-- Patterns & Details -->
                <div class="p-8 space-y-8">
                    <template x-if="result.patterns_found && result.patterns_found.length">
                        <div class="space-y-3">
                            <h4 class="text-xs font-black text-white/40 uppercase tracking-widest">Dấu hiệu phát hiện</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="p in result.patterns_found" :key="JSON.stringify(p)">
                                    <span class="px-4 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-bold" x-text="typeof p === 'object' ? (p.label || p.pattern || JSON.stringify(p)) : p"></span>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="(result.annotated_images && result.annotated_images.length > 0) || result.annotated_image">
                        <div class="space-y-4">
                            <h4 class="text-xs font-black text-white/40 uppercase tracking-widest">Phân tích vùng text từ ảnh</h4>
                            <div class="grid gap-4" :class="(result.annotated_images && result.annotated_images.length > 1) ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'">
                                <template x-if="result.annotated_images && result.annotated_images.length > 0">
                                    <template x-for="(img, idx) in result.annotated_images" :key="idx">
                                        <div class="rounded-3xl overflow-hidden border border-white/5 shadow-2xl bg-black/30 flex items-center justify-center p-4 max-h-[400px] overflow-auto custom-scrollbar cursor-pointer" @click="previewImage = img">
                                            <img :src="img" class="max-w-full max-h-[360px] object-contain rounded-xl" :alt="'Ảnh phân tích ' + (idx+1)">
                                        </div>
                                    </template>
                                </template>
                                <template x-if="!(result.annotated_images && result.annotated_images.length > 0) && result.annotated_image">
                                    <div class="rounded-3xl overflow-hidden border border-white/5 shadow-2xl bg-black/30 flex items-center justify-center p-4 max-h-[400px] overflow-auto custom-scrollbar cursor-pointer" @click="previewImage = result.annotated_image">
                                        <img :src="result.annotated_image" class="max-w-full max-h-[360px] object-contain rounded-xl" alt="Analyzed Message">
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- AI Insight -->
                    <div class="p-6 liquid-glass border-white/5 bg-purple-500/[0.02]">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-400">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-black text-white uppercase tracking-wider">AI Fraud Detection</h4>
                                <p class="text-[10px] text-white/40 font-bold uppercase tracking-widest">Behavioral & Semantic Analysis</p>
                            </div>
                        </div>
                        
                        <div class="ai-markdown text-white/70 text-sm leading-relaxed" 
                             x-html="renderMd(result.explanation || result.ai_insight || '')"></div>
                        <p x-show="!result.explanation && !result.ai_insight" class="text-white/20 text-xs italic">Không có phân tích AI.</p>
                    </div>

                    <!-- Grounded Intelligence / Proofs -->
                    {% include 'Scan/_osint_section.html' %}
                </div>

                <!-- Footer Actions -->
                <div class="p-8 bg-white/[0.02] border-t border-white/5 flex flex-wrap gap-4 justify-between items-center">
                    <div class="flex gap-4">
                        <button class="liquid-btn py-2 px-6 text-xs bg-white/5 text-white/60 border-white/10 hover:text-white"
                            @click="showToast('Đã lưu!','success')">
                            <i class="bi bi-bell"></i> Watchlist
                        </button>
                        <button class="liquid-btn py-2 px-6 text-xs bg-cyan-500/10 text-cyan-400 border-cyan-500/20 hover:bg-cyan-500/20 transition-all font-black"
                            @click="$dispatch('start-contextual-chat', { context: 'Message Scan Result\nInput: ' + message + '\nAnalysis: ' + aiText })">
                            <i class="bi bi-chat-dots-fill"></i> CHAT VỚI AI
                        </button>
                    </div>
                    <a :href="'/report/?target_type=message'"
                        class="liquid-btn py-2 px-10 text-xs bg-red-500/20 text-red-500 border-red-500/30 hover:bg-red-500/30 transition-all font-black">
                        <i class="bi bi-shield-exclamation text-sm"></i> BÁO CÁO VI PHẠM
                    </a>
                </div>
            </div>
        </div>
    </template>
</div>
{% include 'Scan/_scan_guide.html' with scan_type='message' %}
</div>
{% endblock %}