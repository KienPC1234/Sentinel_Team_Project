{% extends "base.html" %}
{% block title %}B√°o c√°o l·ª´a ƒë·∫£o{% endblock %}
{% block head_extra %}
<script>
    let reportEditorInstance = null;
    document.addEventListener('alpine:init', () => {
        Alpine.data('reportManager', () => ({
            target_type: new URLSearchParams(window.location.search).get('target_type') || '',
            target_value: new URLSearchParams(window.location.search).get('target_value') || '',
            scam_type:'', severity:'medium', description:'', evidence:null,
            scammer_phone: new URLSearchParams(window.location.search).get('phone') || '',
            scammer_bank_account: new URLSearchParams(window.location.search).get('bank_account') || '',
            scammer_bank_name: new URLSearchParams(window.location.search).get('bank_name') || '',
            scammer_name: new URLSearchParams(window.location.search).get('scammer_name') || '',
            banks: [],
            showBanks: false,
            loading: false,
            success: false,
            error: '',
            async fetchBanks() {
                try {
                    const resp = await fetch('/api/v1/scan/banks/');
                    const data = await resp.json();
                    this.banks = data.banks || data;
                } catch(e) { console.error('Failed to fetch banks', e); }
            },
            get filteredBanks() {
                if (!this.scammer_bank_name) return this.banks.slice(0, 10);
                return this.banks.filter(b => 
                    b.shortName.toLowerCase().includes(this.scammer_bank_name.toLowerCase()) || 
                    b.name.toLowerCase().includes(this.scammer_bank_name.toLowerCase())
                ).slice(0, 10);
            },
            async init() {
                this.fetchBanks();
                try {
                    reportEditorInstance = await window.createCKEditor('#report-editor', this.description, 'H√£y m√¥ t·∫£ chi ti·∫øt: t√¨nh hu·ªëng l·ª´a ƒë·∫£o, th·ªß ƒëo·∫°n c·ªßa ƒë·ªëi t∆∞·ª£ng...');
                    if (reportEditorInstance) {
                        reportEditorInstance.model.document.on('change:data', () => {
                            this.description = reportEditorInstance.getData();
                        });
                    }
                } catch (e) {
                    console.error('CKEditor init failed:', e);
                }
            },
            async submitReport() {
                if(!this.target_type){showToast('Vui l√≤ng ch·ªçn lo·∫°i ƒë·ªëi t∆∞·ª£ng', 'warning');return}
                if(!this.target_value.trim()){showToast('Vui l√≤ng nh·∫≠p th√¥ng tin c·ª• th·ªÉ', 'warning');return}
                if(!this.scam_type){showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c l·ª´a ƒë·∫£o', 'warning');return}
                if(!this.description.trim()){showToast('Vui l√≤ng nh·∫≠p n·ªôi dung chi ti·∫øt', 'warning');return}

                this.loading = true;
                this.error = '';
                const tsToken = document.querySelector('[name=cf-turnstile-response]').value;
                if(!tsToken){
                    this.error = 'Vui l√≤ng ho√†n th√†nh x√°c minh anti-spam';
                    this.loading = false;
                    showToast(this.error, 'warning');
                    return;
                }

                const fd = new FormData();
                fd.append('target_type', this.target_type);
                fd.append('target_value', this.target_value.trim());
                fd.append('scam_type', this.scam_type);
                fd.append('severity', this.severity);
                fd.append('description', this.description);
                fd.append('cf-turnstile-response', tsToken);
                if (this.scammer_phone) fd.append('scammer_phone', this.scammer_phone);
                if (this.scammer_bank_account) fd.append('scammer_bank_account', this.scammer_bank_account);
                if (this.scammer_bank_name) fd.append('scammer_bank_name', this.scammer_bank_name);
                if (this.scammer_name) fd.append('scammer_name', this.scammer_name);
                if (this.evidence) fd.append('evidence_file', this.evidence);

                try {
                    const resp = await fetch('/api/v1/report/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRFToken() },
                        body: fd
                    });
                    const res = await resp.json();
                    if (resp.ok) {
                        this.success = true;
                        showToast('B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!', 'success');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        this.error = res.error || 'G·ª≠i b√°o c√°o th·∫•t b·∫°i';
                        showToast(this.error, 'error');
                    }
                } catch(e) { 
                    this.error = 'L·ªói k·∫øt n·ªëi';
                    showToast(this.error, 'error');
                }
                finally { this.loading = false; }
            }
        }));
    });
</script>
{% endblock %}

{% block content %}
<div class="animate-fadein max-w-3xl mx-auto space-y-10" x-data="reportManager()">
    <!-- Page Header -->
    <div class="text-center space-y-4">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-red-500/10 text-red-500 mb-2 border border-red-500/20 shadow-lg shadow-red-500/10">
            <i class="bi bi-clipboard-pulse text-4xl"></i>
        </div>
        <h1 class="text-4xl font-black text-white tracking-tight">
            G·ª≠i <span class="glow-text text-red-500">B√°o c√°o X·∫•u</span>
        </h1>
        <p class="text-white/40 max-w-md mx-auto text-sm leading-relaxed">
            M·ªói b√°o c√°o c·ªßa b·∫°n gi√∫p h√†ng ng√†n ng∆∞·ªùi kh√°c tr√°nh kh·ªèi b·∫´y l·ª´a ƒë·∫£o. C·∫£m ∆°n b·∫°n ƒë√£ hi·ªáp l·ª±c!
        </p>
    </div>

    <!-- Success State -->
    <div x-show="success" x-transition.scale.origin.top class="liquid-card p-12 text-center space-y-8 bg-green-500/[0.02]">
        <div class="w-24 h-24 bg-green-500/20 rounded-full flex items-center justify-center mx-auto ring-8 ring-green-500/5 shadow-2xl shadow-green-500/20">
            <i class="bi bi-check-circle-fill text-green-500 text-5xl"></i>
        </div>
        <div class="space-y-2">
            <h2 class="text-3xl font-black text-white">B√°o c√°o ƒë√£ g·ª≠i!</h2>
            <p class="text-white/40 text-sm max-w-sm mx-auto">ShieldCall ƒë√£ ghi nh·∫≠n th√¥ng tin. ƒê·ªôi ng≈© ki·ªÉm duy·ªát s·∫Ω x·ª≠ l√Ω trong v√≤ng 24h.</p>
        </div>
        <button class="liquid-btn bg-white/5 text-white/80 py-3 px-10 text-sm font-bold border-white/10 hover:bg-white/10"
            @click="success=false; target_type=''; target_value=''; scam_type=''; severity='medium'; description=''; evidence=null;">
            <i class="bi bi-plus-circle mr-2"></i> TI·∫æP T·ª§C B√ÅO C√ÅO
        </button>
    </div>

    <!-- Form Area -->
    <div x-show="!success" class="liquid-card p-8 sm:p-12 space-y-10">
        <div class="space-y-8">
            <!-- Target Type & Value -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Lo·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                    <select class="liquid-input w-full py-4 px-6 text-sm font-bold bg-white/5 border-white/10" x-model="target_type">
                        <option value="" class="bg-slate-900">-- Ch·ªçn lo·∫°i --</option>
                        <option value="phone" class="bg-slate-900">üìû S·ªë ƒëi·ªán tho·∫°i</option>
                        <option value="domain" class="bg-slate-900">üåê Website / URL</option>
                        <option value="account" class="bg-slate-900">üè¶ T√†i kho·∫£n ng√¢n h√†ng</option>
                        <option value="message" class="bg-slate-900">üí¨ Tin nh·∫Øn</option>
                        <option value="qr" class="bg-slate-900">üì∑ QR Code</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Th√¥ng tin c·ª• th·ªÉ</label>
                    <input type="text" class="liquid-input w-full py-4 px-6 text-sm font-bold" x-model="target_value"
                        :placeholder="target_type==='phone'?'VD: 0912...':target_type==='domain'?'VD: bank-phish.com':'Nh·∫≠p d·ªØ li·ªáu...'">
                </div>
            </div>

            <!-- New Scammer Details (Optional but encouraged) -->
            <div class="p-6 rounded-[2.5rem] bg-white/[0.02] border border-white/5 space-y-6">
                <h4 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] flex items-center gap-2">
                    <i class="bi bi-info-circle"></i> Chi ti·∫øt ƒë·ªëi t∆∞·ª£ng (Ch·ªëng gi·∫£ m·∫°o)
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">H·ªç t√™n ƒë·ªëi t∆∞·ª£ng</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_name" placeholder="VD: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">S·ªë ƒëi·ªán tho·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_phone" placeholder="VD: 09... ho·∫∑c N/A">
                    </div>
                    <div class="space-y-2" x-init="fetchBanks()">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Ng√¢n h√†ng</label>
                        <div class="relative" @click.away="showBanks = false">
                            <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" 
                                x-model="scammer_bank_name" 
                                @focus="showBanks = true"
                                placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n ng√¢n h√†ng...">
                            
                            <div x-show="showBanks && filteredBanks.length" 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 translate-y-2"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="absolute z-50 w-full mt-2 bg-[#0a0f18] border border-white/10 rounded-2xl max-h-60 overflow-y-auto shadow-2xl">
                                <template x-for="bank in filteredBanks" :key="bank.code">
                                    <div @click="scammer_bank_name = bank.shortName; showBanks = false" 
                                         class="p-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 border-b border-white/5 last:border-0 transition-colors">
                                        <div class="w-8 h-8 rounded bg-white p-1 flex items-center justify-center">
                                            <img :src="bank.logo" class="max-w-full max-h-full object-contain" x-show="bank.logo">
                                            <i class="bi bi-bank" x-show="!bank.logo"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-white text-[10px] font-bold truncate" x-text="bank.shortName"></p>
                                            <p class="text-white/40 text-[8px] truncate" x-text="bank.name"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">S·ªë t√†i kho·∫£n</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_bank_account" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n...">
                    </div>
                </div>
            </div>

            <!-- Scam Category -->
            <div class="space-y-2">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Ph∆∞∆°ng th·ª©c l·ª´a ƒë·∫£o</label>
                <select class="liquid-input w-full py-4 px-6 text-sm font-bold bg-white/5 border-white/10" x-model="scam_type">
                    <option value="" class="bg-slate-900">-- Ch·ªçn danh m·ª•c --</option>
                    <option value="police_impersonation" class="bg-slate-900">Gi·∫£ danh C√¥ng an / Vi·ªán ki·ªÉm s√°t</option>
                    <option value="bank_impersonation" class="bg-slate-900">üè¶ Gi·∫£ m·∫°o Ng√¢n h√†ng</option>
                    <option value="recruitment_scam" class="bg-slate-900">üíº L·ª´a tuy·ªÉn d·ª•ng vi·ªác l√†m</option>
                    <option value="investment_scam" class="bg-slate-900">üìä L·ª´a ƒë·∫ßu t∆∞ Forex / Crypto</option>
                    <option value="delivery_scam" class="bg-slate-900">üì¶ Gi·∫£ m·∫°o Giao h√†ng / Tr√∫ng th∆∞·ªüng</option>
                    <option value="loan_scam" class="bg-slate-900">üí∞ L·ª´a vay ti·ªÅn qua app / ng∆∞·ªùi th√¢n</option>
                    <option value="phishing" class="bg-slate-900">üé£ Website gi·∫£ m·∫°o (Phishing)</option>
                    <option value="other" class="bg-slate-900">H√¨nh th·ª©c kh√°c...</option>
                </select>
            </div>

            <!-- Severity Selector -->
            <div class="space-y-3">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">M·ª©c ƒë·ªô nghi√™m tr·ªçng</label>
                <div class="flex flex-wrap gap-3 p-2 bg-white/[0.03] rounded-3xl border border-white/5">
                    <button @click="severity='low'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='low'?'bg-green-500 text-black shadow-lg shadow-green-500/20':'text-white/40 hover:bg-white/5'">TH·∫§P</button>
                    <button @click="severity='medium'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='medium'?'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20':'text-white/40 hover:bg-white/5'">TRUNG B√åNH</button>
                    <button @click="severity='high'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='high'?'bg-red-500 text-black shadow-lg shadow-red-500/20':'text-white/40 hover:bg-white/5'">CAO</button>
                    <button @click="severity='critical'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='critical'?'bg-red-600 text-white shadow-lg shadow-red-600/40':'text-white/40 hover:bg-white/5'">KH·∫®N C·∫§P</button>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2 flex items-center gap-2">
                    <i class="bi bi-chat-text-fill text-red-500/40"></i> N·ªôi dung chi ti·∫øt (Rich Text)
                </label>
                <div class="liquid-input w-full overflow-hidden bg-black/20 rounded-2xl border border-white/5">
                    <div id="report-editor" class="py-4 px-6 min-h-[250px] text-sm font-medium focus:outline-none"></div>
                </div>
                <p class="text-[9px] text-white/20 font-black uppercase tracking-widest ml-1 mt-1">Th√¥ng tin c√†ng chi ti·∫øt s·∫Ω c√†ng gi√∫p √≠ch cho c·ªông ƒë·ªìng.</p>
            </div>

            <!-- Evidence -->
            <div class="space-y-3">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2 flex items-center gap-2">
                    <i class="bi bi-images text-red-500/40"></i> B·∫±ng ch·ª©ng li√™n quan
                </label>
                <div class="border-2 border-dashed border-white/10 rounded-[2rem] p-10 text-center bg-white/[0.01] hover:bg-white/[0.03] hover:border-red-500/30 transition-all cursor-pointer group relative overflow-hidden"
                    @click="$refs.evidenceInput.click()">
                    <input type="file" accept="image/*" x-ref="evidenceInput" class="hidden" @change="evidence=$event.target.files[0]">
                    <div class="w-20 h-20 bg-white/5 rounded-3xl inline-flex items-center justify-center mb-5 group-hover:scale-110 group-hover:bg-red-500/10 transition-all duration-500">
                        <i class="bi bi-cloud-arrow-up text-3xl text-white/30 group-hover:text-red-500"></i>
                    </div>
                    <p class="text-[11px] font-black text-white/40 tracking-[0.2em] uppercase transition-colors group-hover:text-white/60" 
                       x-text="evidence ? 'FILE: ' + evidence.name : 'NH·∫§P ƒê·ªÇ T·∫¢I ·∫¢NH B·∫∞NG CH·ª®NG (MAX 5MB)'"></p>
                </div>
            </div>
            
            <!-- Cloudflare Turnstile -->
            <!-- Cloudflare Turnstile was here, moved below -->
        </div>

        <!-- Submit Button -->
        <div class="pt-10 space-y-6 border-t border-white/5">
            <div class="mb-4 flex justify-center">
                <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITEKEY }}" :data-theme="document.documentElement.getAttribute('data-theme') || 'dark'" x-ref="turnstile"></div>
            </div>
            <button type="submit" class="liquid-btn w-full py-6 bg-red-500 text-black font-black text-xl hover:bg-red-400 active:scale-[0.97] transition-all shadow-2xl shadow-red-500/20 uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed" 
                :disabled="loading" @click="submitReport()">
                <span x-show="!loading" class="flex items-center justify-center gap-3">
                    <i class="bi bi-shield-fill-exclamation text-2xl"></i>
                    <span>T√îI X√ÅC NH·∫¨N G·ª¨I B√ÅO C√ÅO</span>
                </span>
                <span x-show="loading" class="flex items-center justify-center gap-4">
                    <span class="spinner w-6 h-6 border-black border-4"></span>
                    <span>ƒêANG X·ª¨ L√ù D·ªÆ LI·ªÜU...</span>
                </span>
            </button>
            <div x-show="error" class="flex items-center justify-center gap-2 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl animate-shake">
                <i class="bi bi-exclamation-triangle-fill text-red-500"></i>
                <p x-text="error" class="text-red-500 text-[11px] font-black uppercase tracking-wider"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}