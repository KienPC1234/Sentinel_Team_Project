{% extends "base.html" %}
{% block title %}B√°o c√°o l·ª´a ƒë·∫£o{% endblock %}
{% block head_extra %}
<script>
    let reportEditorInstance = null;
    document.addEventListener('alpine:init', () => {
        Alpine.data('reportManager', () => ({
            target_type: new URLSearchParams(window.location.search).get('target_type') || '',
            target_value: new URLSearchParams(window.location.search).get('target_value') || '',
            scam_type:'', severity:'medium', description:'', evidence:null,
            evidenceFiles: [],
            scammer_phone: new URLSearchParams(window.location.search).get('phone') || '',
            scammer_bank_account: new URLSearchParams(window.location.search).get('bank_account') || '',
            scammer_bank_name: new URLSearchParams(window.location.search).get('bank_name') || '',
            scammer_name: new URLSearchParams(window.location.search).get('scammer_name') || '',
            showScammerDetails: false,
            banks: [],
            showBanks: false,
            loading: false,
            ocrLoading: false,
            annotatedImages: [],
            ocrSuggested: false,
            success: false,
            error: '',
            async runOCR() {
                if (!this.evidence) return;
                this.ocrLoading = true;
                this.annotatedImages = [];
                const fd = new FormData();
                fd.append('images', this.evidence);
                try {
                    const resp = await fetch('/api/v1/analyze-images', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRFToken() },
                        body: fd
                    });
                    const res = await resp.json();
                    if (resp.ok && res.ocr_text) {
                        this.annotatedImages = res.annotated_images || [];
                        const extracted = res.ocr_text.trim();
                        if (extracted) {
                            // Convert markdown from AI response to clean HTML for CKEditor
                            let htmlContent = extracted;
                            if (window.renderMarkdown) {
                                htmlContent = window.renderMarkdown(extracted);
                            } else if (window.marked && window.marked.parse) {
                                htmlContent = window.marked.parse(extracted, { breaks: true, gfm: true });
                            }
                            const currentData = reportEditorInstance.getData();
                            const newData = currentData + (currentData ? '<br><br>' : '') + htmlContent;
                            reportEditorInstance.setData(newData);
                            this.description = newData;
                            this.ocrSuggested = false;
                            showToast('ƒê√£ ph√¢n t√≠ch th√¥ng tin b·∫±ng AI!', 'success');
                        }
                    } else {
                        showToast('Kh√¥ng t√¨m th·∫•y ch·ªØ ho·∫∑c m√£ QR trong ·∫£nh', 'info');
                    }
                } catch(e) {
                    showToast('L·ªói khi qu√©t ·∫£nh', 'error');
                } finally {
                    this.ocrLoading = false;
                }
            },
            async fetchBanks() {
                try {
                    const resp = await fetch('/api/v1/scan/banks/');
                    const data = await resp.json();
                    this.banks = data.banks || data;
                } catch(e) { console.error('Failed to fetch banks', e); }
            },
            get filteredBanks() {
                if (!this.scammer_bank_name) return this.banks.slice(0, 10);
                return this.banks.filter(b => 
                    b.shortName.toLowerCase().includes(this.scammer_bank_name.toLowerCase()) || 
                    b.name.toLowerCase().includes(this.scammer_bank_name.toLowerCase())
                ).slice(0, 10);
            },
            async init() {
                this.fetchBanks();
                try {
                    reportEditorInstance = await window.createCKEditor('#report-editor', this.description, 'H√£y m√¥ t·∫£ chi ti·∫øt: t√¨nh hu·ªëng l·ª´a ƒë·∫£o, th·ªß ƒëo·∫°n c·ªßa ƒë·ªëi t∆∞·ª£ng...');
                    if (reportEditorInstance) {
                        reportEditorInstance.model.document.on('change:data', () => {
                            this.description = reportEditorInstance.getData();
                        });
                    }
                } catch (e) {
                    console.error('CKEditor init failed:', e);
                }
            },
            async submitReport() {
                if(!this.target_type){showToast('Vui l√≤ng ch·ªçn lo·∫°i ƒë·ªëi t∆∞·ª£ng', 'warning');return}
                if(!this.target_value.trim()){showToast('Vui l√≤ng nh·∫≠p th√¥ng tin c·ª• th·ªÉ', 'warning');return}
                if(!this.scam_type){showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c l·ª´a ƒë·∫£o', 'warning');return}
                if(!this.description.trim()){showToast('Vui l√≤ng nh·∫≠p n·ªôi dung chi ti·∫øt', 'warning');return}

                // OCR Scan Reminder
                if (this.evidence && !this.description.includes('[D·ªØ li·ªáu tr√≠ch xu·∫•t t·ª´ ·∫£nh]')) {
                    const confirmScan = await Swal.fire({
                        title: 'B·∫°n ch∆∞a qu√©t ·∫£nh?',
                        text: 'B·∫°n ƒë√£ t·∫£i ·∫£nh l√™n nh∆∞ng ch∆∞a s·ª≠ d·ª•ng t√≠nh nƒÉng "Qu√©t ch·ªØ b·∫±ng AI". B·∫°n c√≥ mu·ªën qu√©t ·∫£nh ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin b√°o c√°o kh√¥ng?',
                        icon: 'question',
                        background: '#0a0a1a',
                        color: '#fff',
                        showCancelButton: true,
                        confirmButtonText: 'Qu√©t ngay',
                        cancelButtonText: 'B·ªè qua & G·ª≠i',
                        customClass: {
                            popup: 'rounded-[2rem] border border-white/10',
                            confirmButton: 'liquid-btn bg-cyan-500 text-black px-6 py-2 rounded-xl',
                            cancelButton: 'liquid-btn bg-white/5 text-white/50 px-6 py-2 rounded-xl'
                        }
                    });
                    if (confirmScan.isConfirmed) {
                        await this.runOCR();
                        return; // Stop and let user review scanned text
                    }
                }

                if (this.evidence && !this.annotatedImages.length && !this.ocrSuggested) {
                    this.ocrSuggested = true;
                    Swal.fire({
                        title: 'Th√¥ng b√°o!',
                        text: 'B·∫°n ƒë√£ t·∫£i ·∫£nh l√™n nh∆∞ng ch∆∞a s·ª≠ d·ª•ng AI ƒë·ªÉ qu√©t th√¥ng tin. B·∫°n c√≥ mu·ªën qu√©t tr∆∞·ªõc khi g·ª≠i kh√¥ng?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'C√≥, qu√©t ngay!',
                        cancelButtonText: 'Kh√¥ng, g·ª≠i lu√¥n',
                        background: '#0d0d1f',
                        color: '#fff',
                        customClass: {
                            popup: 'rounded-[2rem] border border-white/10',
                            confirmButton: 'liquid-btn bg-cyan-500 text-black px-6 py-2 rounded-xl',
                            cancelButton: 'liquid-btn bg-white/5 text-white/50 px-6 py-2 rounded-xl'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.runOCR();
                        } else {
                            this.executeSubmit();
                        }
                    });
                    return;
                }
                this.executeSubmit();
            },
            async executeSubmit() {
                this.error = '';
                const tsToken = document.querySelector('[name=cf-turnstile-response]').value;
                if(!tsToken){
                    this.error = 'Vui l√≤ng ho√†n th√†nh x√°c minh anti-spam';
                    this.loading = false;
                    showToast(this.error, 'warning');
                    return;
                }

                const fd = new FormData();
                fd.append('target_type', this.target_type);
                fd.append('target_value', this.target_value.trim());
                fd.append('scam_type', this.scam_type);
                fd.append('severity', this.severity);
                fd.append('description', this.description);
                fd.append('cf-turnstile-response', tsToken);
                if (this.scammer_phone) fd.append('scammer_phone', this.scammer_phone);
                if (this.scammer_bank_account) fd.append('scammer_bank_account', this.scammer_bank_account);
                if (this.scammer_bank_name) fd.append('scammer_bank_name', this.scammer_bank_name);
                if (this.scammer_name) fd.append('scammer_name', this.scammer_name);
                if (this.evidence) fd.append('evidence_file', this.evidence);
                // Append additional evidence images
                for (const file of this.evidenceFiles) {
                    fd.append('evidence_images', file);
                }

                try {
                    const resp = await fetch('/api/v1/report/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCSRFToken() },
                        body: fd
                    });
                    const res = await resp.json();
                    if (resp.ok) {
                        this.success = true;
                        showToast('B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!', 'success');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        this.error = res.error || 'G·ª≠i b√°o c√°o th·∫•t b·∫°i';
                        showToast(this.error, 'error');
                    }
                } catch(e) { 
                    this.error = 'L·ªói k·∫øt n·ªëi';
                    showToast(this.error, 'error');
                }
                finally { this.loading = false; }
            }
        }));
    });
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 lg:grid lg:grid-cols-[1fr_340px] lg:gap-8 lg:items-start">
<div class="animate-fadein max-w-3xl mx-auto space-y-10" x-data="reportManager()">
    <!-- Page Header -->
    <div class="text-center space-y-4" data-aos="fade-up">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-red-500/10 text-red-500 mb-2 border border-red-500/20 shadow-lg shadow-red-500/10" data-aos="zoom-in" data-aos-delay="100">
            <i class="bi bi-clipboard-pulse text-4xl"></i>
        </div>
        <h1 class="text-4xl font-black text-white tracking-tight" data-aos="fade-up" data-aos-delay="200">
            G·ª≠i <span class="glow-text text-red-500">B√°o c√°o X·∫•u</span>
        </h1>
        <p class="text-white/40 max-w-md mx-auto text-sm leading-relaxed" data-aos="fade-up" data-aos-delay="300">
            M·ªói b√°o c√°o c·ªßa b·∫°n gi√∫p h√†ng ng√†n ng∆∞·ªùi kh√°c tr√°nh kh·ªèi b·∫´y l·ª´a ƒë·∫£o. C·∫£m ∆°n b·∫°n ƒë√£ hi·ªáp l·ª±c!
        </p>
    </div>

    <!-- Success State -->
    <div x-show="success" x-transition.scale.origin.top class="liquid-card p-12 text-center space-y-8 bg-green-500/[0.02]">
        <div class="w-24 h-24 bg-green-500/20 rounded-full flex items-center justify-center mx-auto ring-8 ring-green-500/5 shadow-2xl shadow-green-500/20">
            <i class="bi bi-check-circle-fill text-green-500 text-5xl"></i>
        </div>
        <div class="space-y-2">
            <h2 class="text-3xl font-black text-white">B√°o c√°o ƒë√£ g·ª≠i!</h2>
            <p class="text-white/40 text-sm max-w-sm mx-auto">ShieldCall ƒë√£ ghi nh·∫≠n th√¥ng tin. ƒê·ªôi ng≈© ki·ªÉm duy·ªát s·∫Ω x·ª≠ l√Ω trong v√≤ng 24h.</p>
        </div>
        <button class="liquid-btn bg-white/5 text-white/80 py-3 px-10 text-sm font-bold border-white/10 hover:bg-white/10"
            @click="success=false; target_type=''; target_value=''; scam_type=''; severity='medium'; description=''; evidence=null;">
            <i class="bi bi-plus-circle mr-2"></i> TI·∫æP T·ª§C B√ÅO C√ÅO
        </button>
    </div>

    <!-- Form Area -->
    <div x-show="!success" class="liquid-card p-8 sm:p-12 space-y-10">
        <div class="space-y-8">
            <!-- Target Type & Value -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4 dropdown-container">
                    <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Lo·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                    <div x-data="liquidSelect({
                        value: target_type,
                        placeholder: 'Ch·ªçn lo·∫°i ƒë·ªëi t∆∞·ª£ng',
                        options: [
                            { value: 'phone', label: 'üìû S·ªë ƒëi·ªán tho·∫°i l·ª´a ƒë·∫£o' },
                            { value: 'domain', label: 'üåê Website / Phishing Link' },
                            { value: 'email', label: 'üìß ƒê·ªãa ch·ªâ Email gi·∫£ m·∫°o' },
                            { value: 'account', label: 'üè¶ T√†i kho·∫£n ng√¢n h√†ng' },
                            { value: 'message', label: 'üí¨ N·ªôi dung tin nh·∫Øn' },
                            { value: 'qr', label: ' Scan QR Code' }
                        ]
                    })" 
                    x-init="$watch('target_type', v => value = v)"
                    class="liquid-custom-select" @change="target_type = $event.detail">
                        <div class="liquid-select-trigger" :class="{ 'active': open }" @click="open = !open">
                            <span x-text="label"></span>
                            <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                        </div>
                        <div x-show="open" 
                             x-transition:enter="liquid-select-dropdown entering"
                             x-transition:enter-end="liquid-select-dropdown entered"
                             x-transition:leave="liquid-select-dropdown entering"
                             class="liquid-select-dropdown">
                            <template x-for="option in options" :key="option.value">
                                <div class="liquid-select-option" 
                                     :class="{ 'selected': value === option.value }"
                                     @click="select(option)">
                                    <span x-text="option.label"></span>
                                </div>
                            </template>
                        </div>
                        <select name="target_type" x-model="target_type" class="hidden">
                            <template x-for="option in options" :key="option.value">
                                <option :value="option.value" x-text="option.label"></option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Th√¥ng tin c·ª• th·ªÉ</label>
                    <input type="text" class="liquid-input w-full py-4 px-6 text-sm font-bold" x-model="target_value"
                        :placeholder="target_type==='phone'?'VD: 0912...':target_type==='domain'?'VD: bank-phish.com':target_type==='email'?'VD: kien@scam.com':'Nh·∫≠p d·ªØ li·ªáu...'">
                </div>
            </div>

            <!-- New Scammer Details (Optional but encouraged) -->
            <div class="p-6 rounded-[2.5rem] bg-white/[0.02] border border-white/5 space-y-4">
                <button type="button" @click="showScammerDetails = !showScammerDetails" class="w-full flex items-center justify-between gap-4 text-left">
                    <h4 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] flex items-center gap-2">
                        <i class="bi bi-info-circle"></i> Chi ti·∫øt ƒë·ªëi t∆∞·ª£ng gi·∫£ m·∫°o
                    </h4>
                    <i class="bi bi-chevron-down text-cyan-400/70 transition-transform" :class="showScammerDetails ? 'rotate-180' : ''"></i>
                </button>

                <div x-show="showScammerDetails" x-transition class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">H·ªç t√™n ƒë·ªëi t∆∞·ª£ng</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_name" placeholder="VD: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">S·ªë ƒëi·ªán tho·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_phone" placeholder="VD: 09... ho·∫∑c N/A">
                    </div>
                    <div class="space-y-2 dropdown-container" x-init="fetchBanks()">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Ng√¢n h√†ng</label>
                        <div x-data="liquidSelect({
                            value: scammer_bank_name,
                            placeholder: 'Ch·ªçn ho·∫∑c nh·∫≠p t√™n ng√¢n h√†ng...',
                            options: () => banks.map(b => ({ value: b.shortName, label: b.shortName + ' - ' + b.name, logo: b.logo }))
                        })" 
                        x-init="$watch('scammer_bank_name', v => value = v)"
                        class="liquid-custom-select" @change="scammer_bank_name = $event.detail">
                            <div class="liquid-select-trigger py-3 px-5 text-xs font-bold" :class="{ 'active': open }" @click="open = !open">
                                <span class="flex items-center gap-2 truncate">
                                    <template x-if="options.find(o => o.value === value)?.logo">
                                        <img :src="options.find(o => o.value === value).logo" class="w-4 h-4 object-contain">
                                    </template>
                                    <span x-text="label" class="truncate"></span>
                                </span>
                                <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                            </div>
                            <div x-show="open" 
                                 x-transition:enter="liquid-select-dropdown entering"
                                 x-transition:enter-end="liquid-select-dropdown entered"
                                 x-transition:leave="liquid-select-dropdown entering"
                                 class="liquid-select-dropdown">
                                <div class="max-h-60 overflow-y-auto custom-scrollbar">
                                    <template x-for="option in options" :key="option.value">
                                        <div class="liquid-select-option text-[10px]" 
                                             :class="{ 'selected': value === option.value }"
                                             @click="select(option)">
                                            <template x-if="option.logo">
                                                <img :src="option.logo" class="w-4 h-4 object-contain bg-white rounded-sm p-0.5">
                                            </template>
                                            <span x-text="option.label"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <input type="hidden" name="scammer_bank_name" :value="value">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">S·ªë t√†i kho·∫£n</label>
                        <input type="text" class="liquid-input w-full py-3 px-5 text-xs font-bold" x-model="scammer_bank_account" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n...">
                    </div>
                </div>
            </div>

            <!-- Scam Category -->
            <div class="space-y-2 dropdown-container" data-aos="fade-up" data-aos-delay="200">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">Ph∆∞∆°ng th·ª©c l·ª´a ƒë·∫£o</label>
                <div x-data="liquidSelect({
                    value: scam_type,
                    placeholder: '-- Ch·ªçn h√¨nh th·ª©c l·ª´a ƒë·∫£o --',
                    options: [
                        { value: 'police_impersonation', label: 'üöì Gi·∫£ danh C√¥ng an / Vi·ªán ki·ªÉm s√°t' },
                        { value: 'bank_impersonation', label: 'üè¶ Gi·∫£ m·∫°o Ng√¢n h√†ng / V√≠ ƒëi·ªán t·ª≠' },
                        { value: 'recruitment_scam', label: 'üíº L·ª´a tuy·ªÉn d·ª•ng (Vi·ªác nh·∫π l∆∞∆°ng cao)' },
                        { value: 'investment_scam', label: 'üìä L·ª´a ƒë·∫ßu t∆∞ t√†i ch√≠nh / Crypto' },
                        { value: 'delivery_scam', label: 'üì¶ L·ª´a ƒë·∫£o Giao h√†ng / Nh·∫≠n qu√†' },
                        { value: 'loan_scam', label: 'üí∞ L·ª´a vay ti·ªÅn nhanh qua App' },
                        { value: 'phishing', label: 'üé£ Website ƒë√°nh c·∫Øp th√¥ng tin (Phishing)' },
                        { value: 'other', label: 'H√¨nh th·ª©c l·ª´a ƒë·∫£o kh√°c...' }
                    ]
                })" 
                x-init="$watch('scam_type', v => value = v)"
                class="liquid-custom-select" @change="scam_type = $event.detail">
                    <div class="liquid-select-trigger" :class="{ 'active': open }" @click="open = !open">
                        <span x-text="label"></span>
                        <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                    </div>
                    <div x-show="open" 
                         x-transition:enter="liquid-select-dropdown entering"
                         x-transition:enter-end="liquid-select-dropdown entered"
                         x-transition:leave="liquid-select-dropdown entering"
                         class="liquid-select-dropdown">
                        <template x-for="option in options" :key="option.value">
                            <div class="liquid-select-option" 
                                 :class="{ 'selected': value === option.value }"
                                 @click="select(option)">
                                <span x-text="option.label"></span>
                            </div>
                        </template>
                    </div>
                    <select name="scam_type" x-model="scam_type" class="hidden">
                        <template x-for="option in options" :key="option.value">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
            </div>

            <!-- Severity Selector -->
            <div class="space-y-3">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2">M·ª©c ƒë·ªô nghi√™m tr·ªçng</label>
                <div class="flex flex-wrap gap-3 p-2 bg-white/[0.03] rounded-3xl border border-white/5">
                    <button @click="severity='low'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='low'?'bg-green-500 text-black shadow-lg shadow-green-500/20':'text-white/40 hover:bg-white/5'">TH·∫§P</button>
                    <button @click="severity='medium'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='medium'?'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20':'text-white/40 hover:bg-white/5'">TRUNG B√åNH</button>
                    <button @click="severity='high'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='high'?'bg-red-500 text-black shadow-lg shadow-red-500/20':'text-white/40 hover:bg-white/5'">CAO</button>
                    <button @click="severity='critical'" class="flex-1 py-3 px-4 rounded-2xl text-[10px] font-black tracking-widest uppercase transition-all"
                        :class="severity==='critical'?'bg-red-600 text-white shadow-lg shadow-red-600/40':'text-white/40 hover:bg-white/5'">KH·∫®N C·∫§P</button>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2 flex items-center gap-2">
                    <i class="bi bi-chat-text-fill text-red-500/40"></i> N·ªôi dung chi ti·∫øt (Rich Text)
                </label>
                <div class="liquid-input w-full overflow-hidden bg-black/20 rounded-2xl border border-white/5">
                    <div id="report-editor" class="py-4 px-6 min-h-[250px] text-sm font-medium focus:outline-none"></div>
                </div>
                <p class="text-[9px] text-white/20 font-black uppercase tracking-widest ml-1 mt-1">Th√¥ng tin c√†ng chi ti·∫øt s·∫Ω c√†ng gi√∫p √≠ch cho c·ªông ƒë·ªìng.</p>
            </div>

                <!-- Evidence & AI OCR -->
                <div class="space-y-6">
                    <label class="text-[11px] font-black text-white/30 uppercase tracking-[0.2em] ml-2 flex items-center gap-2">
                        <i class="bi bi-images text-red-500/40"></i> ·∫¢nh b·∫±ng ch·ª©ng (t·ªëi ƒëa 5 ·∫£nh)
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Main evidence (for OCR) -->
                        <div class="border-2 border-dashed border-white/10 rounded-[2rem] p-8 text-center bg-white/[0.01] hover:bg-white/[0.03] hover:border-red-500/30 transition-all cursor-pointer group relative overflow-hidden"
                            @click="$refs.evidenceInput.click()">
                            <input type="file" accept="image/*" x-ref="evidenceInput" class="hidden" @change="evidence=$event.target.files[0]; annotatedImages=[]">
                            
                            <div x-show="!evidence" class="space-y-4">
                                <div class="w-16 h-16 bg-white/5 rounded-2xl inline-flex items-center justify-center group-hover:scale-110 group-hover:bg-red-500/10 transition-all duration-500">
                                    <i class="bi bi-cloud-arrow-up text-2xl text-white/30 group-hover:text-red-500"></i>
                                </div>
                                <p class="text-[9px] font-black text-white/40 tracking-[0.2em] uppercase">·∫¢nh ch√≠nh (d√πng cho AI qu√©t)</p>
                            </div>

                            <div x-show="evidence" class="relative">
                                <img :src="evidence ? URL.createObjectURL(evidence) : ''" class="w-full h-32 object-cover rounded-2xl border border-white/10">
                                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity rounded-2xl">
                                    <i class="bi bi-arrow-repeat text-white text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col justify-center gap-4">
                            <button type="button" 
                                @click="runOCR()"
                                :disabled="!evidence || ocrLoading"
                                class="liquid-btn py-5 px-6 bg-cyan-500/10 text-cyan-400 border-cyan-500/20 hover:bg-cyan-500/20 disabled:opacity-30 disabled:cursor-not-allowed text-[11px] font-black tracking-widest uppercase flex items-center justify-center gap-3"
                                :class="evidence && !annotatedImages.length ? 'animate-pulse ring-2 ring-cyan-500/30' : ''">
                                <i class="bi bi-eye-fill" :class="ocrLoading ? 'animate-spin' : ''"></i>
                                <span x-text="ocrLoading ? 'ƒêANG QU√âT M·∫ÆT TH·∫¶N...' : (annotatedImages.length ? 'ƒê√É QU√âT TH√ÄNH C√îNG' : 'QU√âT CH·ªÆ & QR B·∫∞NG AI')"></span>
                            </button>
                            <p class="text-[8px] text-white/20 font-bold uppercase tracking-widest text-center italic leading-relaxed">
                                M·∫Øt th·∫ßn AI s·∫Ω tr√≠ch xu·∫•t th√¥ng tin & gi·∫£i m√£ m√£ QR trong ·∫£nh.
                            </p>
                        </div>
                    </div>

                    <!-- Additional evidence images -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <p class="text-[9px] font-black text-white/30 uppercase tracking-widest ml-2">·∫¢nh b·ªï sung</p>
                            <span class="text-[9px] font-bold text-white/20" x-text="evidenceFiles.length + '/4 ·∫£nh'"></span>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <template x-for="(file, idx) in evidenceFiles" :key="idx">
                                <div class="relative w-24 h-24 rounded-2xl overflow-hidden border border-white/10 group">
                                    <img :src="URL.createObjectURL(file)" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">
                                        <button type="button" @click="evidenceFiles.splice(idx, 1)" class="text-red-400 hover:text-red-300">
                                            <i class="bi bi-trash text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="evidenceFiles.length < 4"
                                 class="w-24 h-24 rounded-2xl border-2 border-dashed border-white/10 flex items-center justify-center cursor-pointer hover:border-cyan-500/30 hover:bg-white/[0.02] transition-all"
                                 @click="$refs.extraEvidenceInput.click()">
                                <i class="bi bi-plus-lg text-white/20 text-xl"></i>
                            </div>
                            <input type="file" accept="image/*" multiple x-ref="extraEvidenceInput" class="hidden"
                                @change="[...($event.target.files)].slice(0, 4 - evidenceFiles.length).forEach(f => evidenceFiles.push(f)); $event.target.value=''">
                        </div>
                    </div>
                </div>

                <!-- Annotated Results Display -->
                <div x-show="annotatedImages.length" x-transition class="mt-8 space-y-4">
                    <h5 class="text-[10px] font-black text-cyan-400 uppercase tracking-widest ml-2 flex items-center gap-2">
                        <i class="bi bi-layers-half"></i> B·∫£n ƒë·ªì tr√≠ch xu·∫•t AI (Bao g·ªìm QR & VƒÉn b·∫£n)
                    </h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <template x-for="(img, idx) in annotatedImages" :key="idx">
                            <div class="rounded-3xl border border-cyan-500/20 overflow-hidden bg-black/40 shadow-xl group cursor-zoom-in"
                                 @click="Swal.fire({imageUrl: img, background: '#000', showConfirmButton: false, customClass: {popup: 'rounded-[3rem] border border-white/10'}})">
                                <img :src="img" class="w-full h-auto group-hover:scale-105 transition-transform duration-500">
                            </div>
                        </template>
                    </div>
                </div>
            
            <!-- Cloudflare Turnstile -->
            <!-- Cloudflare Turnstile was here, moved below -->
        </div>

        <!-- Submit Button -->
        <div class="pt-10 space-y-6 border-t border-white/5">
            <div class="mb-4 flex justify-center">
                <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITEKEY }}" :data-theme="document.documentElement.getAttribute('data-theme') || 'dark'" x-ref="turnstile"></div>
            </div>
            <button type="submit" class="liquid-btn w-full py-6 bg-red-500 text-black font-black text-xl hover:bg-red-400 active:scale-[0.97] transition-all shadow-2xl shadow-red-500/20 uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed" 
                :disabled="loading" @click="submitReport()">
                <span x-show="!loading" class="flex items-center justify-center gap-3">
                    <i class="bi bi-shield-fill-exclamation text-2xl"></i>
                    <span>T√îI X√ÅC NH·∫¨N G·ª¨I B√ÅO C√ÅO</span>
                </span>
                <span x-show="loading" class="flex items-center justify-center gap-4">
                    <span class="spinner w-6 h-6 border-black border-4"></span>
                    <span>ƒêANG X·ª¨ L√ù D·ªÆ LI·ªÜU...</span>
                </span>
            </button>
            <div x-show="error" class="flex items-center justify-center gap-2 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl animate-shake">
                <i class="bi bi-exclamation-triangle-fill text-red-500"></i>
                <p x-text="error" class="text-red-500 text-[11px] font-black uppercase tracking-wider"></p>
            </div>
        </div>
    </div>
</div>
{% include 'Scan/_scan_guide.html' with scan_type='report' %}
</div>
{% endblock %}