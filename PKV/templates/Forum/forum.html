{% extends "base.html" %}
{% block title %}Diễn đàn cộng đồng{% endblock %}
{% block head_extra %}
<style>
    .forum-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .forum-card:hover {
        border-color: rgba(24, 255, 255, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }
    .verified-badge {
        background: linear-gradient(135deg, #18ffff, #b388ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 0.9rem;
    }
    .reaction-btn {
        transition: all 0.2s ease;
    }
    .reaction-btn:hover {
        transform: scale(1.1);
        background: var(--glass-border);
    }
    .reaction-btn.active {
        color: var(--accent-cyan);
        background: rgba(24, 255, 255, 0.1);
    }
    .reaction-btn.active-red {
        color: #ff1744;
        background: rgba(255, 23, 68, 0.1);
    }
    .category-tag {
        font-size: 0.65rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-weight: 800;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('forumApp', () => ({
        activeTab: 'all',
        searchQuery: '',
        sortBy: 'newest',
        posts: [],
        loading: false,

        init() {
            try {
                const dataEl = document.getElementById('forum-posts-data');
                if (dataEl) this.posts = JSON.parse(dataEl.textContent);
            } catch (e) {
                console.error('Forum Data Error:', e);
            }
        },
        
        async toggleLike(post) {
            if (!post.id) return;
            try {
                const resp = await fetch('/api/v1/forum/posts/' + post.id + '/like/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCSRFToken()}
                });
                if(resp.ok) {
                    const data = await resp.json();
                    post.likes_count = data.likes_count;
                    post.user_liked = data.liked;
                }
            } catch(e) {}
        },
        async toggleReaction(post, type) {
            if (!post.id) return;
            try {
                const resp = await fetch(`/api/v1/forum/posts/${post.id}/reaction/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken()},
                    body: JSON.stringify({ reaction_type: type })
                });
                if(resp.ok) {
                    const data = await resp.json();
                    if(type === 'helpful') {
                        post.helpful_count = data.helpful_count;
                        post.user_helpful = data.reacted;
                    } else if(type === 'share') {
                        post.shares_count = data.shares_count;
                        post.user_shared = data.reacted;
                    }
                }
            } catch(e) {}
        },
        async reportPost(post) {
            if (!post.id) return;
            const { value: reason } = await Swal.fire({
                title: 'Báo cáo bài viết',
                input: 'textarea',
                inputLabel: 'Lý do báo cáo',
                inputPlaceholder: 'Tại sao bạn báo cáo bài viết này...',
                showCancelButton: true,
                confirmButtonColor: '#ff1744',
                background: '#161235',
                color: '#fff'
            });
            
            if (reason) {
                try {
                    const resp = await fetch(`/api/v1/forum/posts/${post.id}/report/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken()},
                        body: JSON.stringify({ reason: reason })
                    });
                    if(resp.ok) {
                        showToast('Cảm ơn bạn đã báo cáo!', 'success');
                    }
                } catch(e) {}
            }
        },
        filteredPosts() {
            if (!Array.isArray(this.posts)) return [];
            let filtered = this.posts;
            if(this.activeTab !== 'all') filtered = filtered.filter(p => p.category === this.activeTab);
            if(this.searchQuery.trim()) {
                const q = this.searchQuery.toLowerCase();
                filtered = filtered.filter(p => (p.title || '').toLowerCase().includes(q) || (p.content || '').toLowerCase().includes(q));
            }
            // Sort
            filtered = [...filtered];
            if (this.sortBy === 'popular') {
                filtered.sort((a, b) => (b.likes_count || 0) - (a.likes_count || 0));
            } else if (this.sortBy === 'discussed') {
                filtered.sort((a, b) => (b.comments_count || 0) - (a.comments_count || 0));
            } else if (this.sortBy === 'views') {
                filtered.sort((a, b) => (b.views_count || 0) - (a.views_count || 0));
            } else {
                // newest (default) — pinned first, then by created_at desc
                filtered.sort((a, b) => {
                    if (a.is_pinned !== b.is_pinned) return b.is_pinned ? 1 : -1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });
            }
            return filtered;
        },
        trendingPosts() {
            if (!Array.isArray(this.posts)) return [];
            return [...this.posts]
                .sort((a, b) => ((b.likes_count || 0) + (b.comments_count || 0) + (b.views_count || 0)) - ((a.likes_count || 0) + (a.comments_count || 0) + (a.views_count || 0)))
                .slice(0, 5);
        },
        timeAgo(dt) {
            if (!dt) return '';
            const diff = (Date.now() - new Date(dt)) / 1000;
            if(isNaN(diff)) return '';
            if(diff < 60) return 'Vừa xong';
            if(diff < 3600) return Math.floor(diff/60) + ' phút';
            if(diff < 86400) return Math.floor(diff/3600) + ' giờ';
            return Math.floor(diff/86400) + ' ngày';
        },
        categoryInfo(cat) {
            const map = {
                warning: { label: 'Cảnh báo', color: 'bg-red-500/20 text-red-500', icon: 'bi-exclamation-triangle' },
                discussion: { label: 'Thảo luận', color: 'bg-cyan-500/20 text-cyan-500', icon: 'bi-chat-dots' },
                experience: { label: 'Kinh nghiệm', color: 'bg-purple-500/20 text-purple-500', icon: 'bi-lightbulb' },
                question: { label: 'Hỏi đáp', color: 'bg-yellow-500/20 text-yellow-500', icon: 'bi-question-diamond' }
            };
            return map[cat] || { label: cat, color: 'bg-white/10 text-white/60', icon: 'bi-hash' };
        },
        getInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }
    }));
});
</script>
{% endblock %}

{% block content %}
{{ posts_data|json_script:"forum-posts-data" }}
<div x-data="forumApp" class="max-w-6xl mx-auto px-4 py-10">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12" data-aos="fade-up">
        <div data-aos="fade-right" data-aos-delay="100">
            <h1 class="text-4xl font-black text-white mb-2">Trung Tâm <span class="text-cyan-400">Cộng Đồng</span></h1>
            <p class="text-white/40">Nơi người dân chung tay đẩy lùi tội phạm công nghệ cao.</p>
        </div>
        <div class="flex items-center gap-3" data-aos="fade-left" data-aos-delay="200">
            <a href="/forum/create/" class="bg-gradient-to-r from-cyan-400 to-blue-600 text-[#0d0d1f] px-6 py-3 rounded-2xl font-bold flex items-center gap-2 hover:scale-105 transition-all shadow-xl shadow-cyan-500/20">
                <i class="bi bi-pencil-fill"></i> Tạo chủ đề mới
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Sidebar Navigation -->
        <div class="lg:col-span-3 space-y-6" data-aos="fade-right" data-aos-delay="300">
            <div class="glass-dropdown rounded-3xl p-4 overflow-hidden border border-white/5">
                <h3 class="text-[10px] uppercase font-black tracking-widest text-white/30 px-4 mb-4">Danh mục</h3>
                <nav class="space-y-1">
                    <button @click="activeTab='all'" :class="activeTab==='all' ? 'bg-white/10 text-cyan-400' : 'text-white/60 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all text-sm font-bold">
                        <i class="bi bi-grid-fill"></i> Tất cả
                    </button>
                    <button @click="activeTab='warning'" :class="activeTab==='warning' ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'text-white/60 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all text-sm font-bold">
                        <i class="bi bi-shield-fill-exclamation"></i> Cảnh báo
                    </button>
                    <button @click="activeTab='discussion'" :class="activeTab==='discussion' ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20' : 'text-white/60 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all text-sm font-bold">
                        <i class="bi bi-chat-text-fill"></i> Thảo luận
                    </button>
                    <button @click="activeTab='experience'" :class="activeTab==='experience' ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' : 'text-white/60 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all text-sm font-bold">
                        <i class="bi bi-gem"></i> Kinh nghiệm
                    </button>
                    <button @click="activeTab='question'" :class="activeTab==='question' ? 'bg-yellow-500/10 text-yellow-500 border border-yellow-500/20' : 'text-white/60 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all text-sm font-bold">
                        <i class="bi bi-patch-question-fill"></i> Hỏi đáp
                    </button>
                </nav>
            </div>

            <div class="glass-dropdown rounded-3xl p-6 border border-white/5 bg-gradient-to-br from-cyan-400/5 to-transparent">
                <h4 class="text-xs font-black text-white/80 mb-4">THỐNG KÊ CỘNG ĐỒNG</h4>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-[11px] text-white/40 font-bold uppercase">Chủ đề</span>
                        <span class="text-sm font-black text-white" x-text="posts.length"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[11px] text-white/40 font-bold uppercase">Lượt tương tác</span>
                        <span class="text-sm font-black text-white" x-text="Array.isArray(posts) ? posts.reduce((a, b) => a + (b.likes_count || 0), 0) : 0"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[11px] text-white/40 font-bold uppercase">Bình luận</span>
                        <span class="text-sm font-black text-white" x-text="Array.isArray(posts) ? posts.reduce((a, b) => a + (b.comments_count || 0), 0) : 0"></span>
                    </div>
                </div>
            </div>

            <!-- Trending Posts -->
            <div class="glass-dropdown rounded-3xl p-5 border border-white/5 bg-gradient-to-br from-amber-500/5 to-transparent">
                <h4 class="text-xs font-black text-amber-400/80 mb-4 flex items-center gap-2"><i class="bi bi-fire"></i> XU HƯỚNG</h4>
                <div class="space-y-3">
                    <template x-for="(tp, idx) in trendingPosts()" :key="'t'+tp.id">
                        <a :href="'/forum/' + tp.id + '/'" class="flex items-start gap-3 group/t hover:bg-white/5 rounded-xl p-2 -mx-2 transition-all">
                            <span class="text-lg font-black text-white/10 group-hover/t:text-cyan-400/40 transition-colors w-6 text-center shrink-0" x-text="idx + 1"></span>
                            <div class="min-w-0">
                                <p class="text-xs font-bold text-white/70 group-hover/t:text-cyan-400 transition-colors line-clamp-2 leading-snug" x-text="tp.title"></p>
                                <div class="flex items-center gap-3 mt-1.5 text-[10px] text-white/30">
                                    <span><i class="bi bi-heart-fill text-red-500/50 mr-1"></i><span x-text="tp.likes_count"></span></span>
                                    <span><i class="bi bi-chat-left-text mr-1"></i><span x-text="tp.comments_count"></span></span>
                                    <span><i class="bi bi-eye mr-1"></i><span x-text="tp.views_count || 0"></span></span>
                                </div>
                            </div>
                        </a>
                    </template>
                </div>
            </div>
        </div>

        <!-- Thread List Area -->
        <div class="lg:col-span-9 space-y-6" data-aos="fade-up" data-aos-delay="400">
            <!-- Search Bar -->
            <div class="relative group">
                <i class="bi bi-search absolute left-5 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-cyan-400 transition-colors"></i>
                <input type="text" x-model="searchQuery" placeholder="Tìm kiếm kinh nghiệm, cảnh báo giả mạo..." 
                    class="w-full bg-white/5 border border-white/10 rounded-3xl py-4 pl-14 pr-6 text-white focus:outline-none focus:border-cyan-400/30 transition-all font-medium">
            </div>

            <!-- Sort Options -->
            <div class="flex items-center gap-2 flex-wrap">
                <span class="text-[10px] uppercase font-black tracking-widest text-white/20 mr-2">Sắp xếp</span>
                <button @click="sortBy='newest'" :class="sortBy==='newest' ? 'bg-cyan-500/15 text-cyan-400 border-cyan-500/30' : 'bg-white/5 text-white/40 border-white/10 hover:bg-white/10'" class="px-4 py-2 rounded-xl text-xs font-bold border transition-all flex items-center gap-1.5">
                    <i class="bi bi-clock"></i> Mới nhất
                </button>
                <button @click="sortBy='popular'" :class="sortBy==='popular' ? 'bg-red-500/15 text-red-400 border-red-500/30' : 'bg-white/5 text-white/40 border-white/10 hover:bg-white/10'" class="px-4 py-2 rounded-xl text-xs font-bold border transition-all flex items-center gap-1.5">
                    <i class="bi bi-heart"></i> Phổ biến
                </button>
                <button @click="sortBy='discussed'" :class="sortBy==='discussed' ? 'bg-purple-500/15 text-purple-400 border-purple-500/30' : 'bg-white/5 text-white/40 border-white/10 hover:bg-white/10'" class="px-4 py-2 rounded-xl text-xs font-bold border transition-all flex items-center gap-1.5">
                    <i class="bi bi-chat-left-text"></i> Nhiều thảo luận
                </button>
                <button @click="sortBy='views'" :class="sortBy==='views' ? 'bg-amber-500/15 text-amber-400 border-amber-500/30' : 'bg-white/5 text-white/40 border-white/10 hover:bg-white/10'" class="px-4 py-2 rounded-xl text-xs font-bold border transition-all flex items-center gap-1.5">
                    <i class="bi bi-eye"></i> Nhiều lượt xem
                </button>
            </div>

            <!-- Posts -->
            <div class="grid gap-4">
                <template x-for="post in filteredPosts()" :key="post.id">
                    <div class="forum-card rounded-3xl p-6 relative overflow-hidden group cursor-pointer" @click="window.location.href='/forum/' + post.id + '/'">
                        <div x-show="post.is_pinned" class="absolute top-0 right-0 px-4 py-1 bg-yellow-500/20 text-yellow-500 text-[9px] font-black uppercase tracking-widest border-b border-l border-yellow-500/20 rounded-bl-xl">
                            <i class="bi bi-pin-angle-fill"></i> Đang ghim
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-6">
                            <!-- Left Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-4">
                                    <a @click.stop :href="'/profile/@' + post.author_username + '/'" class="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-400/20 to-purple-500/20 flex items-center justify-center border border-white/5 relative overflow-hidden shrink-0 hover:scale-110 transition-transform">
                                        <template x-if="post.author_avatar">
                                            <img :src="post.author_avatar" class="w-full h-full object-cover">
                                        </template>
                                        <template x-if="!post.author_avatar">
                                            <span class="text-xs font-bold text-cyan-400" x-text="getInitial(post.author_name)"></span>
                                        </template>
                                    </a>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <a @click.stop :href="'/profile/@' + post.author_username + '/'" class="text-sm font-bold text-white/90 hover:text-cyan-400 transition-colors" x-text="post.author_name"></a>
                                            <i x-show="post.author_is_staff" class="bi bi-patch-check-fill verified-badge" title="Quản trị viên"></i>
                                        </div>
                                        <div class="flex items-center gap-2 text-[10px] font-medium text-white/30">
                                            <span x-text="timeAgo(post.created_at) + ' trước'"></span>
                                            <span>•</span>
                                            <span :class="categoryInfo(post.category).color" class="category-tag" x-text="categoryInfo(post.category).label"></span>
                                        </div>
                                    </div>
                                </div>

                                <a :href="'/forum/' + post.id + '/'" class="inline-block group-hover:translate-x-1 transition-transform mb-4">
                                    <h2 class="text-xl font-bold text-white mb-2 leading-tight group-hover:text-cyan-400 transition-colors" x-text="post.title"></h2>
                                    <p class="text-sm text-white/50 line-clamp-2 leading-relaxed" x-text="post.content"></p>
                                </a>

                                <div class="flex flex-wrap items-center gap-4 mt-2 pt-4 border-t border-white/5">
                                    <div class="flex items-center gap-1">
                                        <button @click.stop="toggleLike(post)" class="reaction-btn px-3 py-1.5 rounded-xl flex items-center gap-2" :class="post.user_liked ? 'active-red' : 'text-white/30'">
                                            <i class="bi" :class="post.user_liked ? 'bi-heart-fill' : 'bi-heart'"></i>
                                            <span class="text-xs font-black" x-text="post.likes_count"></span>
                                        </button>
                                        <button @click.stop="toggleReaction(post, 'helpful')" class="reaction-btn px-3 py-1.5 rounded-xl flex items-center gap-2" :class="post.user_helpful ? 'active' : 'text-white/30'">
                                            <i class="bi" :class="post.user_helpful ? 'bi-patch-check-fill' : 'bi-patch-check'"></i>
                                            <span class="text-xs font-black" x-text="post.helpful_count"></span>
                                        </button>
                                        <button @click.stop="toggleReaction(post, 'share')" class="reaction-btn px-3 py-1.5 rounded-xl flex items-center gap-2" :class="post.user_shared ? 'active' : 'text-white/30'">
                                            <i class="bi bi-share-fill"></i>
                                            <span class="text-xs font-black" x-text="post.shares_count"></span>
                                        </button>
                                    </div>

                                    <div class="h-4 w-[1px] bg-white/5 mx-1"></div>

                                    <a :href="'/forum/' + post.id + '/'" class="flex items-center gap-2 text-white/30 hover:text-white transition-colors">
                                        <i class="bi bi-chat-left-text"></i>
                                        <span class="text-[11px] font-bold" x-text="post.comments_count"></span>
                                    </a>

                                    <div class="flex items-center gap-2 text-white/20">
                                        <i class="bi bi-eye"></i>
                                        <span class="text-[11px] font-bold" x-text="post.views_count || 0"></span>
                                    </div>

                                    <button @click.stop="reportPost(post)" class="ml-auto flex items-center gap-2 text-white/20 hover:text-red-500 transition-all text-[11px] font-bold">
                                        <i class="bi bi-flag"></i> Báo cáo
                                    </button>
                                </div>
                            </div>

                            <!-- Right Media -->
                            <template x-if="post.image">
                                <div class="sm:w-36 h-36 rounded-2xl overflow-hidden border border-white/5 flex-shrink-0">
                                    <img :src="post.image" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredPosts().length === 0" class="glass-dropdown rounded-[40px] p-20 text-center border border-white/5">
                    <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="bi bi-search text-4xl text-white/20"></i>
                    </div>
                    <h3 class="text-2xl font-black text-white/80">Không có dữ liệu</h3>
                    <p class="text-white/40 mt-3 font-medium">Chúng tôi không tìm thấy kết quả nào phù hợp.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}