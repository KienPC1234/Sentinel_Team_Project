{% extends "base.html" %}
{% block title %}Diễn đàn cộng đồng{% endblock %}
{% block head_extra %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('forumApp', () => ({
        activeTab: 'all',
        searchQuery: '',
        showCreate: false,
        posts: {{ posts_json|safe }},
        newPost: {title:'', content:'', category:'discussion', image: null},
        loading: false,
        
        async createPost() {
            if(!this.newPost.title.trim() || !this.newPost.content.trim()) return;
            this.loading = true;
            
            const tsToken = document.querySelector('[name=cf-turnstile-response]').value;
            if(!tsToken){showToast('Vui lòng hoàn thành xác minh anti-spam', 'warning');return}

            const formData = new FormData();
            formData.append('title', this.newPost.title);
            formData.append('content', this.newPost.content);
            formData.append('category', this.newPost.category);
            formData.append('cf-turnstile-response', tsToken);
            if (this.$refs.postImage && this.$refs.postImage.files[0]) {
                formData.append('image', this.$refs.postImage.files[0]);
            }

            try {
                const resp = await fetch('/api/v1/forum/posts/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCSRFToken()},
                    body: formData
                });
                if(resp.ok) {
                    const post = await resp.json();
                    this.posts.unshift(post);
                    this.newPost = {title:'', content:'', category:'discussion', image: null};
                    if(this.$refs.postImage) this.$refs.postImage.value = '';
                    this.showCreate = false;
                    showToast('Đăng bài thành công!', 'success');
                } else { 
                    const err = await resp.json();
                    showToast(err.error || 'Lỗi khi đăng bài', 'error'); 
                }
            } catch(e) { showToast('Lỗi kết nối', 'error'); }
            this.loading = false;
        },
        async toggleLike(post) {
            try {
                const resp = await fetch('/api/v1/forum/posts/' + post.id + '/like/', {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCSRFToken()}
                });
                if(resp.ok) {
                    const data = await resp.json();
                    post.likes_count = data.likes_count;
                    post.user_liked = data.liked;
                }
            } catch(e) {}
        },
        filteredPosts() {
            let filtered = this.posts;
            if(this.activeTab !== 'all') filtered = filtered.filter(p => p.category === this.activeTab);
            if(this.searchQuery.trim()) {
                const q = this.searchQuery.toLowerCase();
                filtered = filtered.filter(p => p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q));
            }
            return filtered;
        },
        timeAgo(dt) {
            const diff = (Date.now() - new Date(dt)) / 1000;
            if(diff < 60) return 'Vừa xong';
            if(diff < 3600) return Math.floor(diff/60) + ' phút trước';
            if(diff < 86400) return Math.floor(diff/3600) + ' giờ trước';
            return Math.floor(diff/86400) + ' ngày trước';
        },
        categoryLabel(cat) {
            const map = {warning:'Cảnh báo', discussion:'Thảo luận', experience:'Kinh nghiệm', question:'Hỏi đáp'};
            return map[cat] || cat;
        },
        categoryIcon(cat) {
            const map = {warning:'bi-exclamation-octagon-fill', discussion:'bi-chat-dots-fill', experience:'bi-book-half', question:'bi-question-circle-fill'};
            return map[cat] || 'bi-chat-fill';
        },
        categoryColor(cat) {
            const map = {warning:'var(--risk-red)', discussion:'var(--accent-cyan)', experience:'var(--accent-purple)', question:'var(--risk-yellow)'};
            return map[cat] || 'var(--text-muted)';
        }
    }));
});
</script>
{% endblock %}

{% block content %}
<div class="animate-fadein" x-data="forumApp">
    <!-- Page Header -->
    <div class="mb-8 text-center sm:text-left">
        <h1 class="text-3xl font-extrabold flex items-center justify-center sm:justify-start gap-4">
            <span class="avatar-pill"><i class="bi bi-people-fill"></i></span>
            <span class="glow-text">Diễn đàn cộng đồng</span>
        </h1>
        <p class="text-white/60 mt-2 ml-1">Chia sẻ trải nghiệm, cảnh báo lừa đảo & chung tay bảo vệ cộng đồng</p>
    </div>

    <!-- Forum Grid -->
    <div class="forum-grid">
        <!-- Sidebar Navigation -->
        <aside class="forum-sidebar space-y-4">
            <div class="liquid-card p-6">
                <h3 class="font-bold text-white/90 mb-4 uppercase text-xs tracking-widest">Danh mục</h3>
                <nav class="flex flex-col gap-1">
                    <button @click="activeTab='all'" 
                        :class="activeTab==='all' ? 'bg-white/10 text-cyan-400' : 'text-white/60 hover:bg-white/5'"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm">
                        <i class="bi bi-grid-fill"></i> Tất cả bài viết
                    </button>
                    <button @click="activeTab='warning'" 
                        :class="activeTab==='warning' ? 'bg-white/10 text-red-400' : 'text-white/60 hover:bg-white/5'"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm">
                        <i class="bi bi-exclamation-octagon-fill"></i> Cảnh báo lừa đảo
                    </button>
                    <button @click="activeTab='discussion'" 
                        :class="activeTab==='discussion' ? 'bg-white/10 text-cyan-400' : 'text-white/60 hover:bg-white/5'"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm">
                        <i class="bi bi-chat-dots-fill"></i> Thảo luận chung
                    </button>
                    <button @click="activeTab='experience'" 
                        :class="activeTab==='experience' ? 'bg-white/10 text-purple-400' : 'text-white/60 hover:bg-white/5'"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm">
                        <i class="bi bi-book-half"></i> Chia sẻ kinh nghiệm
                    </button>
                    <button @click="activeTab='question'" 
                        :class="activeTab==='question' ? 'bg-white/10 text-yellow-400' : 'text-white/60 hover:bg-white/5'"
                        class="flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm">
                        <i class="bi bi-question-circle-fill"></i> Hỏi đáp hỗ trợ
                    </button>
                </nav>
            </div>
            
            <div class="liquid-card p-6 bg-gradient-to-br from-cyan-500/10 to-transparent">
                <h3 class="font-bold text-white/90 mb-2 uppercase text-xs tracking-widest">Hoạt động</h3>
                <div class="flex items-center justify-between text-sm py-2 border-b border-white/5">
                    <span class="text-white/50">Bài viết mới</span>
                    <span class="text-white font-medium" x-text="posts.length"></span>
                </div>
                <div class="flex items-center justify-between text-sm py-2">
                    <span class="text-white/50">Lượt tương tác</span>
                    <span class="text-white font-medium" x-text="posts.reduce((a, b) => a + (b.likes_count || 0), 0)"></span>
                </div>
            </div>
        </aside>

        <!-- Main Feed -->
        <div class="space-y-6">
            <!-- Search & Actions -->
            <div class="flex items-center gap-3">
                <div class="relative flex-1 group">
                    <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-cyan-400 transition-colors"></i>
                    <input type="text" x-model="searchQuery" placeholder="Tìm kiếm kinh nghiệm, cảnh báo..." 
                        class="liquid-input w-full pl-11 bg-white/5 border-white/10 focus:border-cyan-400/50">
                </div>
                {% if user.is_authenticated %}
                <button @click="showCreate = !showCreate" 
                    class="liquid-btn shrink-0" 
                    :class="showCreate ? 'bg-red-500/20 border-red-500/30 text-red-400' : 'bg-cyan-500/20 border-cyan-500/30 text-cyan-400'">
                    <i class="bi" :class="showCreate ? 'bi-x-lg' : 'bi-plus-lg'"></i>
                    <span x-text="showCreate ? 'Hủy' : 'Viết bài'"></span>
                </button>
                {% endif %}
            </div>

            <!-- Create Post Form -->
            <div x-show="showCreate" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4"
                class="liquid-card p-6 border-cyan-500/20">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-3">
                    <i class="bi bi-pencil-square text-cyan-400"></i> Chia sẻ với cộng đồng
                </h2>
                <div class="grid gap-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-white/50 ml-1">DANH MỤC</label>
                            <select x-model="newPost.category" class="liquid-input w-full appearance-none">
                                <option value="warning">⛔ Cảnh báo lừa đảo</option>
                                <option value="discussion">Thảo luận chung</option>
                                <option value="experience">Chia sẻ kinh nghiệm</option>
                                <option value="question">Hỏi đáp hỗ trợ</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-white/50 ml-1">ẢNH MINH HỌA (TÙY CHỌN)</label>
                            <input type="file" x-ref="postImage" accept="image/*" class="liquid-input w-full p-2 text-xs">
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-white/50 ml-1">TIÊU ĐỀ</label>
                        <input type="text" x-model="newPost.title" placeholder="Tiêu đề thu hút sự chú ý..." class="liquid-input w-full">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-white/50 ml-1">NỘI DUNG</label>
                        <textarea x-model="newPost.content" placeholder="Mô tả kỹ chi tiết vụ việc hoặc chia sẻ của bạn..." class="liquid-input w-full min-height-[120px] resize-none"></textarea>
                    </div>
                    </div>
                    <!-- Turnstile Widget -->
                    <div class="mt-4 flex justify-center">
                        <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITEKEY }}" data-theme="dark"></div>
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button @click="showCreate = false" class="text-white/50 px-4 py-2 hover:text-white transition-colors">Hủy bỏ</button>
                        <button @click="createPost()" :disabled="loading" class="liquid-btn bg-cyan-500/20 border-cyan-500/50 text-cyan-400 min-w-[140px] justify-center">
                            <i x-show="!loading" class="bi bi-send-fill"></i>
                            <span x-show="loading" class="spinner border-2 w-4 h-4"></span>
                            <span x-text="loading ? 'Đang đăng...' : 'Đăng bài viết'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Posts List -->
            <div class="space-y-4">
                <template x-for="post in filteredPosts()" :key="post.id">
                    <div class="liquid-card hover:bg-white/[0.07]">
                        <div class="p-6">
                            <!-- Post Metadata -->
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="avatar-pill" x-text="post.author_name[0].toUpperCase()"></div>
                                    <div>
                                        <div class="font-bold text-white/90" x-text="post.author_name"></div>
                                        <div class="text-[10px] text-white/40 flex items-center gap-2">
                                            <span x-text="timeAgo(post.created_at)"></span>
                                            <span>•</span>
                                            <span :style="'color:' + categoryColor(post.category)" class="uppercase font-bold tracking-tighter" x-text="categoryLabel(post.category)"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <span x-show="post.is_pinned" class="bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded-full text-[10px] font-bold border border-yellow-500/30 flex items-center gap-1">
                                        <i class="bi bi-pin-angle-fill"></i> NỔI BẬT
                                    </span>
                                </div>
                            </div>

                            <!-- Post Content -->
                            <div class="flex gap-6">
                                <div class="flex-1">
                                    <a :href="'/forum/' + post.id + '/'" class="group">
                                        <h3 class="text-xl font-bold text-white group-hover:text-cyan-400 transition-colors mb-2" x-text="post.title"></h3>
                                        <p class="text-white/60 text-sm line-clamp-3 leading-relaxed mb-4" x-text="post.content"></p>
                                    </a>

                                    <!-- Actions & Stats -->
                                    <div class="flex items-center gap-6 mt-auto">
                                        <button @click="toggleLike(post)" class="flex items-center gap-2 transition-all hover:scale-110" :class="post.user_liked ? 'text-red-500' : 'text-white/40 hover:text-red-400'">
                                            <i class="bi" :class="post.user_liked ? 'bi-heart-fill' : 'bi-heart'"></i>
                                            <span class="text-xs font-bold" x-text="post.likes_count"></span>
                                        </button>
                                        <a :href="'/forum/' + post.id + '/'" class="flex items-center gap-2 text-white/40 hover:text-cyan-400 transition-all">
                                            <i class="bi bi-chat-text"></i>
                                            <span class="text-xs font-bold" x-text="post.comments_count + ' bình luận'"></span>
                                        </a>
                                        <div class="flex items-center gap-2 text-white/30 ml-auto">
                                            <i class="bi bi-eye"></i>
                                            <span class="text-[10px] font-bold" x-text="post.views_count"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Post Image Thumbnail -->
                                <template x-if="post.image">
                                    <div class="hidden sm:block w-32 h-32 rounded-2xl overflow-hidden shrink-0 border border-white/10 group-hover:border-white/20 transition-all">
                                        <img :src="post.image" alt="Post thumbnail" class="w-full h-full object-cover">
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredPosts().length === 0" class="liquid-glass rounded-3xl p-12 text-center">
                    <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="bi bi-mailbox2 text-4xl text-white/20"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white/80">Không tìm thấy bài viết nào</h3>
                    <p class="text-white/40 mt-2">Dường như chưa có chia sẻ nào về nội dung này.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}