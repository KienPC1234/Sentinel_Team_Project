{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ShieldCall VN{% endblock %} | ShieldCall VN</title>
    {% block meta %}
    <meta name="description" content="{% block meta_description %}Nền tảng bảo vệ người dùng Việt Nam khỏi cuộc gọi lừa đảo và các hình thức lừa đảo số{% endblock %}">
    <meta property="og:title" content="{% block og_title %}{{ title }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Nền tảng bảo vệ người dùng Việt Nam khỏi cuộc gọi lừa đảo và các hình thức lừa đảo số{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'icon.png' %}{% endblock %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% endblock %}

    <link rel="icon" type="image/png" href="{% static 'logo.png' %}">
    <link rel="stylesheet" href="{% static 'css/liquid-glass.css' %}">
    <style>#onesignal-bell-container { display: none !important; }</style>

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    {% tailwind_css %}

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Animate.css & AOS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/47.5.0/ckeditor5.css" crossorigin>
    <script src="https://cdn.ckeditor.com/ckeditor5/47.5.0/ckeditor5.umd.js" crossorigin></script>

    {% block head_extra %}{% endblock %}
    <script>
        window.createCKEditor = async function(selector, initialData, placeholder = 'Nhập nội dung...') {
            if (!window.CKEDITOR) {
                console.error('CKEditor not loaded yet');
                return null;
            }

            const {
                ClassicEditor, Autosave, Essentials, Paragraph, ImageBlock, ImageToolbar,
                Bold, CloudServices, ImageUpload, ImageInsertViaUrl, AutoImage, Table,
                TableToolbar, ImageTextAlternative, ImageCaption, ImageStyle, ImageInline,
                Italic, List, MediaEmbed, TableCaption, TodoList, Underline, ImageUtils,
                ImageEditing, Mention, Superscript, Subscript, Strikethrough, Highlight,
                Heading, Link, AutoLink, BlockQuote, HorizontalLine, CodeBlock, Indent,
                IndentBlock, Alignment, Style, GeneralHtmlSupport
            } = window.CKEDITOR;

            const LICENSE_KEY = '{{ CKEDITOR_LICENSE_KEY|escapejs }}';
            
            const editorConfig = {
                licenseKey: LICENSE_KEY || 'GPL', // Fallback to GPL if no key
                placeholder,
                plugins: [
                    Alignment, AutoImage, AutoLink, Autosave, BlockQuote, Bold,
                    CloudServices, CodeBlock, Essentials, GeneralHtmlSupport, Heading,
                    Highlight, HorizontalLine, ImageBlock, ImageCaption, ImageEditing,
                    ImageInline, ImageInsertViaUrl, ImageStyle, ImageTextAlternative,
                    ImageToolbar, ImageUpload, ImageUtils, Indent, IndentBlock, Italic,
                    Link, List, MediaEmbed, Mention, Paragraph, Strikethrough,
                    Style, Subscript, Superscript, Table, TableCaption, TableToolbar,
                    TodoList, Underline
                ],
                toolbar: {
                    items: [
                        'undo', 'redo', '|',
                        'heading', 'style', '|',
                        'bold', 'italic', 'underline', 'strikethrough', 'subscript', 'superscript', '|',
                        'horizontalLine', 'link', 'mediaEmbed', 'insertTable', 'highlight', 'blockQuote', 'codeBlock', '|',
                        'alignment', '|',
                        'bulletedList', 'numberedList', 'todoList', 'outdent', 'indent'
                    ],
                    shouldNotGroupWhenFull: false
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' },
                        { model: 'heading5', view: 'h5', title: 'Heading 5', class: 'ck-heading_heading5' },
                        { model: 'heading6', view: 'h6', title: 'Heading 6', class: 'ck-heading_heading6' }
                    ]
                },
                htmlSupport: {
                    allow: [
                        { name: /^.*$/, styles: true, attributes: true, classes: true }
                    ]
                },
                image: {
                    toolbar: ['toggleImageCaption', 'imageTextAlternative', '|', 'imageStyle:inline', 'imageStyle:wrapText', 'imageStyle:breakText']
                },
                link: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://',
                    decorators: {
                        toggleDownloadable: {
                            mode: 'manual',
                            label: 'Downloadable',
                            attributes: { download: 'file' }
                        }
                    }
                },
                mention: {
                    feeds: [
                        {
                            marker: '@',
                            feed: async (query) => {
                                if (query.length < 1) return [];
                                try {
                                    const response = await fetch(`/api/v1/utils/mentions/?query=${encodeURIComponent(query)}`);
                                    return await response.json();
                                } catch (error) {
                                    console.error('Mention fetch failed:', error);
                                    return [];
                                }
                            },
                            minimumCharacters: 1,
                            itemRenderer: (item) => {
                                const container = document.createElement('div');
                                container.classList.add('flex', 'items-center', 'gap-3', 'p-1');
                                
                                const avatar = document.createElement('div');
                                avatar.classList.add('w-8', 'h-8', 'rounded-lg', 'bg-white/5', 'overflow-hidden', 'flex-shrink-0');
                                if (item.avatar) {
                                    avatar.innerHTML = `<img src="${item.avatar}" class="w-full h-full object-cover">`;
                                } else {
                                    avatar.innerHTML = `<div class="w-full h-full flex items-center justify-center text-[10px] font-black bg-cyan-500/20 text-cyan-400">${item.name[0].toUpperCase()}</div>`;
                                }
                                
                                const info = document.createElement('div');
                                info.classList.add('flex', 'flex-col');
                                info.innerHTML = `<span class="text-sm font-bold text-white">${item.name}</span><span class="text-[10px] text-white/40 font-medium">${item.id}</span>`;
                                
                                container.appendChild(avatar);
                                container.appendChild(info);
                                return container;
                            }
                        }
                    ]
                },
                style: {
                    definitions: [
                        { name: 'Article category', element: 'h3', classes: ['category'] },
                        { name: 'Title', element: 'h2', classes: ['document-title'] },
                        { name: 'Subtitle', element: 'h3', classes: ['document-subtitle'] },
                        { name: 'Info box', element: 'p', classes: ['info-box'] },
                        { name: 'CTA Link Primary', element: 'a', classes: ['button', 'button--green'] },
                        { name: 'CTA Link Secondary', element: 'a', classes: ['button', 'button--black'] },
                        { name: 'Marker', element: 'span', classes: ['marker'] },
                        { name: 'Spoiler', element: 'span', classes: ['spoiler'] }
                    ]
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                }
            };

            if (initialData) {
                editorConfig.initialData = initialData;
            }

            const element = document.querySelector(selector);
            if (!element) {
                console.error('Editor element not found:', selector);
                return null;
            }
            
            return ClassicEditor.create(element, editorConfig);
        };

        window.renderMd = function(text) {
            if (!text) return '';
            let cleanText = String(text).trim();
            // Strip LLM thinking tags <think>...</think>
            cleanText = cleanText.replace(/<think>[\s\S]*?<\/think>/gi, '');
            // Strip partial/unclosed <think> tag at the end (during streaming)
            cleanText = cleanText.replace(/<think>[\s\S]*$/gi, '');
            // Strip __STATUS__:xxx markers from stream
            cleanText = cleanText.replace(/__STATUS__:\w+/g, '');
            cleanText = cleanText.trim();
            if (!cleanText) return '';
            try { 
                return marked.parse(cleanText, { 
                    breaks: true, 
                    gfm: true
                }); 
            } catch(e) { 
                console.error('Markdown rendering error:', e);
                return cleanText; 
            }
        };

        window.renderRichText = function(data) {
            if (!data) return '';
            
            // Check if it's Editor.js JSON
            if (typeof data === 'string' && (data.trim().startsWith('{') || data.trim().startsWith('['))) {
                try {
                    const parsed = JSON.parse(data);
                    if (parsed.blocks) {
                        return window.processMentions(window.renderEditorJS(parsed));
                    }
                } catch(e) {}
            }
            
            // Reverted to HTML output from CKEditor, process mentions and return
            return window.processMentions(data);
        };
        
        // Process @mentions in content and convert to profile links
        window.processMentions = function(html) {
            if (!html) return '';
            // Match @username patterns (CKEditor uses <span class="mention" data-mention="@username">@username</span>)
            // Also match plain text @username patterns
            return html
                // Handle CKEditor mention spans
                .replace(/<span[^>]*class="[^"]*mention[^"]*"[^>]*data-mention="@([^"]+)"[^>]*>([^<]*)<\/span>/gi, 
                    '<a href="/profile/@$1/" class="mention-link text-cyan-400 hover:text-white transition-colors font-bold">$2</a>')
                // Handle plain text @username that is not already in a link
                .replace(/(?<!href="[^"]*|>)@([a-zA-Z0-9_]+)(?![^<]*<\/a>)/g, 
                    '<a href="/profile/@$1/" class="mention-link text-cyan-400 hover:text-white transition-colors font-bold">@$1</a>');
        };

        window.renderEditorJS = function(data) {
            if (!data) return '';
            try {
                let parsedData = data;
                if (typeof data === 'string') {
                    try { parsedData = JSON.parse(data); } catch(e) { return data; }
                }
                const blocks = parsedData.blocks;
                if (!blocks || !Array.isArray(blocks)) return typeof data === 'string' ? data : '';
                
                let html = '';
                blocks.forEach(block => {
                    switch (block.type) {
                        case 'header':
                            html += `<h${block.data.level} class="text-white font-black my-4">${block.data.text}</h${block.data.level}>`;
                            break;
                        case 'paragraph':
                            html += `<p class="my-3 text-white/70 leading-relaxed">${block.data.text}</p>`;
                            break;
                        case 'list':
                            const tag = block.data.style === 'ordered' ? 'ol' : 'ul';
                            const listClass = block.data.style === 'ordered' ? 'list-decimal' : 'list-disc';
                            html += `<${tag} class="${listClass} ml-6 my-4 text-white/70">`;
                            block.data.items.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += `</${tag}>`;
                            break;
                        case 'quote':
                            html += `<blockquote class="border-l-4 border-cyan-500 pl-4 my-6 italic text-white/60 bg-white/5 py-4 rounded-r-xl">${block.data.text}${block.data.caption ? `<footer class="mt-2 text-xs font-black uppercase tracking-widest">— ${block.data.caption}</footer>` : ''}</blockquote>`;
                            break;
                        case 'raw':
                            html += `<div class="raw-html my-6 p-4 rounded-xl bg-black/20 border border-white/5 text-xs text-white/40">${block.data.html}</div>`;
                            break;
                        case 'checklist':
                            html += `<div class="my-4 space-y-2">`;
                            block.data.items.forEach(item => {
                                html += `<div class="flex items-center gap-2"><i class="bi ${item.checked ? 'bi-check-square-fill text-cyan-400' : 'bi-square text-white/20'}"></i> <span class="${item.checked ? 'text-white/40 line-through' : 'text-white/70'}">${item.text}</span></div>`;
                            });
                            html += `</div>`;
                            break;
                        case 'link':
                            html += `<a href="${block.data.link}" target="_blank" class="block p-4 my-4 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all">
                                <p class="text-sm font-bold text-white mb-1">${block.data.meta?.title || block.data.link}</p>
                                <p class="text-xs text-white/40 truncate">${block.data.meta?.description || ''}</p>
                            </a>`;
                            break;
                        case 'image':
                            const imgClass = block.data.stretched ? 'w-full' : 'max-w-full mx-auto';
                            const borderClass = block.data.withBorder ? 'border-4 border-white/10' : '';
                            const bgClass = block.data.withBackground ? 'bg-white/5 p-4 rounded-3xl' : '';
                            html += `<div class="my-8 ${bgClass}">
                                <img src="${block.data.file.url}" class="${imgClass} ${borderClass} rounded-2xl shadow-2xl" alt="${block.data.caption || 'Image'}">
                                ${block.data.caption ? `<p class="mt-3 text-center text-xs text-white/40 italic font-medium uppercase tracking-widest">${block.data.caption}</p>` : ''}
                            </div>`;
                            break;
                        case 'embed':
                            html += `<div class="my-8 rounded-3xl overflow-hidden border border-white/10 shadow-2xl bg-black/40">
                                <div class="aspect-video">
                                    <iframe src="${block.data.embed}" width="100%" height="100%" frameborder="0" allowfullscreen class="w-full h-full"></iframe>
                                </div>
                                ${block.data.caption ? `<div class="p-4 bg-white/5 border-t border-white/5 text-center text-xs text-white/40 italic font-medium uppercase tracking-widest">${block.data.caption}</div>` : ''}
                            </div>`;
                            break;
                        default:
                            console.log('Unknown block type', block.type);
                    }
                });
                return html;
            } catch (e) {
                console.error('EditorJS Render Error:', e);
                return typeof data === 'string' ? data : '';
            }
        };

        // Premium Notification System
        window.showAlert = function(title, text, icon = 'info') {
            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                background: document.documentElement.getAttribute('data-theme') === 'dark' ? '#161235' : '#fff',
                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#fff' : '#1a1a2e',
                confirmButtonColor: '#18ffff',
                borderRadius: '1.25rem',
                customClass: {
                    popup: 'liquid-card border-white/10'
                }
            });
        };

        window.showToast = function(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                background: document.documentElement.getAttribute('data-theme') === 'dark' ? '#161235' : '#fff',
                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#fff' : '#1a1a2e',
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            Toast.fire({
                icon: type,
                title: message
            });
        };
    </script>

    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // Global utility for phone normalization
        window.formatPhoneNumber = function(phone) {
            if (!phone) return '';
            let cleaned = phone.toString().trim().replace(/[\s().-]/g, '');
            if (cleaned.startsWith('0') && !cleaned.startsWith('00')) {
                cleaned = '+84' + cleaned.substring(1);
            }
            if (!cleaned.startsWith('+')) {
                cleaned = '+' + cleaned;
            }
            return cleaned;
        };

        document.addEventListener('alpine:init', () => {
            Alpine.data('liquidSelect', (config = {}) => ({
                open: false,
                value: config.value || '',
                _staticOptions: Array.isArray(config.options) ? config.options : [],
                
                get options() {
                    if (typeof config.options === 'function') return config.options();
                    return this._staticOptions;
                },

                get label() {
                    const opts = this.options || [];
                    const selected = opts.find(o => o.value === this.value);
                    return selected ? selected.label : (config.placeholder || 'Chọn một tùy chọn');
                },

                init() {
                    this.$watch('value', (v) => {
                        const nativeSelect = this.$el.querySelector('select');
                        if (nativeSelect && nativeSelect.value !== v) {
                            nativeSelect.value = v;
                        }
                    });

                    this.$watch('open', (isOpen) => {
                        const card = this.$el.closest('.liquid-card, [data-aos], .grid');
                        if (card) {
                            if (isOpen) card.classList.add('z-elevated');
                            else card.classList.remove('z-elevated');
                        }
                    });

                    window.addEventListener('click', (e) => {
                        if (this.open && !this.$el.contains(e.target)) this.open = false;
                    });
                },
                
                select(option) {
                    this.value = option.value;
                    this.open = false;
                    this.$dispatch('change', this.value);
                    
                    const nativeSelect = this.$el.querySelector('select');
                    if (nativeSelect) {
                        nativeSelect.value = this.value;
                        nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }));
        });

        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({
                duration: 1000,
                easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                once: true,
                offset: 50
            });
        });
    </script>

    {% block extra_css %}{% endblock %}
</head>

<body x-data="{ 
    mobileMenu: false, 
    user: { 
        username: '{{ user.username|escapejs }}', 
        display_name: '{{ user.profile.display_name|escapejs }}',
        avatar: '{% if user.profile.avatar %}{{ user.profile.avatar.url|escapejs }}{% endif %}',
        rank: {{ user.profile.rank_info|safe|default:'{}' }}
    } 
}" @profile-updated.window="user = { ...user, ...$event.detail.user }">

    <div
        style="position:fixed;top:-200px;left:-200px;width:500px;height:500px;background:radial-gradient(circle,rgba(0,229,255,0.08) 0%,transparent 70%);pointer-events:none;z-index:0;">
    </div>
    <div
        style="position:fixed;bottom:-200px;right:-200px;width:500px;height:500px;background:radial-gradient(circle,rgba(179,136,255,0.08) 0%,transparent 70%);pointer-events:none;z-index:0;">
    </div>

    <!-- Frosted Filter SVG -->
    <svg style="visibility: hidden; position: absolute;" width="0" height="0">
        <filter id="frosted">
            <feTurbulence type="fractalNoise" baseFrequency="0.05" numOctaves="2" result="noise" />
            <feGaussianBlur in="SourceGraphic" stdDeviation="15" result="blur" />
            <feComposite operator="in" in="blur" in2="SourceGraphic" result="composite" />
            <feBlend mode="overlay" in="noise" in2="composite" />
        </filter>
    </svg>

    <!-- Navigation -->
    <nav class="nav-premium">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16 sm:h-20">
                <!-- Left: Logo & Links -->
                <div class="flex items-center gap-8">
                    <a href="/" class="flex items-center gap-3 group">
                        <div class="w-10 h-10 rounded-xl overflow-hidden bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center shadow-lg shadow-cyan-500/20 group-hover:scale-110 transition-transform">
                            <img src="{% static 'logo.png' %}" class="w-full h-full object-cover">
                        </div>
                        <div class="hidden sm:block mt-1.5">
                            <h2 class="text-lg font-black text-white leading-none tracking-tight">ShieldCall <span class="text-cyan-400">VN</span></h2>
                            <p class="text-[10px] text-white/30 font-bold uppercase tracking-widest mt-0.5">Community Guard</p>
                        </div>
                    </a>

                    <!-- Desktop Links -->
                    <div class="hidden lg:flex items-center gap-2">
                        <div class="relative group" x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false">
                            <button class="nav-link px-4 py-2 rounded-xl flex items-center gap-2" :class="open ? 'bg-white/5 text-cyan-400' : 'text-white/60'">
                                <i class="bi bi-search"></i> Kiểm tra <i class="bi bi-chevron-down text-[10px] opacity-50"></i>
                            </button>
                            <div x-show="open" x-transition class="absolute top-full left-0 mt-1 w-64 nav-scan-menu p-2 rounded-2xl">
                                <a href="/scan/phone/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl">
                                    <div class="w-8 h-8 rounded-lg bg-cyan-500/10 text-cyan-400 flex items-center justify-center"><i class="bi bi-phone"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Số điện thoại</div>
                                        <div class="text-[9px] text-white/40">Tra cứu SĐT rủi ro</div>
                                    </div>
                                </a>
                                <a href="/scan/message/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-purple-400">
                                    <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center"><i class="bi bi-chat-left-dots"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Tin nhắn</div>
                                        <div class="text-[9px] text-white/40">Phân tích nội dung AI</div>
                                    </div>
                                </a>
                                <a href="/scan/website/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-blue-400">
                                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center"><i class="bi bi-globe2"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Website</div>
                                        <div class="text-[9px] text-white/40">Phát hiện Phishing</div>
                                    </div>
                                </a>
                                <a href="/scan/bank/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-yellow-400">
                                    <div class="w-8 h-8 rounded-lg bg-yellow-500/10 flex items-center justify-center"><i class="bi bi-bank2"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Tài khoản</div>
                                        <div class="text-[9px] text-white/40">Tra cứu bank lừa đảo</div>
                                    </div>
                                </a>
                                <a href="/scan/email/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-pink-400">
                                    <div class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center"><i class="bi bi-envelope-check"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Email</div>
                                        <div class="text-[9px] text-white/40">Phát hiện Email Scam</div>
                                    </div>
                                </a>
                                <a href="/scan/qr/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-green-400">
                                    <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center"><i class="bi bi-qr-code-scan"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">QR / Ảnh</div>
                                        <div class="text-[9px] text-white/40">OCR + Phân tích ảnh</div>
                                    </div>
                                </a>
                                <a href="/scan/file/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-teal-400">
                                    <div class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center"><i class="bi bi-file-earmark-check"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Quét File</div>
                                        <div class="text-[9px] text-white/40">Phân tích bằng VirusTotal</div>
                                    </div>
                                </a>
                                <a href="/scan/audio/" class="nav-scan-item flex items-center gap-3 p-3 rounded-xl text-violet-400">
                                    <div class="w-8 h-8 rounded-lg bg-violet-500/10 flex items-center justify-center"><i class="bi bi-mic"></i></div>
                                    <div>
                                        <div class="text-xs font-black text-white">Âm Thanh</div>
                                        <div class="text-[9px] text-white/40">Phân tích hội thoại lừa đảo</div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <a href="/report/" class="nav-link px-4 py-2 rounded-xl text-white/60">Báo cáo</a>
                        <a href="/scam-radar/" class="nav-link px-4 py-2 rounded-xl text-white/60">Radar</a>
                        <a href="/forum/" class="nav-link px-4 py-2 rounded-xl text-white/60">Diễn đàn</a>
                        <a href="/learn/" class="nav-link px-4 py-2 rounded-xl text-white/60">Kiến thức</a>
                    </div>
                </div>

                <!-- Right: Auth & Emergency -->
                <div class="flex items-center gap-3">
                    <a href="/emergency/" class="nav-emergency hidden sm:flex items-center gap-2 bg-red-500/10 text-red-500 border border-red-500/20 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">
                        <i class="bi bi-exclamation-triangle-fill"></i> Hỗ trợ khẩn cấp
                    </a>

                    <div class="h-8 w-[1px] bg-white/10 mx-1 hidden lg:block"></div>
                    
                    <button @click="toggleTheme" class="p-2.5 rounded-xl hover:bg-white/5 text-white/60 transition-colors">
                        <i class="bi bi-sun-fill" x-show="document.documentElement.getAttribute('data-theme')==='light'"></i>
                        <i class="bi bi-moon-stars-fill" x-show="document.documentElement.getAttribute('data-theme')==='dark'"></i>
                    </button>

                    {% if user.is_authenticated %}
                    <div class="relative group" x-data="{ open: false, timer: null }" 
                         @mouseenter="clearTimeout(timer); open = true" 
                         @mouseleave="timer = setTimeout(() => { open = false }, 300)">
                        <button @click="open = !open" class="avatar-pill"
                                :class="open ? 'ring-1 ring-cyan-500/30 shadow-[0_0_15px_rgba(0,229,255,0.15)]' : ''">
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <template x-if="user.avatar">
                                        <img :src="user.avatar" class="w-7 h-7 rounded-lg object-cover ring-1 ring-white/10 group-hover:ring-cyan-500/50 transition-all">
                                    </template>
                                    <template x-if="!user.avatar">
                                        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center text-[10px] font-black text-white shadow-sm shadow-black/20">
                                            <span x-text="(user.display_name || user.username)[0].toUpperCase()"></span>
                                        </div>
                                    </template>
                                    <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 rounded-full bg-green-500 border border-[#03030b]"></div>
                                </div>
                                <span class="text-[11px] font-bold text-white/80 group-hover:text-white transition-colors" x-text="user.display_name || user.username"></span>
                                <i class="bi bi-chevron-down text-[8px] text-white/40 transition-transform duration-300" :class="open ? 'rotate-180' : ''"></i>
                            </div>
                        </button>
                        
                        <div x-show="open" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 translate-y-2 scale-95"
                             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                             x-transition:leave-end="opacity-0 translate-y-2 scale-95"
                             class="absolute right-0 mt-2 w-52 dropdown-blur rounded-2xl z-50 overflow-hidden py-1.5 shadow-2xl"
                             style="display: none;">
                            <div class="px-4 py-2 border-b border-white/5 mb-1">
                                <p class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">Tài khoản công dân</p>
                                <p class="text-[11px] font-bold text-white truncate">{{ user.email }}</p>
                            </div>
                            <a href="/dashboard/" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold text-white/70 hover:text-white hover:bg-white/5 transition-colors">
                                <div class="w-7 h-7 rounded-lg bg-cyan-400/10 flex items-center justify-center text-cyan-400">
                                    <i class="bi bi-speedometer2"></i>
                                </div>
                                Bảng điều khiển
                            </a>
                            <a href="/profile/" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold text-white/70 hover:text-white hover:bg-white/5 transition-colors">
                                <div class="w-7 h-7 rounded-lg bg-purple-400/10 flex items-center justify-center text-purple-400">
                                    <i class="bi bi-person-gear"></i>
                                </div>
                                Cài đặt tài khoản
                            </a>
                            <a href="/ai-assistant/" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold text-cyan-400 hover:bg-cyan-400/10 transition-colors">
                                <div class="w-7 h-7 rounded-lg bg-cyan-400/10 flex items-center justify-center">
                                    <i class="bi bi-robot"></i>
                                </div>
                                Hỏi đáp AI Assistant
                            </a>
                            {% if user.is_staff or user.profile.is_super_admin %}
                            <a href="{% url 'admin-dashboard' %}" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold text-yellow-400 hover:bg-yellow-400/10 transition-colors">
                                <div class="w-7 h-7 rounded-lg bg-yellow-400/10 flex items-center justify-center">
                                    <i class="bi bi-shield-lock"></i>
                                </div>
                                Admin Control Panel
                            </a>
                            <a href="/admin/" class="flex items-center gap-3 px-4 py-2.5 text-xs font-bold text-orange-400 hover:bg-orange-400/10 transition-colors">
                                <div class="w-7 h-7 rounded-lg bg-orange-400/10 flex items-center justify-center">
                                    <i class="bi bi-gear-fill"></i>
                                </div>
                                Django Admin (Core)
                            </a>
                            {% endif %}
                            <div class="h-[1px] bg-white/5 my-1 mx-4"></div>
                            <form action="/logout/" method="post">
                                {% csrf_token %}
                                <button type="submit" class="w-full flex items-center gap-3 px-4 py-3 text-xs font-bold text-red-400 hover:bg-red-500/10 transition-colors text-left">
                                    <div class="w-7 h-7 rounded-lg bg-red-400/10 flex items-center justify-center">
                                        <i class="bi bi-box-arrow-right"></i>
                                    </div>
                                    Đăng xuất
                                </button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <a href="/login/" class="hidden sm:block text-xs font-bold text-white/60 hover:text-white transition-colors">Đăng nhập</a>
                    <a href="/register/" class="liquid-btn text-[11px] py-1.5 px-5 bg-cyan-500/10 text-cyan-400 border-cyan-500/20">Đăng ký</a>
                    {% endif %}

                    <!-- Mobile menu button -->
                    <button @click="mobileMenu = !mobileMenu" class="lg:hidden p-2 rounded-lg" style="color:rgba(255,255,255,0.7);transition:color 0.3s;">
                        <i class="bi" style="font-size:1.4rem;" :class="mobileMenu ? 'bi-x-lg' : 'bi-list'"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Nav -->
        <div x-show="mobileMenu" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
            style="background:rgba(13,13,31,0.95);backdrop-filter:blur(24px);border-top:1px solid rgba(255,255,255,0.06);padding:0.75rem 1rem 1.5rem;" class="lg:hidden flex flex-col gap-0.5">
            <a href="/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'"><i class="bi bi-house-door-fill text-cyan-400"></i> Trang chủ</a>
            <div x-data="{ open: false }">
                <button @click="open = !open" class="w-full flex items-center justify-between p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'">
                    <span class="flex items-center gap-3"><i class="bi bi-search"></i> Kiểm tra</span>
                    <i class="bi bi-chevron-down transition-transform" :class="open ? 'rotate-180' : ''"></i>
                </button>
                <div x-show="open" x-transition class="pl-11 flex flex-col gap-0.5 py-1">
                    <a href="/scan/phone/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#18ffff'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-phone-fill mr-2 text-cyan-400"></i>Số điện thoại</a>
                    <a href="/scan/message/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#b388ff'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-chat-left-dots-fill mr-2 text-purple-400"></i>Tin nhắn</a>
                    <a href="/scan/website/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#64b5f6'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-globe2 mr-2 text-blue-400"></i>Website</a>
                    <a href="/scan/bank/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#ffd740'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-bank2 mr-2 text-yellow-400"></i>Tài khoản</a>
                    <a href="/scan/email/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#f06292'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-envelope-exclamation-fill mr-2 text-pink-400"></i>Email Scam</a>
                    <a href="/scan/qr/" class="p-2 text-sm" style="color:rgba(255,255,255,0.6);transition:color 0.2s;" onmouseover="this.style.color='#00e676'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i class="bi bi-qr-code-scan mr-2 text-green-400"></i>QR / Ảnh</a>
                </div>
            </div>
            <a href="/report/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'"><i class="bi bi-flag-fill text-red-400"></i> Báo cáo</a>
            <a href="/scam-radar/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'"><i class="bi bi-broadcast text-purple-400"></i> Radar</a>
            <a href="/forum/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'"><i class="bi bi-chat-dots-fill text-blue-400"></i> Diễn đàn</a>
            <a href="/learn/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'"><i class="bi bi-book-half text-yellow-400"></i> Cẩm nang</a>
            <a href="/ai-assistant/" class="flex items-center gap-3 p-3 rounded-xl text-cyan-400 font-bold" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.08)'" onmouseout="this.style.background='transparent'"><i class="bi bi-robot"></i> Hỏi AI Assistant</a>
            <a href="/emergency/" class="flex items-center gap-3 p-3 rounded-xl text-red-400" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,23,68,0.08)'" onmouseout="this.style.background='transparent'"><i class="bi bi-exclamation-triangle-fill"></i> Khẩn cấp</a>

            <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;gap:0.5rem;">
                {% if user.is_authenticated %}
                <a href="/profile/" class="flex items-center gap-3 p-3 rounded-xl" style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="this.style.background='transparent'">
                    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;" x-text="(user.display_name || user.username)[0].toUpperCase()"></div>
                    Profile
                </a>
                <form action="/logout/" method="post">
                    {% csrf_token %}
                    <button type="submit" class="glass-btn w-full justify-center p-3" style="font-size:0.85rem;">Đăng xuất</button>
                </form>
                {% else %}
                <a href="/login/" class="glass-btn w-full justify-center p-3" style="font-size:0.85rem;">Đăng nhập</a>
                <a href="/register/" style="display:flex;justify-content:center;padding:0.75rem;border-radius:0.75rem;background:linear-gradient(135deg,rgba(0,229,255,0.15),rgba(179,136,255,0.15));border:1px solid rgba(0,229,255,0.25);color:var(--accent-cyan);font-weight:600;font-size:0.85rem;text-decoration:none;">Đăng ký</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="animate-fadein"
        style="max-width:1280px;margin:0 auto;padding:2rem 1.5rem;position:relative;z-index:1;min-height:calc(100vh - 180px);">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer style="border-top:1px solid rgba(255,255,255,0.08);margin-top:4rem;background:rgba(0,0,0,0.1);">
        <div style="max-width:1280px;margin:0 auto;padding:4rem 1.5rem;">
            <div
                style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:3rem;margin-bottom:3rem;">
                <div>
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem;">
                        <div
                            class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                            <i class="bi bi-shield-lock-fill text-white text-sm"></i>
                        </div>
                        <span style="font-weight:800;font-size:1.25rem;" class="glow-text">ShieldCall VN</span>
                    </div>
                    <p style="font-size:0.9rem;color:var(--text-muted);line-height:1.7;">Bảo vệ người dùng Việt Nam
                        khỏi các hình thức lừa đảo số bằng công nghệ AI tiên tiến.</p>
                </div>
                <div>
                    <h4 style="font-weight:600;margin-bottom:0.75rem;font-size:0.9rem;color:rgba(255,255,255,0.7);">Scan
                    </h4>
                    <div style="display:flex;flex-direction:column;gap:0.4rem;font-size:0.85rem;">
                        <a href="/scan/phone/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Scan Số điện thoại</a>
                        <a href="/scan/message/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Scan Tin nhắn</a>
                        <a href="/scan/website/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Scan Website</a>
                        <a href="/scan/bank/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Scan Tài khoản</a>
                    </div>
                </div>
                <div>
                    <h4 style="font-weight:600;margin-bottom:0.75rem;font-size:0.9rem;color:rgba(255,255,255,0.7);">Hỗ
                        trợ</h4>
                    <div style="display:flex;flex-direction:column;gap:0.4rem;font-size:0.85rem;">
                        <a href="/report/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Báo cáo lừa đảo</a>
                        <a href="/learn/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Kiến thức phòng tránh</a>
                        <a href="/emergency/" style="color:rgba(255,255,255,0.5);transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent-cyan)'"
                            onmouseout="this.style.color='rgba(255,255,255,0.5)'">Hỗ trợ khẩn cấp</a>
                    </div>
                </div>
                <div>
                    <h4 style="font-weight:600;margin-bottom:0.75rem;font-size:0.9rem;color:rgba(255,255,255,0.7);">
                        Hotline</h4>
                    <p style="font-size:1.25rem;font-weight:700;color:var(--accent-cyan);margin-bottom:0.5rem;">
                        1800-1031</p>
                    <p style="font-size:0.8rem;color:rgba(255,255,255,0.4);">24/7 hỗ trợ khẩn cấp</p>
                </div>
            </div>
            <div
                style="border-top:1px solid rgba(255,255,255,0.08);padding-top:1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                <p style="font-size:0.8rem;color:rgba(255,255,255,0.35);">© 2026 ShieldCall VN. Bảo vệ cộng đồng bằng
                    công nghệ.</p>
                <div style="display:flex;gap:1rem;font-size:0.8rem;">
                    <a href="#" style="color:rgba(255,255,255,0.35);transition:color 0.2s;"
                        onmouseover="this.style.color='var(--accent-cyan)'"
                        onmouseout="this.style.color='rgba(255,255,255,0.35)'">Điều khoản</a>
                    <a href="#" style="color:rgba(255,255,255,0.35);transition:color 0.2s;"
                        onmouseover="this.style.color='var(--accent-cyan)'"
                        onmouseout="this.style.color='rgba(255,255,255,0.35)'">Chính sách</a>
                    <a href="/api/docs/" style="color:rgba(255,255,255,0.35);transition:color 0.2s;"
                        onmouseover="this.style.color='var(--accent-cyan)'"
                        onmouseout="this.style.color='rgba(255,255,255,0.35)'">API Docs</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="{% static 'js/notifications.js' %}"></script>
    <script>
        // Initialize theme on load
        (function () {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            document.addEventListener('DOMContentLoaded', function () { updateThemeIcons(saved); });
        })();

        // Lucide replacement (since we use Bootstrap Icons now)
        // lucide.createIcons(); 

        // CSRF token helper
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                c = c.trim();
                if (c.startsWith('csrftoken=')) return c.substring('csrftoken='.length);
            }
            return '';
        }

        // Global Phone Formatter
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = cleaned.substring(1);
            }
            if (cleaned.startsWith('84')) {
                cleaned = cleaned.substring(2);
            }
            return cleaned; 
        }

        // Theme toggle
        function toggleTheme() {
            showToast('🎨 Theme sáng đang trong quá trình phát triển', 'info');
        }

        function updateThemeIcons(theme) {
            const sun = document.querySelector('.bi-sun-fill');
            const moon = document.querySelector('.bi-moon-stars-fill');
            // Theme toggle logic is handled by Alpine x-show in the template
        }

        // Client Debug Logger
        window.SCDebug = {
            enabled: localStorage.getItem('sc_debug') === '1',
            log: function (...args) { if (window.SCDebug.enabled) console.log('%c[SC]', 'color:#18ffff;font-weight:bold', ...args); },
            error: function (...args) { console.error('%c[SC:ERR]', 'color:#ff1744;font-weight:bold', ...args); },
            warn: function (...args) { if (window.SCDebug.enabled) console.warn('%c[SC:WARN]', 'color:#ffd740;font-weight:bold', ...args); },
            enable: function () { localStorage.setItem('sc_debug', '1'); this.enabled = true; console.log('%c[SC] Debug mode ON — reload page for full effect', 'color:#00e676;font-weight:bold'); },
            disable: function () { localStorage.removeItem('sc_debug'); this.enabled = false; console.log('[SC] Debug mode OFF'); }
        };

        // Toast notification
        function showToast(message, type = 'info') {
            const colors = { success: 'rgba(0,230,118,0.2)', error: 'rgba(255,23,68,0.2)', info: 'rgba(0,229,255,0.2)', warning: 'rgba(255,234,0,0.2)' };
            const borderColors = { success: 'rgba(0,230,118,0.4)', error: 'rgba(255,23,68,0.4)', info: 'rgba(0,229,255,0.4)', warning: 'rgba(255,234,0,0.4)' };
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = colors[type] || colors.info;
            toast.style.border = `1px solid ${borderColors[type] || borderColors.info}`;
            toast.style.color = '#fff';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, 3000);
            setTimeout(() => toast.remove(), 3500);
        }

        async function apiCall(url, options = {}) {
            const defaults = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
            };
            const response = await fetch(url, { ...defaults, ...options });
            return response.json();
        }

        // OneSignal Integration
        window.is_authenticated = {{ user.is_authenticated|yesno:"true,false" }};
        window.is_staff = {{ user.is_staff|yesno:"true,false" }};

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "{{ ONESIGNAL_APP_ID }}",
                safari_web_id: "{{ ONESIGNAL_SAFARI_WEB_ID }}",
                notifyButton: { enable: true },
            });

            const syncOneSignalId = async (playerId) => {
                if (!playerId || !window.is_authenticated) return;
                try {
                    await fetch('/api/v1/notifications/onesignal-register/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                        body: JSON.stringify({ player_id: playerId })
                    });
                } catch (e) { SCDebug.error("[OneSignal] Sync error:", e); }
            };

            OneSignal.User.PushSubscription.addEventListener("change", (event) => {
                if (event.current.id) syncOneSignalId(event.current.id);
            });

            if (OneSignal.User.PushSubscription.id) {
                syncOneSignalId(OneSignal.User.PushSubscription.id);
            }
        });

        // Initialize Global Notification Manager
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof NotificationManager !== 'undefined') {
                NotificationManager.init(window.is_staff);
            }
        });
    </script>


    <!-- AI Assistant -->
    {% include 'ai_chat/chat_widget_inline.html' %}

    {% block extra_js %}{% endblock %}
</body>

</html>