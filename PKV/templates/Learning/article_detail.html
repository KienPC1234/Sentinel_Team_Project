{% extends "base.html" %}
{% load static %}

{% block title %}{{ article.title }} - ShieldCall VN{% endblock %}

{% block meta_description %}{{ article.content|striptags|truncatechars:160 }}{% endblock %}

{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.content|striptags|truncatechars:200 }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_image %}{% if article.cover_image %}{{ article.cover_image.url }}{% else %}{% static 'logo.png' %}{% endif %}{% endblock %}

{% block content %}
<div class="animate-fadein max-w-4xl mx-auto space-y-12 py-12 px-4 sm:px-0">
    <!-- Breadcrumbs -->
    <nav class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-white/20" data-aos="fade-right">
        <a href="/" class="hover:text-cyan-400 transition-colors">Trang chủ</a>
        <i class="bi bi-chevron-right text-[8px]"></i>
        <a href="/learn/" class="hover:text-cyan-400 transition-colors">Kiến thức</a>
        <i class="bi bi-chevron-right text-[8px]"></i>
        <span class="text-white/40">{{ article.title|truncatechars:30 }}</span>
    </nav>

    <!-- Article Header -->
    <div class="space-y-8 relative" data-aos="fade-up" data-aos-delay="100">
        <div class="flex items-center gap-4">
            <span class="px-4 py-1.5 rounded-full bg-cyan-500/10 text-cyan-400 text-[10px] font-black uppercase tracking-[0.2em] border border-cyan-500/10">
                {{ article.get_category_display }}
            </span>
            <span class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] flex items-center gap-2">
                <i class="bi bi-calendar3"></i> {{ article.created_at|date:"d/m/Y" }}
            </span>
        </div>
        
        <h1 class="text-4xl sm:text-6xl font-black text-white tracking-tight leading-[1.1] selection:bg-cyan-500/30">
            {{ article.title }}
        </h1>

        <div class="flex items-center gap-5 py-8 border-y border-white/5 group">
            <div class="relative">
                <div class="absolute inset-0 bg-cyan-500 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                <div class="relative w-12 h-12 rounded-2xl bg-gradient-to-tr from-slate-900 to-slate-800 border border-white/10 flex items-center justify-center text-cyan-400 font-black text-lg shadow-2xl">
                    {% if article.author %}
                        {{ article.author.username|default:"A"|first|upper }}
                    {% else %}
                        S
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="text-xs font-black text-white uppercase tracking-[0.2em]">
                    {% if article.author %}
                        {{ article.author.get_full_name|default:article.author.username }}
                    {% else %}
                        ShieldCall Admin
                    {% endif %}
                </div>
                <div class="text-[9px] font-bold text-white/20 uppercase tracking-[0.2em] mt-1 flex items-center gap-1.5">
                    <i class="bi bi-patch-check-fill text-cyan-500/50"></i> Ban biên tập ShieldCall VN
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Image -->
    {% if article.cover_image %}
    <div class="relative" data-aos="zoom-in" data-aos-delay="200">
        <div class="absolute inset-0 bg-cyan-500/10 blur-3xl opacity-30 rounded-full"></div>
        <div class="relative aspect-[21/9] rounded-[2.5rem] overflow-hidden bg-slate-900 border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
            <img src="{{ article.cover_image.url }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000" alt="{{ article.title }}">
        </div>
    </div>
    {% endif %}

    <!-- Article Content -->
    <div x-data="{content: ''}" 
         x-init="content = window.renderRichText(`{{ article.content|escapejs }}`)"
         class="prose prose-invert prose-cyan max-w-none text-white/80 leading-[1.8] font-medium text-lg sm:text-xl selection:bg-cyan-500/20 px-2" 
         data-aos="fade-up" data-aos-delay="300">
        <div x-html="content" class="rich-text-content"></div>
    </div>

    <!-- ═══ QUIZZES SECTION (Added support) ═══ -->
    {% if quizzes %}
    <div class="space-y-10 pt-16 border-t border-white/5" data-aos="fade-up">
        <div class="flex items-center gap-5">
            <div class="relative">
                <div class="absolute inset-0 bg-purple-500 blur-xl opacity-30"></div>
                <div class="relative w-14 h-14 rounded-2xl bg-purple-500/10 text-purple-400 flex items-center justify-center border border-purple-500/20 shadow-xl group">
                    <i class="bi bi-lightning-charge-fill text-2xl group-hover:scale-110 transition-transform"></i>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-black text-white tracking-tight">Thử thách kiến thức</h2>
                <p class="text-[10px] font-black text-white/30 uppercase tracking-[0.3em] mt-1">{{ quizzes|length }} CÂU HỎI DIỄN TẬP</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {% for q in quizzes %}
            <div x-data="{selected: null, submitted: false, correct: false}" 
                 class="liquid-card group flex flex-col h-full border border-white/5 hover:border-purple-500/20 transition-all duration-500 shadow-xl" 
                 data-aos="fade-up" data-aos-delay="{{ forloop.counter0 }}50">
                
                <!-- Card Header -->
                <div class="p-6 pb-0 flex items-start gap-4">
                    <div class="relative">
                        <div class="absolute inset-0 bg-purple-500 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative w-10 h-10 flex-shrink-0 rounded-xl bg-slate-900 border border-purple-500/30 text-purple-400 flex items-center justify-center font-black text-sm">
                            {{ forloop.counter }}
                        </div>
                    </div>
                    <h3 class="text-base font-black text-white leading-tight group-hover:text-cyan-400 transition-colors pt-1">{{ q.question }}</h3>
                </div>

                <!-- Card Body -->
                <div class="p-6 flex-1 space-y-3">
                    {% for opt in q.options %}
                    <button @click="if(!submitted){selected='{{ opt|escapejs }}'}"
                            :disabled="submitted"
                            :class="submitted 
                                ? ('{{ opt|escapejs }}'==='{{ q.correct_answer|escapejs }}' ? 'border-green-500/40 bg-green-500/10 text-green-400' : (selected==='{{ opt|escapejs }}' ? 'border-red-500/40 bg-red-500/10 text-red-400' : 'border-white/5 text-white/20 opacity-50'))
                                : (selected==='{{ opt|escapejs }}' ? 'border-cyan-400/50 bg-cyan-400/10 text-white translate-x-1' : 'border-white/5 text-white/60 hover:border-white/20 hover:bg-white/5 hover:text-white')"
                            class="w-full text-left px-5 py-4 rounded-2xl border text-sm font-bold transition-all duration-300 flex items-center justify-between group/opt">
                        <div class="flex items-center gap-4">
                            <span class="w-6 h-6 rounded-lg bg-white/5 flex items-center justify-center text-[10px] font-black text-white/40 group-hover/opt:bg-cyan-500/20 group-hover/opt:text-cyan-400"
                                  :class="selected==='{{ opt|escapejs }}' ? 'bg-cyan-500/20 text-cyan-400' : ''"
                                  x-text="String.fromCharCode(64 + {{ forloop.counter }})">
                            </span>
                            <span>{{ opt }}</span>
                        </div>
                        <div class="flex items-center">
                            <template x-if="submitted && '{{ opt|escapejs }}'==='{{ q.correct_answer|escapejs }}'">
                                <i class="bi bi-check2-circle text-xl text-green-400"></i>
                            </template>
                            <template x-if="submitted && selected==='{{ opt|escapejs }}' && '{{ opt|escapejs }}'!=='{{ q.correct_answer|escapejs }}'">
                                <i class="bi bi-x-circle text-xl text-red-400"></i>
                            </template>
                        </div>
                    </button>
                    {% endfor %}
                </div>

                <!-- Footer -->
                <div class="p-6 pt-0 space-y-4">
                    <button @click="if(selected && !submitted){submitted=true; correct=(selected==='{{ q.correct_answer|escapejs }}')}"
                            :disabled="!selected || submitted"
                            class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] transition-all shadow-xl"
                            :class="(!selected || submitted) ? 'bg-white/5 text-white/10 cursor-not-allowed border border-white/5' : 'bg-gradient-to-r from-cyan-600 to-blue-700 text-white hover:scale-[1.02] active:scale-95 shadow-cyan-500/20'">
                        <span x-show="!submitted">Kiểm tra đáp án</span>
                        <span x-show="submitted && correct"><i class="bi bi-hand-thumbs-up-fill mr-2"></i>Chính xác!</span>
                        <span x-show="submitted && !correct"><i class="bi bi-exclamation-octagon-fill mr-2"></i>Cần xem lại</span>
                    </button>

                    {% if q.explanation %}
                    <div x-show="submitted" x-transition class="p-5 rounded-3xl bg-yellow-400/[0.03] border border-yellow-400/10">
                        <span class="text-[9px] font-black text-yellow-400 uppercase tracking-widest flex items-center gap-2 mb-2">
                            <i class="bi bi-lightbulb-fill"></i> GIẢI THÍCH CHUYÊN GIA
                        </span>
                        <p class="text-[12px] text-white/70 font-medium leading-relaxed italic">
                            {{ q.explanation }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Footer / Share -->
    <div class="pt-12 border-t border-white/5 flex flex-col sm:flex-row justify-between items-center gap-8">
        <div class="flex items-center gap-6">
            <span class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em]">Chia sẻ kiến thức</span>
            <div class="flex gap-3">
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-facebook text-lg"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-twitter-x text-lg"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-link-45deg text-2xl"></i>
                </a>
            </div>
        </div>
        
        <a href="/learn/" class="group flex items-center gap-3 bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] hover:bg-cyan-500/20 transition-all active:scale-95">
            <i class="bi bi-arrow-left transition-transform group-hover:-translate-x-1"></i> Quay lại cẩm nang
        </a>
    </div>
</div>

<!-- Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": "{{ article.title|escapejs }}",
  "image": [
    "{% if article.cover_image %}{{ request.scheme }}://{{ request.get_host }}{{ article.cover_image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'logo.png' %}{% endif %}"
  ],
  "datePublished": "{{ article.created_at|date:'c' }}",
  "dateModified": "{{ article.updated_at|date:'c' }}",
  "author": [{
      "@type": "Person",
      "name": "{{ article.author.username|default:'Admin'|escapejs }}",
      "url": "{{ request.scheme }}://{{ request.get_host }}/learn/"
    }]
}
</script>
{% endblock %}
