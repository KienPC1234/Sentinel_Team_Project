{% extends "base.html" %}
{% load static %}

{% block title %}{{ lesson.title }} - ShieldCall VN{% endblock %}

{% block meta_description %}{{ lesson.content|striptags|truncatechars:160 }}{% endblock %}

{% block og_title %}{{ lesson.title }}{% endblock %}
{% block og_description %}{{ lesson.content|striptags|truncatechars:200 }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_image %}{% if lesson.cover_image %}{{ lesson.cover_image.url }}{% else %}{% static 'logo.png' %}{% endif %}{% endblock %}

{% block content %}
<div class="animate-fadein max-w-4xl mx-auto space-y-12 py-12 px-4 sm:px-0">
    <!-- Breadcrumbs -->
    <nav class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-white/20" data-aos="fade-right">
        <a href="/" class="hover:text-cyan-400 transition-colors">Trang chủ</a>
        <i class="bi bi-chevron-right text-[8px]"></i>
        <a href="/learn/" class="hover:text-cyan-400 transition-colors">Kiến thức</a>
        <i class="bi bi-chevron-right text-[8px]"></i>
        <span class="text-white/40">{{ lesson.title|truncatechars:30 }}</span>
    </nav>

    <!-- Lesson Header -->
    <div class="space-y-8 relative" data-aos="fade-up" data-aos-delay="100">
        <div class="flex items-center gap-4">
            <span class="px-4 py-1.5 rounded-full bg-cyan-500/10 text-cyan-400 text-[10px] font-black uppercase tracking-[0.2em] border border-cyan-500/10">
                {{ lesson.get_category_display }}
            </span>
            <span class="px-3 py-1 rounded-lg bg-cyan-500/20 text-cyan-300 text-[8px] font-black uppercase tracking-[0.2em] border border-cyan-500/20">
                <i class="bi bi-stars mr-1"></i>AI Generated
            </span>
            <span class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] flex items-center gap-2">
                <i class="bi bi-calendar3"></i> {{ lesson.created_at|date:"d/m/Y" }}
            </span>
        </div>
        
        <h1 class="text-4xl sm:text-6xl font-black text-white tracking-tight leading-[1.1] selection:bg-cyan-500/30">
            {{ lesson.title }}
        </h1>

        <div class="flex items-center gap-5 py-8 border-y border-white/5 group">
            <div class="relative">
                <div class="absolute inset-0 bg-cyan-500 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                <div class="relative w-12 h-12 rounded-2xl bg-gradient-to-tr from-slate-900 to-slate-800 border border-white/10 flex items-center justify-center text-cyan-400 font-black text-lg shadow-2xl">
                    <i class="bi bi-robot"></i>
                </div>
            </div>
            <div>
                <div class="text-xs font-black text-white uppercase tracking-[0.2em]">ShieldCall AI</div>
                <div class="text-[9px] font-bold text-white/20 uppercase tracking-[0.2em] mt-1 flex items-center gap-1.5">
                    <i class="bi bi-cpu-fill text-cyan-500/50"></i> Nội dung được tổng hợp bởi AI
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Image -->
    {% if lesson.cover_image %}
    <div class="relative" data-aos="zoom-in" data-aos-delay="200">
        <div class="absolute inset-0 bg-cyan-500/10 blur-3xl opacity-30 rounded-full"></div>
        <div class="relative aspect-[21/9] rounded-[2.5rem] overflow-hidden bg-slate-900 border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
            <img src="{{ lesson.cover_image.url }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000" alt="{{ lesson.title }}">
        </div>
    </div>
    {% endif %}

    <!-- Lesson Content -->
    <div x-data="{content: ''}" 
         x-init="content = window.renderRichText(`{{ lesson.content|escapejs }}`)"
         class="prose prose-invert prose-cyan max-w-none text-white/80 leading-[1.8] font-medium text-lg sm:text-xl selection:bg-cyan-500/20 px-2" 
         data-aos="fade-up" data-aos-delay="300">
        <div x-html="content" class="rich-text-content"></div>
    </div>

    <!-- ═══ QUIZZES SECTION ═══ -->
    {% if quizzes %}
    <div class="space-y-10 pt-16 border-t border-white/5" data-aos="fade-up">
        <div class="flex items-center gap-5">
            <div class="relative">
                <div class="absolute inset-0 bg-purple-500 blur-xl opacity-30"></div>
                <div class="relative w-14 h-14 rounded-2xl bg-purple-500/10 text-purple-400 flex items-center justify-center border border-purple-500/20 shadow-xl group">
                    <i class="bi bi-lightning-charge-fill text-2xl group-hover:scale-110 transition-transform"></i>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-black text-white tracking-tight">Thử thách kiến thức</h2>
                <p class="text-[10px] font-black text-white/30 uppercase tracking-[0.3em] mt-1">{{ quizzes|length }} CÂU HỎI DIỄN TẬP</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {% for q in quizzes %}
            <div x-data="{selected: null, submitted: false, correct: false}" 
                 class="liquid-card group flex flex-col h-full border border-white/5 hover:border-purple-500/20 transition-all duration-500 shadow-xl" 
                 data-aos="fade-up" data-aos-delay="{{ forloop.counter0 }}50">
                
                <div class="p-6 pb-0 flex items-start gap-4">
                    <div class="relative">
                        <div class="absolute inset-0 bg-purple-500 blur-xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative w-10 h-10 flex-shrink-0 rounded-xl bg-slate-900 border border-purple-500/30 text-purple-400 flex items-center justify-center font-black text-sm">
                            {{ forloop.counter }}
                        </div>
                    </div>
                    <h3 class="text-base font-black text-white leading-tight group-hover:text-cyan-400 transition-colors pt-1">{{ q.question }}</h3>
                </div>

                <div class="p-6 flex-1 space-y-3">
                    {% for opt in q.options %}
                    <button @click="if(!submitted){selected='{{ opt|escapejs }}'}"
                            :disabled="submitted"
                            :class="submitted 
                                ? ('{{ opt|escapejs }}'==='{{ q.correct_answer|escapejs }}' ? 'border-green-500/40 bg-green-500/10 text-green-400' : (selected==='{{ opt|escapejs }}' ? 'border-red-500/40 bg-red-500/10 text-red-400' : 'border-white/5 text-white/20 opacity-50'))
                                : (selected==='{{ opt|escapejs }}' ? 'border-cyan-400/50 bg-cyan-400/10 text-white translate-x-1' : 'border-white/5 text-white/60 hover:border-white/20 hover:bg-white/5 hover:text-white')"
                            class="w-full text-left px-5 py-4 rounded-2xl border text-sm font-bold transition-all duration-300 flex items-center justify-between group/opt">
                        <div class="flex items-center gap-4">
                            <span class="w-6 h-6 rounded-lg bg-white/5 flex items-center justify-center text-[10px] font-black text-white/40 group-hover/opt:bg-cyan-500/20 group-hover/opt:text-cyan-400"
                                  :class="selected==='{{ opt|escapejs }}' ? 'bg-cyan-500/20 text-cyan-400' : ''"
                                  x-text="String.fromCharCode(64 + {{ forloop.counter }})">
                            </span>
                            <span>{{ opt }}</span>
                        </div>
                        <div class="flex items-center">
                            <template x-if="submitted && '{{ opt|escapejs }}'==='{{ q.correct_answer|escapejs }}'">
                                <i class="bi bi-check2-circle text-xl text-green-400"></i>
                            </template>
                            <template x-if="submitted && selected==='{{ opt|escapejs }}' && '{{ opt|escapejs }}'!=='{{ q.correct_answer|escapejs }}'">
                                <i class="bi bi-x-circle text-xl text-red-400"></i>
                            </template>
                        </div>
                    </button>
                    {% endfor %}
                </div>

                <div class="p-6 pt-0 space-y-4">
                    <button @click="if(selected && !submitted){submitted=true; correct=(selected==='{{ q.correct_answer|escapejs }}')}"
                            :disabled="!selected || submitted"
                            class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] transition-all shadow-xl"
                            :class="(!selected || submitted) ? 'bg-white/5 text-white/10 cursor-not-allowed border border-white/5' : 'bg-gradient-to-r from-cyan-600 to-blue-700 text-white hover:scale-[1.02] active:scale-95 shadow-cyan-500/20'">
                        <span x-show="!submitted">Kiểm tra đáp án</span>
                        <span x-show="submitted && correct"><i class="bi bi-hand-thumbs-up-fill mr-2"></i>Chính xác!</span>
                        <span x-show="submitted && !correct"><i class="bi bi-exclamation-octagon-fill mr-2"></i>Cần xem lại</span>
                    </button>

                    {% if q.explanation %}
                    <div x-show="submitted" x-transition class="p-5 rounded-3xl bg-yellow-400/[0.03] border border-yellow-400/10">
                        <span class="text-[9px] font-black text-yellow-400 uppercase tracking-widest flex items-center gap-2 mb-2">
                            <i class="bi bi-lightbulb-fill"></i> GIẢI THÍCH CHUYÊN GIA
                        </span>
                        <p class="text-[12px] text-white/70 font-medium leading-relaxed italic">
                            {{ q.explanation }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ═══ SCENARIO SECTION ═══ -->
    {% if scenario %}
    <div x-data="scenarioPlayer" class="space-y-10 pt-16 border-t border-white/5" data-aos="fade-up">
        {{ scenario_steps|json_script }}
        <div class="flex items-center gap-5">
            <div class="relative">
                <div class="absolute inset-0 bg-purple-500 blur-xl opacity-30"></div>
                <div class="relative w-14 h-14 rounded-2xl bg-purple-500/10 text-purple-400 flex items-center justify-center border border-purple-500/20 shadow-xl group">
                    <i class="bi bi-mask text-2xl group-hover:scale-110 transition-transform"></i>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-black text-white tracking-tight">Mô phỏng tình huống</h2>
                <p class="text-[10px] font-black text-white/30 uppercase tracking-[0.3em] mt-1">{{ scenario.title }}</p>
            </div>
        </div>

        <div class="liquid-card p-0 flex flex-col border border-white/5 overflow-hidden shadow-2xl">
            <!-- Start button -->
            <div x-show="!open" class="p-12 text-center space-y-8 bg-gradient-to-br from-purple-500/5 to-cyan-500/5">
                <p class="text-white/50 text-sm font-medium leading-relaxed italic max-w-2xl mx-auto">
                    "{{ scenario.description|default:'Trải nghiệm kịch bản mô phỏng để nhận biết các dấu hiệu lừa đảo trong thực tế.' }}"
                </p>
                <button @click="play()" class="relative group overflow-hidden rounded-2xl px-12 py-5 bg-purple-600 text-white font-black text-xs uppercase tracking-[0.3em] transition-all hover:scale-[1.05] hover:shadow-[0_0_40px_rgba(168,85,247,0.4)]">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <span class="relative flex items-center justify-center gap-3">
                        <i class="bi bi-play-circle-fill text-xl"></i> BẮT ĐẦU DIỄN TẬP
                    </span>
                </button>
            </div>

            <!-- Immersive Chat Player -->
            <div x-show="open" x-transition class="flex flex-col h-[600px] bg-[#03030b]" x-cloak>
                <!-- Player Header -->
                <div class="p-5 bg-white/[0.03] border-b border-white/10 flex items-center justify-between backdrop-blur-3xl sticky top-0 z-20">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-2xl bg-purple-500/10 text-purple-400 flex items-center justify-center border border-purple-500/20">
                            <i class="bi bi-shield-shaded"></i>
                        </div>
                        <div>
                            <h4 class="text-[11px] font-black text-white uppercase tracking-widest">{{ scenario.title }}</h4>
                            <div class="flex items-center gap-2 mt-1.5 h-1.5 w-32">
                                <template x-for="(s, i) in steps" :key="i">
                                    <div class="h-full rounded-full transition-all duration-500"
                                         :class="i <= currentStep ? 'bg-purple-500 flex-1' : 'bg-white/10 w-1.5'"></div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <button @click="open = false" class="w-10 h-10 rounded-2xl hover:bg-white/5 text-white/20 hover:text-white transition-all">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- Chat Area -->
                <div x-ref="chatContainer" class="flex-1 overflow-y-auto p-8 space-y-10 scrollbar-hide bg-[radial-gradient(circle_at_bottom,rgba(168,85,247,0.08),transparent_70%)]">
                    <template x-for="(s, i) in steps" :key="i">
                        <div x-show="i <= currentStep" x-transition class="flex flex-col gap-3">
                            <div class="flex flex-col"
                                 :class="s.actor === 'scammer' || s.actor === 'Kẻ lừa đảo' ? 'items-start' : (s.actor === 'victim' || s.actor === 'Nạn nhân' ? 'items-end' : 'items-center')">
                                <div class="flex items-center gap-2 mb-2 px-3 py-1 rounded-full border text-[10px] font-black uppercase tracking-widest"
                                     :class="s.actor === 'scammer' || s.actor === 'Kẻ lừa đảo' ? 'text-red-400 bg-red-400/5 border-red-500/10' : (s.actor === 'victim' || s.actor === 'Nạn nhân' ? 'text-cyan-400 bg-cyan-400/5 border-cyan-500/10' : 'text-purple-400 bg-purple-400/5 border-purple-500/10')">
                                    <span x-text="s.actor"></span>
                                </div>
                                <div class="max-w-[80%] rounded-[2rem] px-6 py-4 text-sm font-medium leading-relaxed shadow-2xl border"
                                     :class="s.actor === 'scammer' || s.actor === 'Kẻ lừa đảo' ? 'bg-[#1a0f0f] border-red-500/20 text-red-100/90 rounded-tl-lg' : (s.actor === 'victim' || s.actor === 'Nạn nhân' ? 'bg-[#0f172a] border-cyan-500/20 text-cyan-50/90 rounded-tr-lg' : 'bg-white/5 border-white/5 text-white/50 text-center italic py-2 px-8 rounded-full')">
                                    <span x-text="s.text"></span>
                                </div>
                                <div x-show="s.analysis" class="mt-4 p-5 rounded-3xl bg-yellow-400/[0.02] border border-yellow-400/10 max-w-[75%] relative overflow-hidden">
                                    <p class="text-[10px] font-black text-yellow-500/80 uppercase tracking-[0.2em] mb-1.5 flex items-center gap-2">
                                        <i class="bi bi-lightbulb-fill"></i> Phân tích
                                    </p>
                                    <p class="text-[12px] text-yellow-50/40 leading-relaxed italic" x-text="s.analysis"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Footer Controls -->
                <div class="p-6 bg-[#05050d] border-t border-white/10 flex items-center justify-between gap-6 relative z-20">
                    <button @click="prev()" :disabled="currentStep === 0"
                            class="w-14 h-14 rounded-2xl border border-white/5 flex items-center justify-center transition-all bg-white/[0.02]"
                            :class="currentStep === 0 ? 'text-white/5 cursor-not-allowed' : 'text-white/60 hover:bg-white/10 hover:text-white'">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <div class="flex-1 text-center">
                        <span class="text-[11px] font-black text-white/20 uppercase tracking-[0.3em]">
                            BƯỚC <span class="text-purple-400" x-text="currentStep + 1"></span> / <span x-text="maxSteps"></span>
                        </span>
                    </div>
                    <button @click="next()" :disabled="currentStep >= maxSteps - 1"
                            class="flex-1 sm:flex-none sm:w-64 h-14 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] transition-all relative overflow-hidden"
                            :class="currentStep >= maxSteps - 1 ? 'bg-white/5 text-white/10 cursor-not-allowed border border-white/5' : 'bg-purple-600 text-white shadow-2xl hover:scale-[1.03]'">
                        <span class="relative z-10 flex items-center justify-center gap-2">
                             Tiếp tục <i class="bi bi-arrow-right-short text-xl"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="pt-12 border-t border-white/5 flex flex-col sm:flex-row justify-between items-center gap-8">
        <div class="flex items-center gap-6">
            <span class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em]">CHIA SẺ KIẾN THỨC</span>
            <div class="flex gap-3">
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-facebook text-lg"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-twitter-x text-lg"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-all border border-white/5 hover:border-cyan-500/20 active:scale-90">
                    <i class="bi bi-link-45deg text-2xl"></i>
                </a>
            </div>
        </div>
        <a href="/learn/" class="group flex items-center gap-3 bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] hover:bg-cyan-500/20 transition-all active:scale-95">
            <i class="bi bi-arrow-left transition-transform group-hover:-translate-x-1"></i> QUAY LẠI CẨM NANG
        </a>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('scenarioPlayer', () => ({
        open: false,
        currentStep: 0,
        steps: [],
        get maxSteps() { return this.steps.length },
        init() {
            try {
                const el = this.$el.querySelector('script[type="application/json"]');
                if (el) {
                    const raw = JSON.parse(el.textContent);
                    this.steps = (raw || []).map(s => {
                        if (typeof s === 'string') return { text: s, actor: '', analysis: '' };
                        return {
                            text: s.text || '',
                            actor: s.actor || s.speaker || '',
                            analysis: s.analysis || s.note || ''
                        };
                    });
                }
            } catch(e) { console.error('Scenario parse error', e); }
        },
        play() {
            this.open = true;
            this.currentStep = 0;
            this.$nextTick(() => { this.scrollToBottom(); });
        },
        next() {
            if (this.currentStep < this.maxSteps - 1) {
                this.currentStep++;
                this.$nextTick(() => { this.scrollToBottom(); });
            }
        },
        prev() {
            if (this.currentStep > 0) this.currentStep--;
        },
        scrollToBottom() {
            const c = this.$refs.chatContainer;
            if (c) c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' });
        }
    }));
});
</script>
{% endblock %}
