{% extends "base.html" %}
{% load static %}

{% block title %}RAG & Kiến thức AI - ShieldCall VN Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10 mt-16 max-w-6xl">
    <div class="flex items-center justify-between mb-12">
        <div class="flex items-center gap-6">
            <div class="w-14 h-14 rounded-2xl bg-cyan-500/10 border border-cyan-500/20 flex items-center justify-center text-cyan-400 shadow-lg shadow-cyan-500/5">
                <i class="bi bi-database-fill-gear text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">RAG & Kiến thức AI</h1>
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Đồng bộ hóa trí tuệ nhân tạo</p>
            </div>
        </div>
        
        <button onclick="reindexRAG()" class="px-8 py-3.5 rounded-2xl bg-cyan-500 text-black font-black uppercase tracking-widest hover:bg-cyan-400 transition-all shadow-xl shadow-cyan-500/20 flex items-center gap-2 group">
            <i id="reindex-icon" class="bi bi-arrow-repeat text-xl group-hover:rotate-180 transition-transform duration-500"></i>
            Quét lại kiến thức
        </button>
    </div>

    <!-- Running Status Banner -->
    <div x-data="ragStats()" x-show="is_running" x-transition
         class="mb-8 p-6 rounded-[2rem] bg-cyan-500/5 border border-cyan-500/20 animate-pulse">
        <div class="flex items-center gap-4">
            <i class="bi bi-arrow-repeat text-2xl text-cyan-400 animate-spin"></i>
            <div>
                <div class="text-sm font-black text-cyan-400">Đang đồng bộ kiến thức...</div>
                <div class="text-[10px] text-white/30 font-bold mt-1" x-show="running_since">
                    Bắt đầu lúc: <span x-text="formatDate(running_since)"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Banner -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12" x-data="ragStats()">
        <div class="group p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-6 opacity-10 text-cyan-400">
                <i class="bi bi-files text-4xl"></i>
            </div>
            <div class="text-[10px] font-black text-cyan-500/50 uppercase tracking-widest mb-2">Tổng số tài liệu</div>
            <div class="text-4xl font-black text-white tabular-nums tracking-tighter" x-text="countUp(total_items)">{{ stats.total_items }}</div>
            <div class="mt-4 text-[10px] font-bold text-white/20 uppercase tracking-widest">Vectorized items</div>
        </div>
        
        <div class="group p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-6 opacity-10 text-purple-400">
                <i class="bi bi-clock-history text-4xl"></i>
            </div>
            <div class="text-[10px] font-black text-purple-500/50 uppercase tracking-widest mb-2">Cập nhật lần cuối</div>
            <div class="text-2xl font-black text-white" x-text="formatDate(last_sync)">{{ stats.last_sync|date:"d/m H:i"|default:"Chưa có" }}</div>
            <div class="mt-4 text-[10px] font-bold text-white/20 uppercase tracking-widest">Last synchronization</div>
        </div>
        
        <div class="group p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-6 opacity-10 text-emerald-400">
                <i class="bi bi-cpu text-4xl"></i>
            </div>
            <div class="text-[10px] font-black text-emerald-500/50 uppercase tracking-widest mb-2">Trạng thái VectorDB</div>
            <div class="flex items-center gap-3">
                <span class="w-2.5 h-2.5 rounded-full transition-all duration-500" 
                    :class="is_ready ? 'bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.5)] animate-pulse' : 'bg-red-500'"></span>
                <span class="text-2xl font-black text-white" x-text="is_ready ? 'Sẵn sàng' : 'Lỗi'">{% if stats.is_ready %}Sẵn sàng{% else %}Lỗi{% endif %}</span>
            </div>
            <div class="mt-4 text-[9px] font-bold text-white/20 uppercase tracking-widest truncate" x-text="'Model: ' + model_name">Model: {{ stats.model_name|default:"Unknown" }}</div>
        </div>
        
        <div class="group p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-6 opacity-10 text-amber-400">
                <i class="bi bi-hourglass-split text-4xl"></i>
            </div>
            <div class="text-[10px] font-black text-amber-500/50 uppercase tracking-widest mb-2">Job kế tiếp</div>
            <div class="text-2xl font-black text-white tabular-nums" x-text="countdown">—</div>
            <div class="mt-4 text-[10px] font-bold text-white/20 uppercase tracking-widest">
                Mỗi <span x-text="Math.round(beat_interval / 60)">60</span> phút
            </div>
        </div>
    </div>

    <script>
        function ragStats() {
            return {
                total_items: {{ stats.total_items|default:0 }},
                last_sync: '{{ stats.last_sync|date:"Y-m-d H:i:s"|default:"" }}',
                is_ready: {{ stats.is_ready|yesno:"true,false" }},
                model_name: '{{ stats.model_name|default:"Unknown" }}',
                is_running: {{ stats.is_running|yesno:"true,false" }},
                running_since: '{{ stats.running_since|date:"Y-m-d H:i:s"|default:"" }}',
                beat_interval: {{ stats.beat_interval|default:3600 }},
                countdown: '',
                logs: [],
                pollInterval: null,
                fastPoll: false,
                displayed_count: 0,
                init() {
                    this.displayed_count = this.total_items;
                    this.updateCountdown();
                    // Normal poll every 5s, fast poll every 1.5s when running
                    this.startPolling();
                    setInterval(() => this.updateCountdown(), 1000);
                },
                startPolling() {
                    if (this.pollInterval) clearInterval(this.pollInterval);
                    const interval = this.fastPoll ? 1500 : 5000;
                    this.pollInterval = setInterval(() => this.poll(), interval);
                    this.poll(); // immediate first poll
                },
                async poll() {
                    try {
                        const resp = await fetch(window.location.pathname + '?json=1');
                        const data = await resp.json();
                        if (data.stats) {
                            const wasRunning = this.is_running;
                            this.total_items = data.stats.total_items;
                            this.last_sync = data.stats.last_sync;
                            this.is_ready = data.stats.is_ready;
                            this.model_name = data.stats.model_name;
                            this.is_running = data.stats.is_running;
                            this.running_since = data.stats.running_since || '';
                            
                            // Switch to fast polling when running, back to normal when done
                            if (this.is_running && !this.fastPoll) {
                                this.fastPoll = true;
                                this.startPolling();
                            } else if (!this.is_running && this.fastPoll) {
                                this.fastPoll = false;
                                this.startPolling();
                                if (wasRunning) {
                                    showToast('Đồng bộ RAG hoàn tất!', 'success');
                                }
                            }
                        }
                        if (data.logs) {
                            this.logs = data.logs;
                        }
                    } catch (e) { console.error('Polling failed', e); }
                },
                updateCountdown() {
                    if (!this.last_sync) { this.countdown = 'N/A'; return; }
                    try {
                        const lastSync = new Date(this.last_sync);
                        const nextRun = new Date(lastSync.getTime() + this.beat_interval * 1000);
                        const now = new Date();
                        const diff = Math.max(0, Math.floor((nextRun - now) / 1000));
                        if (diff <= 0) { this.countdown = 'Sắp chạy...'; return; }
                        const h = Math.floor(diff / 3600);
                        const m = Math.floor((diff % 3600) / 60);
                        const s = diff % 60;
                        this.countdown = (h > 0 ? h + 'h ' : '') + m.toString().padStart(2, '0') + 'm ' + s.toString().padStart(2, '0') + 's';
                    } catch(e) { this.countdown = '—'; }
                },
                countUp(val) {
                    return val;
                },
                formatDate(dateStr) {
                    if (!dateStr) return 'Chưa có';
                    try {
                        const d = new Date(dateStr);
                        return d.getDate().toString().padStart(2, '0') + '/' + 
                               (d.getMonth()+1).toString().padStart(2, '0') + ' ' + 
                               d.getHours().toString().padStart(2, '0') + ':' + 
                               d.getMinutes().toString().padStart(2, '0');
                    } catch(e) { return dateStr; }
                },
                async clearLogs() {
                    const result = await Swal.fire({
                        title: 'Dọn lịch sử đồng bộ?',
                        text: 'Tất cả lịch sử đồng bộ (trừ job đang chạy) sẽ bị xóa.',
                        icon: 'warning',
                        showCancelButton: true,
                        background: '#0d0d1f', color: '#fff',
                        confirmButtonColor: '#ff1744',
                        cancelButtonColor: 'rgba(255,255,255,0.05)',
                        confirmButtonText: 'Xóa',
                        cancelButtonText: 'Hủy',
                        customClass: { popup: 'rounded-[2rem] border border-white/10' }
                    });
                    if (!result.isConfirmed) return;
                    try {
                        const res = await fetch("{% url 'core:admin-rag-clear-logs' %}", {
                            method: 'POST',
                            headers: { 'X-CSRFToken': getCSRFToken(), 'Content-Type': 'application/json' }
                        });
                        const data = await res.json();
                        if (res.ok) {
                            showToast(data.message, 'success');
                            this.logs = [];
                            this.poll();
                        } else {
                            showToast(data.message || 'Lỗi xóa lịch sử', 'error');
                        }
                    } catch(e) { showToast('Lỗi kết nối', 'error'); }
                }
            }
        }
    </script>

    <!-- Context Testing Section -->
    <div class="p-10 rounded-[3rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl mb-12">
        <div class="flex items-center gap-4 mb-8">
            <div class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400">
                <i class="bi bi-search text-lg"></i>
            </div>
            <h2 class="text-2xl font-black text-white tracking-tight">Kiểm tra Context</h2>
        </div>
        
        <form method="get" class="relative mb-10">
            <input type="text" name="query" value="{{ query|default:'' }}" placeholder="Nhập câu hỏi để test tìm kiếm ngữ cảnh..." 
                   class="w-full bg-black/40 border border-white/10 rounded-3xl px-8 py-5 text-white focus:outline-none focus:border-cyan-500/50 transition-all font-medium text-lg placeholder:text-white/10">
            <button type="submit" class="absolute right-3 top-3 px-8 py-2.5 bg-white/5 hover:bg-cyan-500 hover:text-black border border-white/10 rounded-2xl text-white font-black uppercase tracking-widest text-xs transition-all">
                Search
            </button>
        </form>

        {% if query %}
        <div class="space-y-6">
            <h3 class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-2 mb-4">Top matches for: "{{ query }}"</h3>
            {% for res in test_results %}
            <div class="p-6 rounded-[2rem] bg-white/[0.02] border border-white/5 hover:border-cyan-500/20 hover:bg-white/[0.04] transition-all group">
                <div class="flex justify-between items-start gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 rounded-lg bg-cyan-500/10 text-cyan-400 text-[9px] font-black uppercase border border-cyan-500/20 tracking-widest">
                            {{ res.type }}
                        </span>
                        <h4 class="font-black text-white group-hover:text-cyan-400 transition-colors tracking-tight text-lg">{{ res.title }}</h4>
                    </div>
                    <div class="px-4 py-2 rounded-xl bg-black/40 border border-white/5 text-center shrink-0">
                         <div class="text-[8px] font-black text-white/20 uppercase tracking-widest mb-0.5">Similarity</div>
                         <div class="text-sm font-black text-cyan-400 tabular-nums">{{ res.score|stringformat:".4f" }}</div>
                    </div>
                </div>
                <div class="text-sm text-white/40 leading-relaxed font-medium italic border-l-2 border-white/5 pl-4 ml-2">
                    {{ res.text|truncatechars:400 }}
                </div>
                <div class="mt-6 flex justify-end">
                    <a href="{{ res.url }}" target="_blank" class="px-5 py-2 rounded-xl bg-white/5 text-[10px] font-black text-white/40 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all uppercase tracking-widest flex items-center gap-2 border border-white/5">
                        Deep dive <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="py-16 text-center border border-dashed border-white/10 rounded-[2rem]">
                <p class="text-[10px] font-black text-white/20 uppercase tracking-widest">No matching context found</p>
                <p class="text-xs text-white/10 mt-2">Try adjusting your search query or re-indexing your documents.</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Sync History -->
    <div class="p-10 rounded-[3rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden" x-data="ragStats()">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-black text-white tracking-tight">Lịch sử đồng bộ</h2>
            <button @click="clearLogs()" class="px-5 py-2.5 rounded-2xl bg-red-500/10 text-red-400 text-[10px] font-black uppercase tracking-widest border border-red-500/20 hover:bg-red-500/20 transition-all flex items-center gap-2">
                <i class="bi bi-trash3"></i> Dọn lịch sử
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-white/5">
                        <th class="px-4 py-4 text-[10px] font-black text-white/40 uppercase tracking-widest">Timestamp</th>
                        <th class="px-4 py-4 text-[10px] font-black text-white/40 uppercase tracking-widest text-center">Status</th>
                        <th class="px-4 py-4 text-[10px] font-black text-white/40 uppercase tracking-widest">Trigger</th>
                        <th class="px-4 py-4 text-[10px] font-black text-white/40 uppercase tracking-widest text-center">Docs</th>
                        <th class="px-4 py-4 text-[10px] font-black text-white/40 uppercase tracking-widest">Diagnostic Details</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/[0.02]">
                    <!-- Live-updated rows from polling -->
                    <template x-if="logs.length > 0">
                        <template x-for="log in logs" :key="log.id">
                            <tr class="group hover:bg-white/[0.02] transition-colors">
                                <td class="px-4 py-5 text-[11px] font-bold text-white/60" x-text="log.started_at"></td>
                                <td class="px-4 py-5">
                                    <div class="flex justify-center">
                                        <span x-show="log.status === 'SUCCESS'" class="px-2.5 py-1 rounded-lg bg-emerald-500/10 text-emerald-400 text-[9px] font-black uppercase border border-emerald-500/20">Success</span>
                                        <span x-show="log.status === 'RUNNING'" class="px-2.5 py-1 rounded-lg bg-cyan-500/10 text-cyan-400 text-[9px] font-black uppercase border border-cyan-500/20 animate-pulse">Syncing...</span>
                                        <span x-show="log.status === 'FAILED'" class="px-2.5 py-1 rounded-lg bg-red-500/10 text-red-400 text-[9px] font-black uppercase border border-red-500/20">Failed</span>
                                    </div>
                                </td>
                                <td class="px-4 py-5 text-[10px] font-black text-white/20 uppercase tracking-widest" x-text="log.trigger"></td>
                                <td class="px-4 py-5 text-sm font-black text-white text-center tabular-nums" x-text="log.documents_count"></td>
                                <td class="px-4 py-5 text-[11px] text-white/30 italic font-medium">
                                    <span x-text="log.error_message"></span>
                                    <span x-show="log.duration" class="text-white/10 ml-2" x-text="'(' + log.duration + ')'"></span>
                                </td>
                            </tr>
                        </template>
                    </template>
                    <!-- Fallback: server-rendered rows (shown before first poll) -->
                    <template x-if="logs.length === 0">
                        <template x-for="(_, i) in Array(0)">
                            <tr></tr>
                        </template>
                    </template>
                    {% for log in logs %}
                    <tr class="group hover:bg-white/[0.02] transition-colors" x-show="logs.length === 0">
                        <td class="px-4 py-5 text-[11px] font-bold text-white/60">{{ log.started_at|date:"d/m/y H:i:s" }}</td>
                        <td class="px-4 py-5">
                            <div class="flex justify-center">
                                {% if log.status == 'SUCCESS' %}
                                    <span class="px-2.5 py-1 rounded-lg bg-emerald-500/10 text-emerald-400 text-[9px] font-black uppercase border border-emerald-500/20">Success</span>
                                {% elif log.status == 'RUNNING' %}
                                    <span class="px-2.5 py-1 rounded-lg bg-cyan-500/10 text-cyan-400 text-[9px] font-black uppercase border border-cyan-500/20 animate-pulse">Syncing...</span>
                                {% else %}
                                    <span class="px-2.5 py-1 rounded-lg bg-red-500/10 text-red-400 text-[9px] font-black uppercase border border-red-500/20 text-center">Failed</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-5 text-[10px] font-black text-white/20 uppercase tracking-widest">{{ log.trigger }}</td>
                        <td class="px-4 py-5 text-sm font-black text-white text-center tabular-nums">{{ log.documents_count }}</td>
                        <td class="px-4 py-5 text-[11px] text-white/30 italic font-medium">
                            {{ log.error_message|default:"" }}
                            {% if log.completed_at %}
                                <span class="text-white/10 ml-2">({{ log.completed_at|timesince:log.started_at }})</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr x-show="logs.length === 0">
                        <td colspan="5" class="py-20 text-center text-white/10 font-black uppercase tracking-widest text-xs italic">No sync logs available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Educational Footer -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
        <div class="p-8 rounded-[2.5rem] bg-gradient-to-br from-cyan-500/5 to-transparent border border-cyan-500/10">
            <h3 class="text-xs font-black text-cyan-400 uppercase tracking-widest mb-4">Tại sao cần Re-index?</h3>
            <p class="text-xs text-white/40 leading-relaxed font-medium">
                Vector Database (FAISS) chuyển hóa kiến thức thành không gian vector đa chiều. Khi dữ liệu thay đổi, Re-index đảm bảo AI có được "trí nhớ" mới nhất và chính xác nhất về các kịch bản lừa đảo hiện nay.
            </p>
        </div>
        <div class="p-8 rounded-[2.5rem] bg-gradient-to-br from-purple-500/5 to-transparent border border-purple-500/10">
            <h3 class="text-xs font-black text-purple-400 uppercase tracking-widest mb-4">Về Celery Workers</h3>
            <p class="text-xs text-white/40 leading-relaxed font-medium">
                Quá trình nhúng (embedding) hàng trăm tài liệu có thể tốn tài nguyên. Hệ thống sử dụng Celery để xử lý ngầm, đảm bảo trang quản trị luôn mượt mà trong khi AI đang bận rộn "học tập".
            </p>
        </div>
    </div>
</div>

<script>
    async function reindexRAG() {
        const btn = document.querySelector('button[onclick="reindexRAG()"]');
        const icon = document.getElementById('reindex-icon');
        
        if (btn.disabled) return;
        
        const result = await Swal.fire({
            title: 'Bắt đầu Re-index?',
            text: "Quá trình này sẽ quét lại toàn bộ kiến thức và cập nhật Vector Database.",
            icon: 'question',
            showCancelButton: true,
            background: '#0d0d1f', color: '#fff',
            confirmButtonColor: '#06b6d4',
            cancelButtonColor: 'rgba(255,255,255,0.05)',
            confirmButtonText: 'Bắt đầu ngay',
            customClass: { popup: 'rounded-[2rem] border border-white/10' }
        });

        if (!result.isConfirmed) return;

        try {
            btn.disabled = true;
            icon.classList.add('animate-spin');
            
            const res = await fetch("{% url 'core:admin-rag-rebuild' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            });
            const data = await res.json();
            
            if (res.ok) {
                showToast(data.message, 'success');
                // Trigger fast polling to show RUNNING status immediately
                document.querySelectorAll('[x-data]').forEach(el => {
                    if (el.__x && el.__x.$data.fastPoll !== undefined) {
                        el.__x.$data.fastPoll = true;
                        el.__x.$data.is_running = true;
                        el.__x.$data.startPolling();
                    } else if (el._x_dataStack) {
                        const d = Alpine.$data(el);
                        if (d && d.fastPoll !== undefined) {
                            d.fastPoll = true;
                            d.is_running = true;
                            d.startPolling();
                        }
                    }
                });
            } else {
                throw new Error(data.error || 'Lỗi không xác định');
            }
        } catch (err) {
            showAlert('Thất bại!', err.message, 'error');
        } finally {
            btn.disabled = false;
            icon.classList.remove('animate-spin');
        }
    }
</script>
{% endblock %}
