{% extends "base.html" %}
{% load static %}

{% block title %}Điều phối Diễn đàn - ShieldCall VN Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10 mt-16 max-w-6xl" x-data="forumAdmin()">
    <div class="flex items-center justify-between mb-12">
        <div class="flex items-center gap-6">
            <a href="{% url 'admin-dashboard' %}" class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white/40 hover:text-cyan-400 hover:border-cyan-500/30 transition-all shadow-lg">
                <i class="bi bi-chevron-left text-2xl"></i>
            </a>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">Điều phối Diễn đàn</h1>
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Quản lý bài viết, báo cáo & nội dung vi phạm</p>
            </div>
        </div>
        <a href="/forum/" target="_blank" class="px-5 py-2.5 rounded-xl bg-white/5 text-white/50 text-[10px] font-black uppercase tracking-widest border border-white/10 hover:border-cyan-500/30 hover:text-cyan-400 transition-all flex items-center gap-2">
            <i class="bi bi-box-arrow-up-right"></i> Xem diễn đàn
        </a>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 p-1.5 rounded-2xl bg-slate-900/60 border border-white/5 backdrop-blur-xl mb-10 w-fit">
        <button @click="tab='posts'" class="px-8 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all"
                :class="tab==='posts' ? 'bg-cyan-500 text-black shadow-lg shadow-cyan-500/20' : 'bg-transparent text-white/40 hover:text-white'">
            <i class="bi bi-chat-square-text mr-1"></i> Bài viết (<span x-text="posts.length"></span>)
        </button>
        <button @click="tab='post_reports'" class="px-8 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all"
                :class="tab==='post_reports' ? 'bg-red-500 text-white shadow-lg shadow-red-500/20' : 'bg-transparent text-white/40 hover:text-white'">
            <i class="bi bi-flag mr-1"></i> Báo cáo bài viết (<span x-text="postReports.length"></span>)
        </button>
        <button @click="tab='comment_reports'" class="px-8 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all"
                :class="tab==='comment_reports' ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'bg-transparent text-white/40 hover:text-white'">
            <i class="bi bi-flag mr-1"></i> Báo cáo bình luận (<span x-text="commentReports.length"></span>)
        </button>
    </div>

    <!-- ═══════ Tab: Posts Management ═══════ -->
    <div x-show="tab==='posts'" x-transition>
        <div class="p-1 rounded-[3rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden shadow-2xl">
            <div class="p-8 border-b border-white/[0.02] flex items-center justify-between">
                <h3 class="text-xs font-black text-white/80 uppercase tracking-widest flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.5)]"></span>
                    Tất cả bài viết
                </h3>
                <input type="text" x-model="postSearch" placeholder="Tìm bài viết..." class="bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm text-white placeholder-white/30 focus:outline-none focus:border-cyan-500/30 w-64">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-separate border-spacing-0">
                    <thead>
                        <tr class="bg-white/[0.02]">
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Bài viết</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Tác giả</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Danh mục</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Tương tác</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Trạng thái</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/[0.02]">
                        <template x-for="post in filteredPosts()" :key="post.id">
                            <tr class="group hover:bg-white/[0.03] transition-all duration-300">
                                <td class="px-6 py-5 max-w-xs">
                                    <a :href="'/forum/' + post.id + '/'" target="_blank" class="text-sm font-bold text-white/80 hover:text-cyan-400 transition-colors leading-snug line-clamp-2" x-text="post.title"></a>
                                    <div class="text-[10px] text-white/30 mt-1" x-text="post.created_at_display"></div>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="flex items-center gap-2">
                                        <div class="w-7 h-7 rounded-full bg-cyan-500/10 border border-cyan-500/20 flex items-center justify-center text-cyan-400 font-bold text-[10px]" x-text="post.author_name?.charAt(0)?.toUpperCase()"></div>
                                        <span class="text-xs font-bold text-white/60" x-text="post.author_name"></span>
                                    </div>
                                </td>
                                <td class="px-6 py-5">
                                    <span class="px-2.5 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest" :class="categoryColor(post.category)" x-text="post.category"></span>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="flex items-center gap-3 text-[10px] text-white/40">
                                        <span><i class="bi bi-heart-fill text-red-400/50 mr-1"></i><span x-text="post.likes_count || 0"></span></span>
                                        <span><i class="bi bi-chat-left mr-1"></i><span x-text="post.comments_count || 0"></span></span>
                                        <span><i class="bi bi-eye mr-1"></i><span x-text="post.views_count || 0"></span></span>
                                    </div>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="flex flex-wrap gap-1">
                                        <span x-show="post.is_pinned" class="px-2 py-0.5 rounded bg-yellow-500/15 text-yellow-500 text-[9px] font-black uppercase">Ghim</span>
                                        <span x-show="post.is_locked" class="px-2 py-0.5 rounded bg-red-500/15 text-red-500 text-[9px] font-black uppercase">Khóa</span>
                                        <span x-show="!post.is_pinned && !post.is_locked" class="px-2 py-0.5 rounded bg-green-500/15 text-green-500 text-[9px] font-black uppercase">Bình thường</span>
                                    </div>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                        <button @click="postAction(post.id, 'pin')" class="h-8 px-3 rounded-lg bg-white/5 text-[10px] font-bold border border-white/10 hover:border-yellow-500/30 hover:text-yellow-400 transition-all" :title="post.is_pinned ? 'Bỏ ghim' : 'Ghim'">
                                            <i class="bi" :class="post.is_pinned ? 'bi-pin-angle-fill text-yellow-500' : 'bi-pin-angle text-white/40'"></i>
                                        </button>
                                        <button @click="postAction(post.id, 'lock')" class="h-8 px-3 rounded-lg bg-white/5 text-[10px] font-bold border border-white/10 hover:border-orange-500/30 hover:text-orange-400 transition-all" :title="post.is_locked ? 'Mở khóa' : 'Khóa'">
                                            <i class="bi" :class="post.is_locked ? 'bi-lock-fill text-orange-500' : 'bi-unlock text-white/40'"></i>
                                        </button>
                                        <button @click="confirmDeletePost(post)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-red-500/30 hover:text-red-500 transition-all" title="Xóa">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-if="filteredPosts().length === 0">
                            <tr><td colspan="6" class="px-8 py-16 text-center text-white/20 italic text-xs font-bold">Không có bài viết nào.</td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══════ Tab: Post Reports ═══════ -->
    <div x-show="tab==='post_reports'" x-transition>
        <div class="p-1 rounded-[3rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden shadow-2xl">
            <div class="p-8 border-b border-white/[0.02]">
                <h3 class="text-xs font-black text-white/80 uppercase tracking-widest flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></span>
                    Báo cáo bài viết
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-separate border-spacing-0">
                    <thead>
                        <tr class="bg-white/[0.02]">
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Thời gian</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Người báo cáo</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Bài viết / Lý do</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">AI Analysis</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Trạng thái</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/[0.02]">
                        <template x-for="r in postReports" :key="r.id">
                            <tr class="group hover:bg-white/[0.03] transition-all duration-300">
                                <td class="px-6 py-6 text-[11px] font-bold text-white/60 whitespace-nowrap" x-text="r.created_at_display"></td>
                                <td class="px-6 py-6">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold text-xs" x-text="r.reporter_name?.charAt(0)?.toUpperCase()"></div>
                                        <span class="text-sm font-black text-white tracking-tight" x-text="r.reporter_name"></span>
                                    </div>
                                </td>
                                <td class="px-6 py-6 max-w-xs">
                                    <div class="text-sm font-bold text-white/80 leading-snug mb-1" x-text="r.post_title"></div>
                                    <div class="text-[10px] text-white/30 italic" x-text="'Lý do: ' + (r.reason || '—')"></div>
                                </td>
                                <td class="px-6 py-6">
                                    <template x-if="r.ai_status === 'analyzing'">
                                        <div class="flex items-center gap-2 text-yellow-400">
                                            <i class="bi bi-cpu animate-pulse"></i>
                                            <span class="text-[10px] font-black uppercase tracking-widest">Đang phân tích...</span>
                                        </div>
                                    </template>
                                    <template x-if="r.ai_violation === true">
                                        <div class="flex flex-col gap-1">
                                            <div class="flex items-center gap-2 text-rose-500">
                                                <div class="w-1.5 h-1.5 rounded-full bg-rose-500 animate-pulse"></div>
                                                <span class="text-[10px] font-black uppercase tracking-widest">Vi phạm</span>
                                            </div>
                                            <div class="text-[9px] text-white/30 font-bold" x-text="'Conf: ' + (r.ai_confidence || '—')"></div>
                                        </div>
                                    </template>
                                    <template x-if="r.ai_violation === false">
                                        <div class="flex items-center gap-2 text-emerald-500">
                                            <i class="bi bi-shield-check text-sm"></i>
                                            <span class="text-[10px] font-black uppercase tracking-widest">An toàn</span>
                                        </div>
                                    </template>
                                    <template x-if="r.ai_status === 'none'">
                                        <div class="flex items-center gap-2 text-white/20">
                                            <i class="bi bi-dash-circle text-sm"></i>
                                            <span class="text-[10px] font-black uppercase tracking-widest">Chưa quét</span>
                                        </div>
                                    </template>
                                </td>
                                <td class="px-6 py-6">
                                    <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase border tracking-widest"
                                          :class="r.status === 'approved' ? 'bg-green-500/10 text-green-500 border-green-500/20' : r.status === 'rejected' ? 'bg-red-500/10 text-red-500 border-red-500/20' : 'bg-white/5 text-white/40 border-white/10'"
                                          x-text="r.status"></span>
                                </td>
                                <td class="px-6 py-6">
                                    <div class="flex justify-end gap-2" :class="r.status === 'pending' ? '' : 'opacity-30 pointer-events-none'">
                                        <button @click="reportAction('post', r.id, 'analyze', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-blue-500/30 hover:text-blue-400 transition-all" title="AI Phân tích">
                                            <i class="bi bi-cpu"></i>
                                        </button>
                                        <button @click="reportAction('post', r.id, 'approve', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-green-500/30 hover:text-green-400 transition-all" title="Chấp thuận">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button @click="reportAction('post', r.id, 'reject', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-red-500/30 hover:text-red-400 transition-all" title="Từ chối">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-if="postReports.length === 0">
                            <tr><td colspan="6" class="px-8 py-16 text-center text-white/20 italic text-xs font-bold">Không có báo cáo bài viết nào.</td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══════ Tab: Comment Reports ═══════ -->
    <div x-show="tab==='comment_reports'" x-transition>
        <div class="p-1 rounded-[3rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden shadow-2xl">
            <div class="p-8 border-b border-white/[0.02]">
                <h3 class="text-xs font-black text-white/80 uppercase tracking-widest flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></span>
                    Báo cáo bình luận
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-separate border-spacing-0">
                    <thead>
                        <tr class="bg-white/[0.02]">
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Thời gian</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Người báo cáo</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Nội dung bình luận</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">Trạng thái</th>
                            <th class="px-6 py-5 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/[0.02]">
                        <template x-for="r in commentReports" :key="r.id">
                            <tr class="group hover:bg-white/[0.03] transition-all duration-300">
                                <td class="px-6 py-6 text-[11px] font-bold text-white/60 whitespace-nowrap" x-text="r.created_at_display"></td>
                                <td class="px-6 py-6">
                                    <span class="text-sm font-black text-white tracking-tight" x-text="r.reporter_name"></span>
                                </td>
                                <td class="px-6 py-6 max-w-sm">
                                    <div class="text-[11px] font-bold text-white/50 leading-relaxed italic line-clamp-3" x-text="'\"' + r.comment_content + '\"'"></div>
                                    <div class="text-[9px] text-white/20 mt-1" x-text="'Lý do: ' + (r.reason || '—')"></div>
                                </td>
                                <td class="px-6 py-6">
                                    <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase border tracking-widest"
                                          :class="r.status === 'approved' ? 'bg-green-500/10 text-green-500 border-green-500/20' : r.status === 'rejected' ? 'bg-red-500/10 text-red-500 border-red-500/20' : 'bg-white/5 text-white/40 border-white/10'"
                                          x-text="r.status"></span>
                                </td>
                                <td class="px-6 py-6">
                                    <div class="flex justify-end gap-2" :class="r.status === 'pending' ? '' : 'opacity-30 pointer-events-none'">
                                        <button @click="reportAction('comment', r.id, 'analyze', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-blue-500/30 hover:text-blue-400 transition-all" title="AI Phân tích">
                                            <i class="bi bi-cpu"></i>
                                        </button>
                                        <button @click="reportAction('comment', r.id, 'approve', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-green-500/30 hover:text-green-400 transition-all" title="Chấp thuận">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button @click="reportAction('comment', r.id, 'reject', r)" class="h-8 px-3 rounded-lg bg-white/5 text-white/40 text-[10px] font-bold border border-white/10 hover:border-red-500/30 hover:text-red-400 transition-all" title="Từ chối">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-if="commentReports.length === 0">
                            <tr><td colspan="5" class="px-8 py-16 text-center text-white/20 italic text-xs font-bold">Không có báo cáo bình luận nào.</td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{{ posts_json|json_script:"forum-posts-json" }}
{{ post_reports_json|json_script:"forum-post-reports-json" }}
{{ comment_reports_json|json_script:"forum-comment-reports-json" }}
{% endblock %}

{% block extra_js %}
<script>
function forumAdmin() {
    return {
        tab: 'posts',
        posts: [],
        postReports: [],
        commentReports: [],
        postSearch: '',

        init() {
            try {
                const p = document.getElementById('forum-posts-json');
                const pr = document.getElementById('forum-post-reports-json');
                const cr = document.getElementById('forum-comment-reports-json');
                if (p) this.posts = JSON.parse(p.textContent);
                if (pr) this.postReports = JSON.parse(pr.textContent);
                if (cr) this.commentReports = JSON.parse(cr.textContent);
            } catch (e) { console.error('Forum admin data parse error:', e); }
        },

        filteredPosts() {
            if (!this.postSearch.trim()) return this.posts;
            const q = this.postSearch.toLowerCase();
            return this.posts.filter(p => (p.title || '').toLowerCase().includes(q) || (p.author_name || '').toLowerCase().includes(q));
        },

        categoryColor(cat) {
            const map = {
                warning: 'bg-red-500/20 text-red-500',
                discussion: 'bg-cyan-500/20 text-cyan-500',
                experience: 'bg-purple-500/20 text-purple-500',
                question: 'bg-yellow-500/20 text-yellow-500',
            };
            return map[cat] || 'bg-white/10 text-white/40';
        },

        async postAction(postId, action) {
            try {
                const resp = await fetch('/admin-cp/forum/post/' + postId + '/action/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ action })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'ok') {
                    showToast(data.message, 'success');
                    const post = this.posts.find(p => p.id === postId);
                    if (post) {
                        if (action === 'pin') post.is_pinned = data.is_pinned;
                        if (action === 'lock') post.is_locked = data.is_locked;
                        if (action === 'delete') this.posts = this.posts.filter(p => p.id !== postId);
                    }
                } else {
                    showToast(data.error || 'Lỗi', 'error');
                }
            } catch (e) {
                showToast('Lỗi kết nối', 'error');
            }
        },

        async confirmDeletePost(post) {
            const ok = await Swal.fire({
                title: 'Xóa bài viết?',
                html: '<p class="text-white/50 text-sm">' + post.title + '</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonText: 'Hủy',
                confirmButtonText: 'Xóa',
                background: '#161235',
                color: '#fff',
            });
            if (ok.isConfirmed) this.postAction(post.id, 'delete');
        },

        async reportAction(type, reportId, action, report) {
            try {
                if (action === 'analyze') report.ai_status = 'analyzing';
                const resp = await fetch('/admin-cp/forum/report/' + type + '/' + reportId + '/action/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ action })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'ok') {
                    showToast(data.message, 'success');
                    if (action === 'approve') report.status = 'approved';
                    if (action === 'reject') report.status = 'rejected';
                } else {
                    showToast(data.error || 'Lỗi', 'error');
                    if (action === 'analyze') report.ai_status = 'none';
                }
            } catch (e) {
                showToast('Lỗi kết nối', 'error');
                if (action === 'analyze') report.ai_status = 'none';
            }
        }
    };
}
</script>
{% endblock %}
