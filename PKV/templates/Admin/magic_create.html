{% extends "base.html" %}
{% block title %}Magic Create - AI T·∫°o B√†i H·ªçc{% endblock %}

{% block head_extra %}
<style>
    .magic-input {
        width: 100%;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        color: white;
        font-size: 0.875rem;
        line-height: 1.6;
        transition: all 0.3s;
        resize: vertical;
    }
    .magic-input:focus { border-color: #8b5cf6; outline: none; background: rgba(15,23,42,0.6); }
    .magic-input::placeholder { color: rgba(255,255,255,0.2); }

    .stream-section {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 1.5rem;
        overflow: hidden;
        transition: all 0.3s;
    }
    .stream-section.active { border-color: rgba(139,92,246,0.3); box-shadow: 0 0 30px rgba(139,92,246,0.05); }
    .stream-section.done { border-color: rgba(34,197,94,0.3); }

    .stream-header {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: rgba(255,255,255,0.02);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .stream-body { padding: 1.5rem; min-height: 100px; }

    .stage-dot {
        width: 10px; height: 10px; border-radius: 50%;
        background: rgba(255,255,255,0.1);
        transition: all 0.3s;
    }
    .stage-dot.active { background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; animation: pulse-dot 1.5s infinite; }
    .stage-dot.done { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.3); }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.3); }
    }

    .quiz-card {
        background: rgba(168,85,247,0.05);
        border: 1px solid rgba(168,85,247,0.1);
        border-radius: 1rem;
        padding: 1rem;
        transition: all 0.3s;
    }
    .quiz-card:hover { border-color: rgba(168,85,247,0.3); }

    .step-bubble {
        display: flex; gap: 0.75rem; align-items: flex-start;
        padding: 0.5rem 0;
    }
    .step-avatar {
        width: 28px; height: 28px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; flex-shrink: 0;
    }
    .step-avatar.scammer { background: rgba(239,68,68,0.15); }
    .step-avatar.victim { background: rgba(59,130,246,0.15); }
    .step-avatar.narrator { background: rgba(168,85,247,0.15); }

    .content-preview { color: rgba(255,255,255,0.7); font-size: 0.8rem; line-height: 1.7; }
    .content-preview h2 { color: #22d3ee; font-size: 1rem; font-weight: 800; margin: 1rem 0 0.5rem; }
    .content-preview h3 { color: rgba(255,255,255,0.8); font-size: 0.9rem; font-weight: 700; margin: 0.75rem 0 0.3rem; }
    .content-preview ul { padding-left: 1.5rem; }
    .content-preview li { margin: 0.2rem 0; }
    .content-preview p { margin: 0.4rem 0; }
    .content-preview strong { color: white; }
    .content-preview blockquote { border-left: 3px solid #8b5cf6; padding-left: 1rem; color: rgba(255,255,255,0.5); margin: 0.5rem 0; }

    .typing-indicator { display: inline-flex; gap: 3px; align-items: center; padding: 4px 0; }
    .typing-indicator span {
        width: 6px; height: 6px; border-radius: 50%;
        background: #8b5cf6; opacity: 0.4;
        animation: typing-bounce 1.2s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-bounce {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-4px); opacity: 1; }
    }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 mt-16" x-data="magicCreate()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <a href="{% url 'admin-manage-learn' %}" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-white/40 hover:text-purple-400 hover:border-purple-500/30 transition-all">
                <i class="bi bi-chevron-left"></i>
            </a>
            <div>
                <h1 class="text-2xl font-black text-white tracking-tight flex items-center gap-3">
                    <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-lg shadow-lg shadow-purple-500/20">‚ö°</span>
                    Magic Create
                </h1>
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">AI t·∫°o b√†i h·ªçc ¬∑ 5 quiz ¬∑ k·ªãch b·∫£n h·ªôi tho·∫°i t·ª± ƒë·ªông</p>
            </div>
        </div>
    </div>

    <!-- Input Section -->
    <div x-show="stage === 'input'" x-transition class="max-w-3xl mx-auto space-y-6">
        <div class="liquid-card p-8 border-white/5 bg-slate-900/40 space-y-6">
            <div class="text-center space-y-2">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-600/20 to-blue-600/20 border border-purple-500/20 flex items-center justify-center mx-auto mb-4">
                    <i class="bi bi-magic text-2xl text-purple-400"></i>
                </div>
                <h2 class="text-lg font-black text-white">D√°n vƒÉn b·∫£n ngu·ªìn</h2>
                <p class="text-xs text-white/30 max-w-md mx-auto">D√°n b√†i b√°o, tin t·ª©c, t√†i li·ªáu v·ªÅ l·ª´a ƒë·∫£o. AI s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch v√† t·∫°o b√†i h·ªçc ƒë·∫ßy ƒë·ªß v·ªõi n·ªôi dung, quiz ki·ªÉm tra v√† k·ªãch b·∫£n m√¥ ph·ªèng.</p>
            </div>

            <textarea x-model="rawText" class="magic-input" rows="10" placeholder="V√≠ d·ª•: C√¥ng an v·ª´a tri·ªát ph√° ƒë∆∞·ªùng d√¢y l·ª´a ƒë·∫£o qua m·∫°ng v·ªõi th·ªß ƒëo·∫°n gi·∫£ danh nh√¢n vi√™n ng√¢n h√†ng g·ªçi ƒëi·ªán y√™u c·∫ßu cung c·∫•p OTP. N·∫°n nh√¢n l√† m·ªôt ph·ª• n·ªØ 45 tu·ªïi ƒë√£ chuy·ªÉn 500 tri·ªáu ƒë·ªìng cho k·∫ª gian..."></textarea>

            <div class="flex items-center justify-between">
                <span class="text-[10px] text-white/20" x-text="rawText.length + ' k√Ω t·ª±'"></span>
                <button @click="startCreate()" :disabled="!rawText.trim() || creating" class="px-8 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-black uppercase tracking-widest transition-all shadow-lg shadow-purple-500/20 disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="bi bi-lightning-charge-fill"></i>
                    B·∫Øt ƒë·∫ßu s√°ng t·∫°o
                </button>
            </div>
        </div>
    </div>

    <!-- Streaming Results Section -->
    <div x-show="stage === 'streaming' || stage === 'done'" x-transition>
        <!-- Progress Bar -->
        <div class="mb-8 space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <template x-for="(s, i) in stageNames" :key="i">
                        <div class="flex items-center gap-2">
                            <div class="stage-dot" :class="{ 'active': currentStep === i+1 && stage !== 'done', 'done': currentStep > i+1 || stage === 'done' }"></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider" :class="currentStep >= i+1 ? 'text-white/60' : 'text-white/20'" x-text="s"></span>
                            <template x-if="i < stageNames.length - 1">
                                <div class="w-8 h-px" :class="currentStep > i+1 || stage === 'done' ? 'bg-green-500/30' : 'bg-white/5'"></div>
                            </template>
                        </div>
                    </template>
                </div>
                <span class="text-[10px] font-black text-white/30" x-text="statusMsg"></span>
            </div>
            <div class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                <div class="h-full rounded-full transition-all duration-700" :class="stage === 'done' ? 'bg-green-500' : 'bg-gradient-to-r from-purple-500 to-cyan-500'" :style="'width:' + progressPct + '%'"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Main Content Column -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Lesson Content Stream -->
                <div class="stream-section" :class="{ 'active': currentStep === 2, 'done': currentStep > 2 || stage === 'done' }">
                    <div class="stream-header">
                        <i class="bi bi-journal-text text-cyan-400"></i>
                        <span class="text-xs font-black text-white/60 uppercase tracking-widest">N·ªôi dung b√†i h·ªçc</span>
                        <template x-if="currentStep === 2 && stage !== 'done'"><span class="typing-indicator ml-auto"><span></span><span></span><span></span></span></template>
                        <template x-if="currentStep > 2 || stage === 'done'"><span class="ml-auto text-[10px] text-green-400 font-bold">‚úì Xong</span></template>
                    </div>
                    <div class="stream-body">
                        <template x-if="!result.title && currentStep < 2"><p class="text-white/10 text-xs italic">ƒêang ch·ªù AI...</p></template>
                        <template x-if="result.title">
                            <div class="fade-in">
                                <h3 class="text-lg font-black text-white mb-1" x-text="result.title"></h3>
                                <span class="inline-flex px-2.5 py-0.5 rounded-full bg-blue-500/10 text-blue-400 text-[9px] font-black uppercase border border-blue-500/10 mb-3" x-text="result.category"></span>
                            </div>
                        </template>
                        <div class="content-preview" x-html="result.content || ''"></div>
                    </div>
                </div>

                <!-- Scenario Stream -->
                <div class="stream-section" :class="{ 'active': currentStep === 4, 'done': currentStep > 4 || stage === 'done' }">
                    <div class="stream-header">
                        <i class="bi bi-chat-dots text-blue-400"></i>
                        <span class="text-xs font-black text-white/60 uppercase tracking-widest">K·ªãch b·∫£n h·ªôi tho·∫°i</span>
                        <span class="ml-auto text-[9px] text-white/20" x-text="scenarioSteps.length ? scenarioSteps.length + ' b∆∞·ªõc' : ''"></span>
                        <template x-if="currentStep === 4 && stage !== 'done'"><span class="typing-indicator"><span></span><span></span><span></span></span></template>
                        <template x-if="currentStep > 4 || stage === 'done'"><span class="text-[10px] text-green-400 font-bold">‚úì Xong</span></template>
                    </div>
                    <div class="stream-body">
                        <template x-if="!result.scenario && currentStep < 4"><p class="text-white/10 text-xs italic">ƒêang ch·ªù t·∫°o k·ªãch b·∫£n...</p></template>
                        <template x-if="result.scenario">
                            <div class="fade-in space-y-2">
                                <h4 class="text-sm font-bold text-white" x-text="result.scenario.title"></h4>
                                <p class="text-[10px] text-white/30" x-text="result.scenario.description"></p>
                                <div class="space-y-0.5 mt-3">
                                    <template x-for="(step, si) in scenarioSteps" :key="si">
                                        <div class="step-bubble fade-in">
                                            <div class="step-avatar" :class="step.speaker">
                                                <span x-text="step.speaker === 'scammer' ? 'ü¶π' : step.speaker === 'victim' ? 'üë§' : 'üìù'"></span>
                                            </div>
                                            <div class="flex-1">
                                                <span class="text-[9px] font-black uppercase tracking-widest" :class="step.speaker === 'scammer' ? 'text-red-400' : step.speaker === 'victim' ? 'text-blue-400' : 'text-purple-400'" x-text="step.speaker === 'scammer' ? 'K·∫ª l·ª´a ƒë·∫£o' : step.speaker === 'victim' ? 'N·∫°n nh√¢n' : 'T∆∞·ªùng thu·∫≠t'"></span>
                                                <p class="text-xs text-white/70" x-text="step.text"></p>
                                                <template x-if="step.note">
                                                    <p class="text-[10px] text-purple-400/60 italic mt-0.5"><i class="bi bi-info-circle mr-1"></i><span x-text="step.note"></span></p>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Sidebar: Quizzes Stream -->
            <div class="lg:col-span-4 space-y-6">
                <div class="stream-section sticky top-24" :class="{ 'active': currentStep === 3, 'done': currentStep > 3 || stage === 'done' }">
                    <div class="stream-header">
                        <i class="bi bi-list-check text-purple-400"></i>
                        <span class="text-xs font-black text-white/60 uppercase tracking-widest">Quiz ki·ªÉm tra</span>
                        <span class="ml-auto text-[9px] text-white/20" x-text="quizzes.length ? quizzes.length + ' c√¢u' : ''"></span>
                        <template x-if="currentStep === 3 && stage !== 'done'"><span class="typing-indicator"><span></span><span></span><span></span></span></template>
                    </div>
                    <div class="stream-body space-y-3">
                        <template x-if="quizzes.length === 0 && currentStep < 3"><p class="text-white/10 text-xs italic">ƒêang ch·ªù t·∫°o quiz...</p></template>
                        <template x-for="(q, qi) in quizzes" :key="qi">
                            <div class="quiz-card fade-in">
                                <div class="flex items-start gap-2 mb-2">
                                    <span class="w-5 h-5 rounded-md bg-purple-500/20 text-purple-400 text-[10px] font-black flex items-center justify-center flex-shrink-0" x-text="qi + 1"></span>
                                    <p class="text-xs text-white/80 font-bold" x-text="q.question"></p>
                                </div>
                                <div class="space-y-1 ml-7">
                                    <template x-for="(opt, oi) in q.options" :key="oi">
                                        <div class="text-[10px] px-2 py-1 rounded-lg" :class="opt === q.correct_answer ? 'bg-green-500/15 text-green-400 border border-green-500/20' : 'bg-white/[0.03] text-white/40 border border-white/5'">
                                            <span x-text="String.fromCharCode(65 + oi) + '. ' + opt"></span>
                                            <template x-if="opt === q.correct_answer"><i class="bi bi-check-circle-fill ml-1"></i></template>
                                        </div>
                                    </template>
                                </div>
                                <template x-if="q.explanation">
                                    <p class="text-[10px] text-white/30 italic mt-2 ml-7"><i class="bi bi-lightbulb mr-1 text-yellow-500"></i><span x-text="q.explanation"></span></p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div x-show="stage === 'done'" x-transition class="space-y-3">
                    <button @click="saveDraft()" :disabled="saving" class="w-full py-3.5 rounded-xl bg-green-600 hover:bg-green-500 text-white font-black uppercase tracking-widest transition-all shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 disabled:opacity-50">
                        <i class="bi bi-cloud-arrow-up-fill text-lg"></i>
                        <span x-text="saving ? 'ƒêang l∆∞u...' : 'L∆∞u b·∫£n nh√°p'"></span>
                    </button>
                    <button @click="stage = 'input'; resetResult()" class="w-full py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white/50 font-bold transition-all border border-white/5 flex items-center justify-center gap-2">
                        <i class="bi bi-arrow-repeat"></i> L√†m l·∫°i
                    </button>
                </div>

                <!-- Log -->
                <div class="stream-section" x-show="logs.length > 0">
                    <div class="stream-header">
                        <i class="bi bi-terminal text-white/30"></i>
                        <span class="text-[10px] font-black text-white/30 uppercase tracking-widest">Log</span>
                    </div>
                    <div class="stream-body max-h-40 overflow-y-auto space-y-1 custom-scrollbar">
                        <template x-for="(log, li) in logs" :key="li">
                            <div class="text-[10px] font-mono" :class="log.type === 'error' ? 'text-red-400' : log.type === 'success' ? 'text-green-400' : 'text-cyan-400/50'">
                                <span class="text-white/10" x-text="log.time"></span>
                                <span x-text="log.msg"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function magicCreate() {
    return {
        stage: 'input',  // input | streaming | done
        rawText: '',
        creating: false,
        saving: false,
        currentStep: 0,
        progressPct: 0,
        statusMsg: '',
        result: {},
        quizzes: [],
        scenarioSteps: [],
        logs: [],
        ws: null,
        taskId: null,
        pingInterval: null,
        reconnectAttempts: 0,
        maxReconnects: 10,
        stageNames: ['Ph√¢n t√≠ch', 'N·ªôi dung', 'Quiz', 'K·ªãch b·∫£n', 'Ho√†n th√†nh'],

        addLog(msg, type = 'info') {
            const now = new Date();
            this.logs.push({ time: now.toLocaleTimeString(), msg, type });
        },

        resetResult() {
            this.result = {};
            this.quizzes = [];
            this.scenarioSteps = [];
            this.logs = [];
            this.currentStep = 0;
            this.progressPct = 0;
            this.statusMsg = '';
            this.creating = false;
            this.reconnectAttempts = 0;
            this.stopPing();
            if (this.ws) { this.ws.close(); this.ws = null; }
        },

        stopPing() {
            if (this.pingInterval) { clearInterval(this.pingInterval); this.pingInterval = null; }
        },

        startPing() {
            this.stopPing();
            this.pingInterval = setInterval(() => {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        },

        async startCreate() {
            if (!this.rawText.trim()) return;
            this.creating = true;
            this.stage = 'streaming';
            this.resetResult();
            this.creating = true; // re-set after reset
            this.addLog('G·ª≠i y√™u c·∫ßu t·ªõi server...');

            try {
                const resp = await fetch('/api/v1/admin/learn/ai-generate/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRF() },
                    body: JSON.stringify({ text: this.rawText })
                });
                const res = await resp.json();

                if (!resp.ok || res.status === 'error') {
                    this.addLog('L·ªói: ' + (res.message || 'Server error'), 'error');
                    this.stage = 'input';
                    this.creating = false;
                    return;
                }

                this.taskId = res.task_id;
                this.addLog('Task ID: ' + this.taskId);
                this.connectWS(this.taskId);
            } catch (e) {
                this.addLog('L·ªói k·∫øt n·ªëi: ' + e.message, 'error');
                this.stage = 'input';
                this.creating = false;
            }
        },

        connectWS(taskId) {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            const url = `${proto}://${location.host}/ws/task/${taskId}/`;
            this.ws = new WebSocket(url);
            this.addLog('WebSocket ƒëang k·∫øt n·ªëi...');

            this.ws.onopen = () => {
                this.reconnectAttempts = 0;
                this.startPing();
                this.addLog('WebSocket ƒë√£ k·∫øt n·ªëi', 'success');
            };

            this.ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'pong') return; // ping/pong keepalive
                this.handleWSMessage(msg);
            };

            this.ws.onerror = () => {
                this.addLog('WebSocket l·ªói k·∫øt n·ªëi', 'error');
            };

            this.ws.onclose = (ev) => {
                this.stopPing();
                // Auto-reconnect if task is still running (not done/error)
                if (this.creating && this.stage === 'streaming' && this.reconnectAttempts < this.maxReconnects) {
                    this.reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts - 1), 15000);
                    this.addLog(`WebSocket ƒë√≥ng ‚Äî t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i (${this.reconnectAttempts}/${this.maxReconnects}) sau ${(delay/1000).toFixed(0)}s...`, 'error');
                    setTimeout(() => this.connectWS(taskId), delay);
                } else if (this.creating) {
                    this.addLog('WebSocket ƒë√£ ƒë√≥ng, v∆∞·ª£t qu√° s·ªë l·∫ßn retry.', 'error');
                } else {
                    this.addLog('WebSocket ƒë√£ ƒë√≥ng');
                }
            };
        },

        handleWSMessage(msg) {
            if (msg.status === 'processing') {
                this.currentStep = msg.step || this.currentStep;
                this.statusMsg = msg.message || '';
                this.progressPct = msg.step ? Math.min(msg.step / 5 * 90 + 5, 95) : this.progressPct;
                this.addLog(msg.message);

                // Handle partial data sent at each stage
                if (msg.data) {
                    if (msg.data.title) this.result.title = msg.data.title;
                    if (msg.data.category) this.result.category = msg.data.category;
                    if (msg.data.content) this.result.content = msg.data.content;
                    if (msg.data.quizzes) {
                        this.quizzes = msg.data.quizzes;
                    }
                    if (msg.data.scenario) {
                        this.result.scenario = msg.data.scenario;
                        this.scenarioSteps = msg.data.scenario?.content_json?.steps || [];
                    }
                }
            } else if (msg.status === 'done' && msg.data) {
                this.result = msg.data;
                this.quizzes = msg.data.quizzes || (msg.data.quiz ? [msg.data.quiz] : []);
                if (msg.data.scenario) {
                    this.scenarioSteps = msg.data.scenario?.content_json?.steps || [];
                }
                this.currentStep = 5;
                this.progressPct = 100;
                this.statusMsg = '‚úÖ Ho√†n th√†nh!';
                this.stage = 'done';
                this.creating = false;
                this.addLog('T·∫°o b√†i h·ªçc th√†nh c√¥ng!', 'success');
                this.stopPing();
                if (this.ws) this.ws.close();
            } else if (msg.status === 'error') {
                this.addLog('L·ªói: ' + msg.message, 'error');
                this.statusMsg = '‚ùå ' + msg.message;
                this.creating = false;
                this.stopPing();
                if (this.ws) this.ws.close();
            }
        },

        async saveDraft() {
            this.saving = true;
            try {
                const payload = {
                    title: this.result.title,
                    content: this.result.content,
                    category: this.result.category,
                    quizzes: this.quizzes,
                    scenario: this.result.scenario
                };
                const resp = await fetch('/api/v1/admin/learn/magic-save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRF() },
                    body: JSON.stringify(payload)
                });
                const res = await resp.json();
                if (resp.ok) {
                    this.addLog('ƒê√£ l∆∞u th√†nh c√¥ng! Lesson ID: ' + res.lesson_id, 'success');
                    await Swal.fire({
                        icon: 'success',
                        title: 'ƒê√£ l∆∞u b·∫£n nh√°p!',
                        html: `<p class="text-white/40 text-sm">B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.</p>`,
                        background: '#0d0d1f',
                        color: '#fff',
                        timer: 2000,
                        showConfirmButton: false,
                        customClass: { popup: 'rounded-[2rem] border border-white/10' }
                    });
                    window.location.href = '{% url "admin-manage-learn" %}';
                } else {
                    this.addLog('L·ªói l∆∞u: ' + (res.message || 'Unknown'), 'error');
                    Swal.fire({ icon: 'error', title: 'L·ªói', text: res.message || 'Kh√¥ng th·ªÉ l∆∞u', background: '#0d0d1f', color: '#fff', customClass: { popup: 'rounded-[2rem] border border-white/10' } });
                }
            } catch (e) {
                this.addLog('L·ªói k·∫øt n·ªëi: ' + e.message, 'error');
            }
            this.saving = false;
        },

        getCSRF() {
            const c = document.cookie.split(';');
            for (let ck of c) {
                const [n, v] = ck.trim().split('=');
                if (n === 'csrftoken') return v;
            }
            return '';
        }
    };
}
</script>
{% endblock %}
