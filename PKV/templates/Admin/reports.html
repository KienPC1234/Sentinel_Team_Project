{% extends "base.html" %}
{% load static %}

{% block title %}Qu·∫£n l√Ω B√°o c√°o - ShieldCall VN Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10 mt-16 max-w-7xl space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6" data-aos="fade-up">
        <div class="flex items-center gap-6">
            <a href="{% url 'admin-dashboard' %}" class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white/40 hover:text-cyan-400 hover:border-cyan-500/30 transition-all shadow-lg">
                <i class="bi bi-chevron-left text-2xl"></i>
            </a>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">B√°o c√°o C·ªông ƒë·ªìng</h1>
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Qu·∫£n l√Ω ph·∫£n h·ªìi v√† b√°o l·ª´a ƒë·∫£o</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3" data-aos="fade-up" data-aos-delay="100">
        <div class="liquid-card p-4 text-center space-y-1">
            <div class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center mx-auto">
                <i class="bi bi-file-earmark-text text-white/40 text-sm"></i>
            </div>
            <p class="text-xl font-black text-white">{{ stats.total }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">T·ªïng</p>
        </div>
        <div class="liquid-card p-4 text-center space-y-1 cursor-pointer hover:border-yellow-500/30 transition-all{% if status_filter == 'pending' %} border-yellow-500/30 bg-yellow-500/[0.03]{% endif %}" onclick="location.href='?status=pending'">
            <div class="w-9 h-9 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center mx-auto">
                <i class="bi bi-clock text-yellow-500 text-sm"></i>
            </div>
            <p class="text-xl font-black text-yellow-400">{{ stats.pending }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">Ch·ªù duy·ªát</p>
        </div>
        <div class="liquid-card p-4 text-center space-y-1 cursor-pointer hover:border-emerald-500/30 transition-all{% if status_filter == 'approved' %} border-emerald-500/30 bg-emerald-500/[0.03]{% endif %}" onclick="location.href='?status=approved'">
            <div class="w-9 h-9 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center mx-auto">
                <i class="bi bi-check-circle text-emerald-400 text-sm"></i>
            </div>
            <p class="text-xl font-black text-emerald-400">{{ stats.approved }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">ƒê√£ duy·ªát</p>
        </div>
        <div class="liquid-card p-4 text-center space-y-1 cursor-pointer hover:border-red-500/30 transition-all{% if status_filter == 'rejected' %} border-red-500/30 bg-red-500/[0.03]{% endif %}" onclick="location.href='?status=rejected'">
            <div class="w-9 h-9 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center justify-center mx-auto">
                <i class="bi bi-x-circle text-red-400 text-sm"></i>
            </div>
            <p class="text-xl font-black text-red-400">{{ stats.rejected }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">T·ª´ ch·ªëi</p>
        </div>
        <div class="liquid-card p-4 text-center space-y-1">
            <div class="w-9 h-9 rounded-xl bg-orange-500/10 border border-orange-500/20 flex items-center justify-center mx-auto">
                <i class="bi bi-exclamation-triangle text-orange-400 text-sm"></i>
            </div>
            <p class="text-xl font-black text-orange-400">{{ stats.high_severity }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">Nghi√™m tr·ªçng</p>
        </div>
        <div class="liquid-card p-4 text-center space-y-1">
            <div class="w-9 h-9 rounded-xl bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mx-auto">
                <i class="bi bi-robot text-purple-400 text-sm"></i>
            </div>
            <p class="text-xl font-black text-purple-400">{{ stats.has_ai }}</p>
            <p class="text-[8px] font-bold text-white/25 uppercase tracking-widest">AI ƒë√£ ph√¢n t√≠ch</p>
        </div>
    </div>

    <!-- Filter Bar -->
    <form id="report-filter-form" method="GET" class="liquid-card p-5" data-aos="fade-up" data-aos-delay="150">
        <input type="hidden" name="sort" value="{{ current_sort }}">
        <div class="flex flex-wrap items-center gap-3">
            <!-- Status -->
            <div class="dropdown-container min-w-[150px]" x-data="liquidSelect({
                value: '{{ status_filter|default:'' }}',
                placeholder: '-- Tr·∫°ng th√°i --',
                options: [
                    { value: '', label: '-- Tr·∫°ng th√°i --' },
                    { value: 'pending', label: 'üïê Ch·ªù duy·ªát' },
                    { value: 'approved', label: '‚úÖ ƒê√£ duy·ªát' },
                    { value: 'rejected', label: '‚ùå T·ª´ ch·ªëi' }
                ]
            })" class="liquid-custom-select" @change="$refs.statusInput.value = $event.detail; $nextTick(() => document.getElementById('report-filter-form').submit())">
                <input type="hidden" name="status" x-ref="statusInput" value="{{ status_filter|default:'' }}">
                <div class="liquid-select-trigger py-2.5 px-4 text-[11px]" :class="{ 'active': open }" @click="open = !open">
                    <span x-text="label" class="truncate"></span>
                    <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                </div>
                <div x-show="open" x-transition:enter="liquid-select-dropdown entering" x-transition:enter-end="liquid-select-dropdown entered" x-transition:leave="liquid-select-dropdown entering" class="liquid-select-dropdown">
                    <template x-for="option in options" :key="option.value">
                        <div class="liquid-select-option" :class="{ 'selected': value === option.value }" @click="select(option)">
                            <span x-text="option.label"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Type -->
            <div class="dropdown-container min-w-[130px]" x-data="liquidSelect({
                value: '{{ type_filter|default:'' }}',
                placeholder: '-- Lo·∫°i --',
                options: [
                    { value: '', label: '-- Lo·∫°i --' },
                    { value: 'phone', label: 'üìû SƒêT' },
                    { value: 'domain', label: 'üåê Website' },
                    { value: 'account', label: 'üè¶ T√†i kho·∫£n' },
                    { value: 'email', label: 'üìß Email' },
                    { value: 'message', label: 'üí¨ Tin nh·∫Øn' }
                ]
            })" class="liquid-custom-select" @change="$refs.typeInput.value = $event.detail; $nextTick(() => document.getElementById('report-filter-form').submit())">
                <input type="hidden" name="type" x-ref="typeInput" value="{{ type_filter|default:'' }}">
                <div class="liquid-select-trigger py-2.5 px-4 text-[11px]" :class="{ 'active': open }" @click="open = !open">
                    <span x-text="label" class="truncate"></span>
                    <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                </div>
                <div x-show="open" x-transition:enter="liquid-select-dropdown entering" x-transition:enter-end="liquid-select-dropdown entered" x-transition:leave="liquid-select-dropdown entering" class="liquid-select-dropdown">
                    <template x-for="option in options" :key="option.value">
                        <div class="liquid-select-option" :class="{ 'selected': value === option.value }" @click="select(option)">
                            <span x-text="option.label"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Severity -->
            <div class="dropdown-container min-w-[150px]" x-data="liquidSelect({
                value: '{{ severity_filter|default:'' }}',
                placeholder: '-- M·ª©c ƒë·ªô --',
                options: [
                    { value: '', label: '-- M·ª©c ƒë·ªô --' },
                    { value: 'low', label: 'üü¢ Th·∫•p' },
                    { value: 'medium', label: 'üü° Trung b√¨nh' },
                    { value: 'high', label: 'üî¥ Cao' },
                    { value: 'critical', label: 'üíÄ Nghi√™m tr·ªçng' }
                ]
            })" class="liquid-custom-select" @change="$refs.sevInput.value = $event.detail; $nextTick(() => document.getElementById('report-filter-form').submit())">
                <input type="hidden" name="severity" x-ref="sevInput" value="{{ severity_filter|default:'' }}">
                <div class="liquid-select-trigger py-2.5 px-4 text-[11px]" :class="{ 'active': open }" @click="open = !open">
                    <span x-text="label" class="truncate"></span>
                    <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                </div>
                <div x-show="open" x-transition:enter="liquid-select-dropdown entering" x-transition:enter-end="liquid-select-dropdown entered" x-transition:leave="liquid-select-dropdown entering" class="liquid-select-dropdown">
                    <template x-for="option in options" :key="option.value">
                        <div class="liquid-select-option" :class="{ 'selected': value === option.value }" @click="select(option)">
                            <span x-text="option.label"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Search -->
            <div class="relative flex-1 min-w-[200px]">
                <input type="text" name="q" value="{{ query }}" placeholder="T√¨m SƒêT, t√™n, STK, n·ªôi dung..." 
                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2.5 text-xs font-bold text-white placeholder:text-white/20 focus:outline-none focus:border-cyan-500/50 transition-all">
                <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-white/20 text-xs"></i>
            </div>
            
            <button type="submit" class="bg-cyan-500 text-black px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-cyan-400 transition-all">L·ªçc</button>
            {% if status_filter or type_filter or severity_filter or query %}
            <a href="?" class="text-[9px] font-bold text-white/30 hover:text-white transition-colors"><i class="bi bi-x-lg mr-1"></i>X√≥a l·ªçc</a>
            {% endif %}
        </div>
    </form>

    <!-- Reports Table -->
    <div class="p-1 rounded-2xl bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden shadow-2xl" data-aos="fade-up" data-aos-delay="200">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-separate border-spacing-0">
                <thead>
                    <tr class="bg-white/[0.02]">
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 w-8">
                            <span class="text-white/20">#</span>
                        </th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">
                            <a href="?sort={% if current_sort == 'created_at' %}-created_at{% else %}created_at{% endif %}&status={{ status_filter }}&type={{ type_filter }}&severity={{ severity_filter }}&q={{ query }}" class="flex items-center gap-1 hover:text-cyan-400 transition-colors">
                                Th·ªùi gian {% if current_sort == 'created_at' %}‚Üë{% elif current_sort == '-created_at' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">
                            <a href="?sort={% if current_sort == 'reporter__username' %}-reporter__username{% else %}reporter__username{% endif %}&status={{ status_filter }}&type={{ type_filter }}&severity={{ severity_filter }}&q={{ query }}" class="flex items-center gap-1 hover:text-cyan-400 transition-colors">
                                Ng∆∞·ªùi b√°o {% if current_sort == 'reporter__username' %}‚Üë{% elif current_sort == '-reporter__username' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">ƒê·ªëi t∆∞·ª£ng</th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">B·∫±ng ch·ª©ng</th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">
                            <a href="?sort={% if current_sort == 'severity' %}-severity{% else %}severity{% endif %}&status={{ status_filter }}&type={{ type_filter }}&severity={{ severity_filter }}&q={{ query }}" class="flex items-center gap-1 hover:text-cyan-400 transition-colors">
                                M·ª©c ƒë·ªô {% if current_sort == 'severity' %}‚Üë{% elif current_sort == '-severity' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-center">AI</th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-center">Tr·∫°ng th√°i</th>
                        <th class="px-5 py-5 text-[9px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-right">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/[0.02]">
                    {% for report in reports %}
                    <tr class="group hover:bg-white/[0.03] transition-all duration-300" id="report-row-{{ report.id }}">
                        <td class="px-5 py-5 text-[10px] font-bold text-white/20">{{ report.id }}</td>
                        <td class="px-5 py-5 text-[10px] font-bold text-white/50 whitespace-nowrap">{{ report.created_at|date:"d/m/Y" }}<br><span class="text-white/25">{{ report.created_at|date:"H:i" }}</span></td>
                        <td class="px-5 py-5">
                            <div class="flex items-center gap-2.5">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-white/10 flex items-center justify-center text-cyan-400 font-black text-[10px] shrink-0">
                                    {{ report.reporter.username|slice:":1"|upper }}
                                </div>
                                <span class="text-xs font-black text-white tracking-tight truncate max-w-[100px]">{{ report.reporter.username }}</span>
                            </div>
                        </td>
                        <td class="px-5 py-5">
                            <div class="space-y-1">
                                <div class="flex items-center gap-1.5">
                                    <span class="px-1.5 py-0.5 rounded bg-white/5 text-white/30 text-[7px] font-black uppercase tracking-wider border border-white/10">
                                        {% if report.target_type == 'phone' %}üìû{% elif report.target_type == 'domain' %}üåê{% elif report.target_type == 'account' %}üè¶{% elif report.target_type == 'email' %}üìß{% else %}üí¨{% endif %}
                                        {{ report.target_type }}
                                    </span>
                                    <span class="text-[8px] font-bold text-cyan-500/40 uppercase">{{ report.get_scam_type_display|default:report.scam_type }}</span>
                                </div>
                                <div class="text-xs font-black text-white/80 tracking-tight truncate max-w-[180px]" title="{{ report.target_value }}">{{ report.target_value }}</div>
                            </div>
                        </td>
                        <td class="px-5 py-5">
                            <div class="flex items-center gap-1.5">
                                {% if report.evidence_file %}
                                <div class="w-10 h-10 rounded-lg overflow-hidden border border-white/10 cursor-zoom-in shrink-0 hover:border-cyan-500/50 transition-all" 
                                     onclick="event.stopPropagation(); Swal.fire({imageUrl: '{{ report.evidence_file.url }}', background: '#0a0a1a', showConfirmButton: false, customClass: {popup: 'rounded-3xl border border-white/10'}})">
                                    <img src="{{ report.evidence_file.url }}" class="w-full h-full object-cover" loading="lazy">
                                </div>
                                {% endif %}
                                {% for img in report.evidence_images.all %}
                                {% if forloop.counter <= 2 %}
                                <div class="w-10 h-10 rounded-lg overflow-hidden border border-white/10 cursor-zoom-in shrink-0 hover:border-cyan-500/50 transition-all"
                                     onclick="event.stopPropagation(); Swal.fire({imageUrl: '{{ img.image.url }}', background: '#0a0a1a', showConfirmButton: false, customClass: {popup: 'rounded-3xl border border-white/10'}})">
                                    <img src="{{ img.image.url }}" class="w-full h-full object-cover" loading="lazy">
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% with extra_count=report.evidence_images.count %}
                                {% if extra_count > 2 %}
                                <div class="w-10 h-10 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-[9px] font-black text-white/40">+{{ extra_count|add:"-2" }}</div>
                                {% endif %}
                                {% endwith %}
                                {% if not report.evidence_file and not report.evidence_images.count %}
                                <span class="text-[9px] text-white/15">‚Äî</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-5 py-5">
                            <span class="px-2 py-1 rounded-lg text-[8px] font-black uppercase tracking-wider border
                                {% if report.severity == 'low' %}bg-green-500/10 text-green-400 border-green-500/20
                                {% elif report.severity == 'medium' %}bg-yellow-500/10 text-yellow-400 border-yellow-500/20
                                {% elif report.severity == 'high' %}bg-red-500/10 text-red-400 border-red-500/20
                                {% else %}bg-red-600/20 text-red-500 border-red-600/30{% endif %}">
                                {{ report.severity|upper }}
                            </span>
                        </td>
                        <td class="px-5 py-5 text-center">
                            {% if report.ai_analysis and report.ai_analysis != '{}' %}
                            <div class="w-8 h-8 rounded-lg bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mx-auto" title="AI ƒë√£ ph√¢n t√≠ch">
                                <i class="bi bi-robot text-purple-400 text-xs"></i>
                            </div>
                            {% else %}
                            <span class="text-[9px] text-white/15">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-5">
                            <div class="flex justify-center">
                                {% if report.status == 'pending' %}
                                <span class="px-2.5 py-1 rounded-xl bg-yellow-500/10 text-yellow-500 text-[8px] font-black uppercase border border-yellow-500/20 tracking-wider">Ch·ªù duy·ªát</span>
                                {% elif report.status == 'approved' %}
                                <span class="px-2.5 py-1 rounded-xl bg-emerald-500/10 text-emerald-400 text-[8px] font-black uppercase border border-emerald-500/20 tracking-wider">ƒê√£ duy·ªát</span>
                                {% else %}
                                <span class="px-2.5 py-1 rounded-xl bg-red-500/10 text-red-500 text-[8px] font-black uppercase border border-red-500/20 tracking-wider">T·ª´ ch·ªëi</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-5 py-5 text-right">
                            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                                <button onclick="showReportDetails({{ report.id }})" class="w-9 h-9 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-cyan-500 hover:text-black transition-all border border-white/10 hover:border-cyan-500" title="Xem chi ti·∫øt">
                                    <i class="bi bi-eye-fill text-sm"></i>
                                </button>
                                <button onclick="runAIAnalysis({{ report.id }})" class="w-9 h-9 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-purple-500 hover:text-white transition-all border border-white/10 hover:border-purple-500" title="AI Ph√¢n t√≠ch">
                                    <i class="bi bi-robot text-sm"></i>
                                </button>
                                {% if report.status == 'pending' %}
                                <a href="{% url 'admin-approve-report' report.id %}" class="w-9 h-9 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-emerald-500 hover:text-black transition-all border border-white/10 hover:border-emerald-500" title="Duy·ªát">
                                    <i class="bi bi-check-lg text-sm"></i>
                                </a>
                                <a href="{% url 'admin-reject-report' report.id %}" class="w-9 h-9 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all border border-white/10 hover:border-red-500" title="T·ª´ ch·ªëi">
                                    <i class="bi bi-x-lg text-sm"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-8 py-32 text-center">
                            <div class="w-20 h-20 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center mx-auto mb-4">
                                <i class="bi bi-inbox text-3xl text-white/10"></i>
                            </div>
                            <div class="text-[10px] font-black text-white/20 uppercase tracking-widest mb-2">Kh√¥ng t√¨m th·∫•y b√°o c√°o</div>
                            <p class="text-xs text-white/10">Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Report Data JSON (serialized in view) -->
    <script>
        let REPORTS_DATA = {};
        try {
            const arr = {{ reports_json|safe }};
            arr.forEach(r => REPORTS_DATA[r.id] = r);
        } catch(e) { console.error('Parse reports data error:', e); }

        function getCSRF() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value 
                || document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('csrftoken='))?.split('=')[1] || '';
        }

        function runAIAnalysis(reportId) {
            const btn = event.currentTarget;
            const origHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin text-sm"></i>';
            btn.disabled = true;

            fetch(`/admin-cp/reports/${reportId}/analyze/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRF(), 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    if (REPORTS_DATA[reportId]) REPORTS_DATA[reportId].ai_analysis = data.ai_analysis;
                    Swal.fire({
                        icon: 'success',
                        title: '<span class="text-emerald-400 text-lg font-black">AI Ph√¢n t√≠ch ho√†n t·∫•t</span>',
                        html: `<div class="text-sm text-white/60">ƒêi·ªÉm r·ªßi ro: <strong class="text-white">${data.ai_analysis?.risk_score || 'N/A'}/100</strong></div>`,
                        background: '#0d0d1f', color: '#fff', timer: 3000, showConfirmButton: false,
                        customClass: { popup: 'rounded-3xl border border-white/10' }
                    });
                    const row = document.getElementById(`report-row-${reportId}`);
                    if (row) {
                        const aiCell = row.querySelectorAll('td')[6];
                        if (aiCell) aiCell.innerHTML = '<div class="w-8 h-8 rounded-lg bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mx-auto"><i class="bi bi-robot text-purple-400 text-xs"></i></div>';
                    }
                } else {
                    Swal.fire({ icon: 'error', title: '<span class="text-red-400 font-black">L·ªói</span>', html: `<div class="text-sm text-white/60">${data.message}</div>`, background: '#0d0d1f', color: '#fff', customClass: { popup: 'rounded-3xl border border-white/10' } });
                }
            })
            .catch(() => Swal.fire({ icon: 'error', title: 'L·ªói k·∫øt n·ªëi', background: '#0d0d1f', color: '#fff', customClass: { popup: 'rounded-3xl border border-white/10' } }))
            .finally(() => { btn.innerHTML = origHTML; btn.disabled = false; });
        }

        function saveModNote(reportId) {
            const note = document.getElementById(`mod-note-${reportId}`).value;
            fetch(`/admin-cp/reports/${reportId}/note/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRF(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ note })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    const btn = document.getElementById(`mod-note-btn-${reportId}`);
                    if (btn) { btn.innerHTML = '<i class="bi bi-check-lg mr-1"></i>ƒê√£ l∆∞u'; setTimeout(() => { btn.innerHTML = '<i class="bi bi-floppy mr-1"></i>L∆∞u ghi ch√∫'; }, 2000); }
                }
            });
        }

        function showReportDetails(reportId) {
            const data = REPORTS_DATA[reportId];
            if (!data) return;

            let severityColor = '#10b981';
            if (data.severity === 'medium') severityColor = '#f59e0b';
            if (data.severity === 'high') severityColor = '#ef4444';
            if (data.severity === 'critical') severityColor = '#dc2626';

            // Evidence gallery
            let allImages = [];
            if (data.evidence_url) allImages.push({ url: data.evidence_url, caption: '·∫¢nh b·∫±ng ch·ª©ng ch√≠nh (OCR)' });
            if (data.evidence_images) data.evidence_images.forEach((img, i) => allImages.push({ url: img.url, caption: img.caption || `·∫¢nh b·ªï sung ${i+1}` }));

            let galleryHtml = '';
            if (allImages.length > 0) {
                const imgData = JSON.stringify(allImages).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                galleryHtml = `
                <div class="space-y-3">
                    <h3 class="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                        <i class="bi bi-images"></i> B·∫±ng ch·ª©ng (${allImages.length} ·∫£nh)
                    </h3>
                    <div class="grid grid-cols-2 ${allImages.length > 2 ? 'md:grid-cols-3' : ''} gap-3">
                        ${allImages.map((img, i) => `
                            <div class="group/img relative rounded-2xl overflow-hidden border border-white/10 cursor-zoom-in hover:border-cyan-500/50 transition-all aspect-[4/3] bg-black/40"
                                 onclick="openImageViewer(${reportId}, ${i})">
                                <img src="${img.url}" class="w-full h-full object-cover transition-transform group-hover/img:scale-105" loading="lazy">
                                <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                    <p class="text-[9px] font-bold text-white/60">${img.caption}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // AI section
            let aiHtml = '';
            try {
                const ai = data.ai_analysis;
                if (ai && Object.keys(ai).length > 0) {
                    const risk_score = ai.risk_score || 0;
                    const scoreColor = risk_score > 75 ? '#ef4444' : (risk_score > 40 ? '#f59e0b' : '#10b981');
                    aiHtml = `
                    <div class="space-y-3">
                        <h3 class="text-[10px] font-black text-purple-400 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                            <i class="bi bi-robot"></i> AI Ph√¢n t√≠ch
                        </h3>
                        <div class="p-5 rounded-2xl bg-purple-500/[0.03] border border-purple-500/10 space-y-4">
                            <div class="flex items-center justify-between border-b border-purple-500/10 pb-3">
                                <div>
                                    <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest">ƒê√°nh gi√°</p>
                                    <p class="text-sm font-bold text-white">${ai.is_scam ? '‚ö†Ô∏è C√ì D·∫§U HI·ªÜU L·ª™A ƒê·∫¢O' : '‚úÖ B√åNH TH∆Ø·ªúNG'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest">ƒêi·ªÉm r·ªßi ro</p>
                                    <p class="text-3xl font-black" style="color: ${scoreColor}">${risk_score}<span class="text-sm text-white/20">/100</span></p>
                                </div>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest mb-1">Ph√¢n t√≠ch</p>
                                <p class="text-xs text-white/60 leading-relaxed">${ai.explanation || ai.reason || 'N/A'}</p>
                            </div>
                            ${ai.indicators && ai.indicators.length ? `
                            <div class="flex flex-wrap gap-1.5">
                                ${ai.indicators.map(ind => `<span class="px-2 py-0.5 rounded-lg bg-purple-500/10 text-purple-400 text-[8px] font-bold border border-purple-500/20">${ind}</span>`).join('')}
                            </div>` : ''}
                        </div>
                    </div>`;
                }
            } catch (e) { console.error('AI parse error', e); }

            Swal.fire({
                title: `<div class="flex items-center gap-3 text-left">
                    <div class="w-11 h-11 rounded-2xl bg-cyan-500/10 text-cyan-400 flex items-center justify-center border border-cyan-500/20">
                        <i class="bi bi-file-earmark-text text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-white tracking-tight">B√°o c√°o #${data.id}</h2>
                        <p class="text-[9px] font-bold text-white/20 uppercase tracking-widest mt-0.5">${data.created_at} ‚Ä¢ ${data.reporter}</p>
                    </div>
                </div>`,
                width: '900px',
                background: '#0d0d1f',
                color: '#fff',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 backdrop-blur-3xl',
                    htmlContainer: 'text-left p-0'
                },
                html: `
                    <div class="space-y-6 p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 p-5 rounded-2xl bg-white/[0.02] border border-white/5">
                            <div class="space-y-1">
                                <p class="text-[8px] font-black text-white/20 uppercase tracking-[0.2em]">ƒê·ªëi t∆∞·ª£ng</p>
                                <p class="text-sm font-bold text-white">${data.target_type_display}</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[8px] font-black text-white/20 uppercase tracking-[0.2em]">Gi√° tr·ªã</p>
                                <p class="text-sm font-bold text-cyan-400 break-all">${data.target_value}</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[8px] font-black text-white/20 uppercase tracking-[0.2em]">Lo·∫°i l·ª´a ƒë·∫£o</p>
                                <p class="text-sm font-bold text-white">${data.scam_type}</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[8px] font-black text-white/20 uppercase tracking-[0.2em]">C·∫•p ƒë·ªô</p>
                                <span class="inline-block px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider border" 
                                      style="background: ${severityColor}10; color: ${severityColor}; border-color: ${severityColor}30">${data.severity}</span>
                            </div>
                        </div>

                        ${(data.scammer_name || data.scammer_phone || data.scammer_bank_account) ? `
                        <div class="space-y-3">
                            <h3 class="text-[10px] font-black text-red-400 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                                <i class="bi bi-person-x"></i> Th√¥ng tin k·∫ª l·ª´a ƒë·∫£o
                            </h3>
                            <div class="p-5 rounded-2xl bg-red-500/[0.03] border border-red-500/10 grid grid-cols-2 gap-4">
                                ${data.scammer_name ? `<div><p class="text-[8px] font-black text-red-400/40 uppercase">H·ªç t√™n</p><p class="text-sm font-bold text-white">${data.scammer_name}</p></div>` : ''}
                                ${data.scammer_phone ? `<div><p class="text-[8px] font-black text-red-400/40 uppercase">SƒêT</p><p class="text-sm font-bold text-white">${data.scammer_phone}</p></div>` : ''}
                                ${data.scammer_bank_name ? `<div><p class="text-[8px] font-black text-red-400/40 uppercase">Ng√¢n h√†ng</p><p class="text-sm font-bold text-white">${data.scammer_bank_name}</p></div>` : ''}
                                ${data.scammer_bank_account ? `<div><p class="text-[8px] font-black text-red-400/40 uppercase">S·ªë TK</p><p class="text-sm font-bold text-white">${data.scammer_bank_account}</p></div>` : ''}
                            </div>
                        </div>` : ''}

                        <div class="space-y-3">
                            <h3 class="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-1">M√¥ t·∫£ chi ti·∫øt</h3>
                            <div class="p-5 rounded-2xl bg-white/[0.02] border border-white/5 text-sm text-white/60 leading-relaxed ai-markdown max-h-[200px] overflow-y-auto custom-scrollbar">
                                ${data.description}
                            </div>
                        </div>

                        ${data.ocr_text ? `
                        <div class="space-y-3">
                            <h3 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                                <i class="bi bi-card-text"></i> VƒÉn b·∫£n OCR
                            </h3>
                            <div class="p-5 rounded-2xl bg-cyan-500/[0.03] border border-cyan-500/10 text-xs text-white/50 leading-relaxed font-mono whitespace-pre-line max-h-[150px] overflow-y-auto custom-scrollbar">
                                ${data.ocr_text}
                            </div>
                        </div>` : ''}

                        ${galleryHtml}
                        ${aiHtml}

                        <div class="flex justify-center">
                            <button onclick="Swal.close(); runAIAnalysis(${data.id})" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-purple-500/10 text-purple-400 border border-purple-500/20 text-[10px] font-black uppercase tracking-widest hover:bg-purple-500/20 transition-all">
                                <i class="bi bi-robot"></i> ${aiHtml ? 'Ph√¢n t√≠ch l·∫°i AI' : 'Ch·∫°y AI Ph√¢n t√≠ch'}
                            </button>
                        </div>

                        <div class="space-y-3 border-t border-white/5 pt-6">
                            <h3 class="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                                <i class="bi bi-sticky"></i> Ghi ch√∫ ki·ªÉm duy·ªát
                            </h3>
                            <textarea id="mod-note-${data.id}" rows="3" placeholder="Ghi ch√∫ n·ªôi b·ªô cho admin..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs text-white placeholder:text-white/20 focus:outline-none focus:border-cyan-500/30 transition-all resize-none">${data.moderation_note || ''}</textarea>
                            <div class="flex justify-end">
                                <button id="mod-note-btn-${data.id}" onclick="saveModNote(${data.id})" class="px-4 py-2 rounded-xl bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 text-[10px] font-black uppercase tracking-widest hover:bg-cyan-500/20 transition-all">
                                    <i class="bi bi-floppy mr-1"></i>L∆∞u ghi ch√∫
                                </button>
                            </div>
                        </div>

                        ${data.status === 'pending' ? `
                        <div class="flex justify-center gap-4 border-t border-white/5 pt-6">
                            <a href="/admin-cp/reports/${data.id}/approve/" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-emerald-500 text-black text-[10px] font-black uppercase tracking-widest hover:bg-emerald-400 transition-all shadow-lg shadow-emerald-500/20">
                                <i class="bi bi-check-lg"></i> Duy·ªát b√°o c√°o
                            </a>
                            <a href="/admin-cp/reports/${data.id}/reject/" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 text-[10px] font-black uppercase tracking-widest hover:bg-red-500/20 transition-all">
                                <i class="bi bi-x-lg"></i> T·ª´ ch·ªëi
                            </a>
                        </div>` : ''}
                    </div>
                `
            });
        }

        function openImageViewer(reportId, startIndex) {
            const data = REPORTS_DATA[reportId];
            if (!data) return;
            
            let images = [];
            if (data.evidence_url) images.push({ url: data.evidence_url, caption: '·∫¢nh b·∫±ng ch·ª©ng ch√≠nh (OCR)' });
            if (data.evidence_images) data.evidence_images.forEach((img, i) => images.push({ url: img.url, caption: img.caption || `·∫¢nh b·ªï sung ${i+1}` }));
            
            let currentIdx = startIndex || 0;
            
            function renderViewer() {
                const img = images[currentIdx];
                Swal.fire({
                    html: `
                        <div class="relative" style="min-height: 300px;">
                            <img src="${img.url}" class="w-full max-h-[80vh] object-contain rounded-xl" style="min-height: 200px;">
                            <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/90 to-transparent p-6 rounded-b-xl">
                                <p class="text-sm font-bold text-white">${img.caption || ''}</p>
                                <p class="text-[10px] text-white/40 mt-1">${currentIdx + 1} / ${images.length}</p>
                            </div>
                            ${images.length > 1 ? `
                            <button onclick="window.__imgViewerPrev()" class="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/60 text-white flex items-center justify-center hover:bg-black/80 transition-all border border-white/10">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button onclick="window.__imgViewerNext()" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/60 text-white flex items-center justify-center hover:bg-black/80 transition-all border border-white/10">
                                <i class="bi bi-chevron-right"></i>
                            </button>` : ''}
                        </div>
                    `,
                    width: '90vw',
                    padding: 0,
                    background: '#000',
                    showConfirmButton: false,
                    showCloseButton: true,
                    customClass: { popup: 'rounded-3xl border border-white/10', htmlContainer: 'p-0 m-0' }
                });
            }

            window.__imgViewerPrev = () => { currentIdx = (currentIdx - 1 + images.length) % images.length; renderViewer(); };
            window.__imgViewerNext = () => { currentIdx = (currentIdx + 1) % images.length; renderViewer(); };
            renderViewer();
        }
    </script>
</div>
{% endblock %}
