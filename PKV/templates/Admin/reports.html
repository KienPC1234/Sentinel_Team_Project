{% extends "base.html" %}
{% load static %}

{% block title %}Qu·∫£n l√Ω B√°o c√°o - ShieldCall VN Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10 mt-16 max-w-6xl">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12" data-aos="fade-up">
        <div class="flex items-center gap-6" data-aos="fade-right" data-aos-delay="100">
            <a href="{% url 'admin-dashboard' %}" class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white/40 hover:text-cyan-400 hover:border-cyan-500/30 transition-all shadow-lg">
                <i class="bi bi-chevron-left text-2xl"></i>
            </a>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">B√°o c√°o C·ªông ƒë·ªìng</h1>
                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Qu·∫£n l√Ω ph·∫£n h·ªìi v√† b√°o l·ª´a ƒë·∫£o</p>
            </div>
        </div>

        <!-- Filter & Search Bar -->
        <form id="report-filter-form" method="GET" class="flex flex-wrap items-center gap-4" data-aos="fade-left" data-aos-delay="200">
            <input type="hidden" name="sort" value="{{ current_sort }}">
            
            <div x-data="liquidSelect({
                value: '{{ status_filter }}',
                placeholder: '-- Tr·∫°ng th√°i --',
                options: [
                    { value: '', label: '-- Tr·∫°ng th√°i --' },
                    { value: 'pending', label: 'Ch·ªù duy·ªát' },
                    { value: 'approved', label: 'ƒê√£ duy·ªát' },
                    { value: 'rejected', label: 'T·ª´ ch·ªëi' }
                ]
            })" class="liquid-custom-select min-w-[150px]" @change="document.getElementById('report-filter-form').submit()">
                <div class="liquid-select-trigger text-[10px] font-bold" :class="{ 'active': open }" @click="open = !open">
                    <span x-text="label"></span>
                    <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                </div>
                <div x-show="open" 
                     x-transition:enter="liquid-select-dropdown entering"
                     x-transition:enter-end="liquid-select-dropdown entered"
                     x-transition:leave="liquid-select-dropdown entering"
                     class="liquid-select-dropdown">
                    <template x-for="option in options" :key="option.value">
                        <div class="liquid-select-option text-[10px] font-bold" 
                             :class="{ 'selected': value === option.value }"
                             @click="select(option)">
                            <span x-text="option.label"></span>
                        </div>
                    </template>
                </div>
                <input type="hidden" name="status" :value="value">
            </div>

            <div x-data="liquidSelect({
                value: '{{ type_filter }}',
                placeholder: '-- Lo·∫°i --',
                options: [
                    { value: '', label: '-- Lo·∫°i --' },
                    { value: 'phone', label: 'üìû S·ªë ƒëi·ªán tho·∫°i' },
                    { value: 'domain', label: 'üåê Website' },
                    { value: 'account', label: 'üè¶ T√†i kho·∫£n' },
                    { value: 'message', label: 'üí¨ Tin nh·∫Øn' }
                ]
            })" class="liquid-custom-select min-w-[150px]" @change="document.getElementById('report-filter-form').submit()">
                <div class="liquid-select-trigger text-[10px] font-bold" :class="{ 'active': open }" @click="open = !open">
                    <span x-text="label"></span>
                    <i class="bi bi-chevron-down liquid-select-arrow" :class="{ 'rotate-180': open }"></i>
                </div>
                <div x-show="open" 
                     x-transition:enter="liquid-select-dropdown entering"
                     x-transition:enter-end="liquid-select-dropdown entered"
                     x-transition:leave="liquid-select-dropdown entering"
                     class="liquid-select-dropdown">
                    <template x-for="option in options" :key="option.value">
                        <div class="liquid-select-option text-[10px] font-bold" 
                             :class="{ 'selected': value === option.value }"
                             @click="select(option)">
                            <span x-text="option.label"></span>
                        </div>
                    </template>
                </div>
                <input type="hidden" name="type" :value="value">
            </div>

            <div class="relative min-w-[250px]">
                <input type="text" name="q" value="{{ query }}" placeholder="T√¨m ki·∫øm gi√° tr·ªã, n·ªôi dung..." 
                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2 text-xs font-bold text-white placeholder:text-white/20 focus:outline-none focus:border-cyan-500/50 transition-all">
                <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-white/20 text-xs"></i>
            </div>
            
            <button type="submit" class="bg-cyan-500 text-black px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-cyan-400 transition-all">L·ªçc</button>
            {% if status_filter or type_filter or query %}
            <a href="?" class="text-[9px] font-bold text-white/30 hover:text-white transition-colors">X√≥a l·ªçc</a>
            {% endif %}
        </form>
    </div>

    <div class="p-1 rounded-2xl bg-slate-900/40 border border-white/5 backdrop-blur-xl overflow-hidden shadow-2xl" data-aos="fade-up" data-aos-delay="300">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-separate border-spacing-0">
                <thead>
                    <tr class="bg-white/[0.02]">
                        <th class="px-8 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">
                            <a href="?sort={% if current_sort == 'created_at' %}-created_at{% else %}created_at{% endif %}" class="flex items-center gap-2 hover:text-cyan-400 transition-colors">
                                <i class="bi bi-clock"></i> Th·ªùi gian {% if current_sort == 'created_at' %}‚Üë{% elif current_sort == '-created_at' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-8 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">
                            <a href="?sort={% if current_sort == 'reporter__username' %}-reporter__username{% else %}reporter__username{% endif %}" class="flex items-center gap-2 hover:text-cyan-400 transition-colors">
                                <i class="bi bi-person"></i> Ng∆∞·ªùi b√°o {% if current_sort == 'reporter__username' %}‚Üë{% elif current_sort == '-reporter__username' %}‚Üì{% endif %}
                            </a>
                        </th>
                        <th class="px-8 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5">ƒê·ªëi t∆∞·ª£ng</th>
                        <th class="px-8 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-center">Tr·∫°ng th√°i</th>
                        <th class="px-8 py-6 text-[10px] font-black text-white/40 uppercase tracking-widest border-b border-white/5 text-right">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/[0.02]">
                    {% for report in reports %}
                    <tr class="group hover:bg-white/[0.03] transition-all duration-300">
                        <td class="px-8 py-7 text-[11px] font-bold text-white/60 whitespace-nowrap">{{ report.created_at|date:"d/m H:i" }}</td>
                        <td class="px-8 py-7">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-white/10 flex items-center justify-center text-cyan-400 font-black text-xs shadow-lg">
                                    {{ report.reporter.username|slice:":1"|upper }}
                                </div>
                                <span class="text-sm font-black text-white tracking-tight">{{ report.reporter.username }}</span>
                            </div>
                        </td>
                        <td class="px-8 py-7">
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded-md bg-white/5 text-white/30 text-[8px] font-black uppercase tracking-widest border border-white/10">
                                        {{ report.target_type }}
                                    </span>
                                    <span class="text-[10px] font-bold text-cyan-500/50 uppercase tracking-tighter">{{ report.get_scam_type_display|default:report.scam_type }}</span>
                                </div>
                                <div class="text-sm font-black text-white/90 tracking-tight">{{ report.target_value }}</div>
                            </div>
                        </td>
                        <td class="px-8 py-7">
                            <div class="flex justify-center">
                                {% if report.status == 'pending' %}
                                <span class="px-3 py-1.5 rounded-xl bg-yellow-500/10 text-yellow-500 text-[9px] font-black uppercase border border-yellow-500/20 tracking-widest shadow-[0_0_15px_rgba(234,179,8,0.1)]">Ch·ªù duy·ªát</span>
                                {% elif report.status == 'approved' %}
                                <span class="px-3 py-1.5 rounded-xl bg-emerald-500/10 text-emerald-400 text-[9px] font-black uppercase border border-emerald-500/20 tracking-widest shadow-[0_0_15px_rgba(16,185,129,0.1)]">ƒê√£ duy·ªát</span>
                                {% else %}
                                <span class="px-3 py-1.5 rounded-xl bg-red-500/10 text-red-500 text-[9px] font-black uppercase border border-red-500/20 tracking-widest">T·ª´ ch·ªëi</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-8 py-7 text-right">
                            <div class="flex justify-end gap-3 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-4 group-hover:translate-x-0">
                                <button onclick="showReportDetails({
                                    id: '{{ report.id }}',
                                    created_at: '{{ report.created_at|date:'d/m/Y H:i' }}',
                                    reporter: '{{ report.reporter.username|escapejs }}',
                                    target_type: '{{ report.target_type|escapejs }}',
                                    target_value: '{{ report.target_value|escapejs }}',
                                    scam_type: '{{ report.get_scam_type_display|escapejs }}',
                                    severity: '{{ report.severity|escapejs }}',
                                    description: `{{ report.description|safe|escapejs }}`,
                                    scammer_name: '{{ report.scammer_name|default:''|escapejs }}',
                                    scammer_phone: '{{ report.scammer_phone|default:''|escapejs }}',
                                    scammer_bank_name: '{{ report.scammer_bank_name|default:''|escapejs }}',
                                    scammer_bank_account: '{{ report.scammer_bank_account|default:''|escapejs }}',
                                    evidence_url: '{% if report.evidence_file %}{{ report.evidence_file.url }}{% endif %}',
                                    ocr_text: `{{ report.ocr_text|escapejs }}`,
                                    ai_analysis: `{{ report.ai_analysis|safe|escapejs }}`
                                })" class="w-10 h-10 rounded-2xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-cyan-500 hover:text-black transition-all border border-white/10 hover:border-cyan-500 shadow-xl" title="Xem chi ti·∫øt">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                {% if report.status == 'pending' %}
                                <a href="{% url 'admin-approve-report' report.id %}" class="w-10 h-10 rounded-2xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-emerald-500 hover:text-black transition-all border border-white/10 hover:border-emerald-500 shadow-xl" title="Duy·ªát b√°o c√°o">
                                    <i class="bi bi-check-lg"></i>
                                </a>
                                <a href="{% url 'admin-reject-report' report.id %}" class="w-10 h-10 rounded-2xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all border border-white/10 hover:border-red-500 shadow-xl" title="T·ª´ ch·ªëi">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-8 py-32 text-center">
                            <div class="text-[10px] font-black text-white/20 uppercase tracking-widest mb-2">No Community Reports Found</div>
                            <p class="text-xs text-white/10">All systems are quiet or everything has been processed.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function showReportDetails(data) {
            let severityColor = '#10b981'; // green
            if (data.severity === 'medium') severityColor = '#f59e0b';
            if (data.severity === 'high') severityColor = '#ef4444';
            if (data.severity === 'critical') severityColor = '#dc2626';

            let aiHtml = '';
            try {
                if (data.ai_analysis && data.ai_analysis !== '{}') {
                    const ai = JSON.parse(data.ai_analysis);
                    const risk_score = ai.risk_score || 0;
                    const scoreColor = risk_score > 75 ? '#ef4444' : (risk_score > 40 ? '#f59e0b' : '#10b981');
                    
                    aiHtml = `
                    <div class="space-y-4">
                        <h3 class="text-[10px] font-black text-purple-400 uppercase tracking-[0.2em] ml-1 flex items-center gap-2">
                            <i class="bi bi-robot"></i> AI Ph√¢n t√≠ch b√°o c√°o
                        </h3>
                        <div class="p-6 rounded-3xl bg-purple-500/[0.03] border border-purple-500/10 space-y-4">
                            <div class="flex items-center justify-between border-b border-purple-500/10 pb-4">
                                <div>
                                    <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest">ƒê√°nh gi√° r·ªßi ro</p>
                                    <p class="text-sm font-bold text-white">${ai.is_scam ? 'C√ì D·∫§U HI·ªÜU L·ª™A ƒê·∫¢O' : 'B√åNH TH∆Ø·ªúNG'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest">ƒêi·ªÉm r·ªßi ro</p>
                                    <p class="text-2xl font-black" style="color: ${scoreColor}">${risk_score}/100</p>
                                </div>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-purple-400/40 uppercase tracking-widest mb-2">L√Ω do ph√¢n t√≠ch</p>
                                <p class="text-xs text-white/70 leading-relaxed">${ai.explanation || ai.reason || 'N/A'}</p>
                            </div>
                            ${ai.indicators && ai.indicators.length ? `
                            <div class="flex flex-wrap gap-2">
                                ${ai.indicators.map(ind => `<span class="px-2 py-0.5 rounded-lg bg-purple-500/10 text-purple-400 text-[8px] font-bold border border-purple-500/20">${ind}</span>`).join('')}
                            </div>` : ''}
                        </div>
                    </div>`;
                }
            } catch (e) { console.error('AI JSON parse error', e); }

            Swal.fire({
                title: `<div class="flex items-center gap-4 text-left">
                            <div class="w-12 h-12 rounded-2xl bg-cyan-500/10 text-cyan-400 flex items-center justify-center border border-cyan-500/20">
                                <i class="bi bi-file-earmark-text text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-black text-white tracking-tight">Chi ti·∫øt b√°o c√°o #${data.id}</h2>
                                <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">${data.created_at}</p>
                            </div>
                        </div>`,
                width: '800px',
                background: '#0d0d1f',
                color: '#fff',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    popup: 'rounded-[3rem] border border-white/10 backdrop-blur-3xl',
                    htmlContainer: 'text-left p-0'
                },
                html: `
                    <div class="space-y-8 p-10 max-h-[85vh] overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-2 gap-8 p-6 rounded-3xl bg-white/[0.02] border border-white/5">
                            <div class="space-y-1">
                                <p class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">Ng∆∞·ªùi b√°o c√°o</p>
                                <p class="text-sm font-bold text-white">${data.reporter}</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">C·∫•p ƒë·ªô</p>
                                <span class="px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest border border-opacity-20" 
                                      style="background: ${severityColor}10; color: ${severityColor}; border-color: ${severityColor}">${data.severity}</span>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">ƒê·ªëi t∆∞·ª£ng</p>
                                <p class="text-sm font-bold text-white">${data.target_type}: ${data.target_value}</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">Lo·∫°i l·ª´a ƒë·∫£o</p>
                                <p class="text-sm font-bold text-white">${data.scam_type}</p>
                            </div>
                        </div>

                        ${aiHtml}

                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-1">M√¥ t·∫£ chi ti·∫øt</h3>
                            <div class="p-6 rounded-3xl bg-white/[0.03] border border-white/5 text-sm text-white/70 leading-relaxed ai-markdown">
                                ${data.description}
                            </div>
                        </div>

                        ${data.ocr_text ? `
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] ml-1">VƒÉn b·∫£n OCR (T·ª´ ·∫£nh)</h3>
                            <div class="p-6 rounded-3xl bg-cyan-500/[0.03] border border-cyan-500/10 text-xs text-white/60 leading-relaxed font-mono whitespace-pre-line">
                                ${data.ocr_text}
                            </div>
                        </div>` : ''}

                        ${(data.scammer_name || data.scammer_phone || data.scammer_bank_account) ? `
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] ml-1">Th√¥ng tin k·∫ª l·ª´a ƒë·∫£o</h3>
                            <div class="p-6 rounded-3xl bg-cyan-500/[0.03] border border-cyan-500/10 grid grid-cols-2 gap-6">
                                ${data.scammer_name ? `<div><p class="text-[9px] font-black text-cyan-400/40 uppercase tracking-widest">H·ªç t√™n</p><p class="text-sm font-bold text-white">${data.scammer_name}</p></div>` : ''}
                                ${data.scammer_phone ? `<div><p class="text-[9px] font-black text-cyan-400/40 uppercase tracking-widest">SƒêT</p><p class="text-sm font-bold text-white">${data.scammer_phone}</p></div>` : ''}
                                ${data.scammer_bank_name ? `<div><p class="text-[9px] font-black text-cyan-400/40 uppercase tracking-widest">Ng√¢n h√†ng</p><p class="text-sm font-bold text-white">${data.scammer_bank_name}</p></div>` : ''}
                                ${data.scammer_bank_account ? `<div><p class="text-[9px] font-black text-cyan-400/40 uppercase tracking-widest">STK</p><p class="text-sm font-bold text-white">${data.scammer_bank_account}</p></div>` : ''}
                            </div>
                        </div>` : ''}

                        ${data.evidence_url ? `
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-white/40 uppercase tracking-[0.2em] ml-1">B·∫±ng ch·ª©ng</h3>
                            <div class="rounded-3xl overflow-hidden border border-white/10 bg-black/40">
                                <img src="${data.evidence_url}" class="w-full h-auto">
                            </div>
                        </div>` : ''}
                    </div>
                `
            });
        }
    </script>
</div>
{% endblock %}
