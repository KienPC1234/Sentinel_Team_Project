{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-8 mt-16 max-w-7xl">
    <!-- Header with Pulse Indicator -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-cyan-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-cyan-500"></span>
                </span>
                <span class="text-[10px] uppercase font-black tracking-[0.2em] text-cyan-500/60">Hệ Thống Đang Giám Sát Real-time</span>
            </div>
            <h1 class="text-4xl font-black bg-gradient-to-r from-blue-400 via-cyan-400 to-indigo-400 bg-clip-text text-transparent tracking-tight">
                Dashboard Trung Tâm
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="px-5 py-2.5 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-xl flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div>
                    <div class="text-[9px] font-bold text-white/30 uppercase tracking-widest leading-none">Quyền hạn</div>
                    <div class="text-xs font-black text-white">{% if user.profile.is_super_admin %}Super Admin{% else %}Admin{% endif %}</div>
                </div>
            </div>
            <div id="connection-status" class="px-4 py-2 rounded-xl bg-green-500/10 border border-green-500/20 text-[10px] font-black text-green-400 uppercase flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                Đã kết nối
            </div>
        </div>
    </div>

    <!-- Live Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <!-- User Stats -->
        <div class="stat-card relative overflow-hidden p-6 rounded-[2rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl group hover:border-blue-500/30 transition-all">
            <div class="absolute -right-4 -bottom-4 opacity-[0.03] group-hover:opacity-[0.07] transition-all group-hover:scale-110">
                <i class="bi bi-people-fill text-9xl"></i>
            </div>
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                    <i class="bi bi-people text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-black text-white/30 uppercase tracking-[0.1em]">Người dùng</div>
                    <div class="text-4xl font-black text-white tracking-tighter" id="stat-users">{{ stats.total_users }}</div>
                </div>
            </div>
            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 animate-pulse-slow" style="width: 70%"></div>
            </div>
        </div>

        <!-- Pending Reports -->
        <div class="stat-card relative overflow-hidden p-6 rounded-[2rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl group hover:border-red-500/30 transition-all">
            <div class="absolute -right-4 -bottom-4 opacity-[0.03] group-hover:opacity-[0.07] transition-all group-hover:scale-110">
                <i class="bi bi-exclamation-triangle-fill text-9xl"></i>
            </div>
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center text-white shadow-lg shadow-red-500/20">
                    <i class="bi bi-exclamation-octagon text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-black text-white/30 uppercase tracking-[0.1em]">Báo cáo mới</div>
                    <div class="text-4xl font-black text-white tracking-tighter" id="stat-reports">{{ stats.pending_reports }}</div>
                </div>
            </div>
            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                <div class="h-full bg-red-500" style="width: 45%"></div>
            </div>
        </div>

        <!-- Scan Activity -->
        <div class="stat-card relative overflow-hidden p-6 rounded-[2rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl group hover:border-cyan-500/30 transition-all">
            <div class="absolute -right-4 -bottom-4 opacity-[0.03] group-hover:opacity-[0.07] transition-all group-hover:scale-110">
                <i class="bi bi-search text-9xl"></i>
            </div>
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center text-white shadow-lg shadow-cyan-500/20">
                    <i class="bi bi-lightning-charge text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-black text-white/30 uppercase tracking-[0.1em]">Lượt Quét AI</div>
                    <div class="text-4xl font-black text-white tracking-tighter" id="stat-scans">{{ stats.total_scans }}</div>
                </div>
            </div>
            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                <div class="h-full bg-cyan-500" style="width: 85%"></div>
            </div>
        </div>

        <!-- Content Stats -->
        <div class="stat-card relative overflow-hidden p-6 rounded-[2rem] bg-slate-900/40 border border-white/5 backdrop-blur-xl group hover:border-purple-500/30 transition-all">
            <div class="absolute -right-4 -bottom-4 opacity-[0.03] group-hover:opacity-[0.07] transition-all group-hover:scale-110">
                <i class="bi bi-journal-text text-9xl"></i>
            </div>
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-purple-500/20">
                    <i class="bi bi-journal-code text-xl"></i>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-black text-white/30 uppercase tracking-[0.1em]">Nội Dung</div>
                    <div class="text-4xl font-black text-white tracking-tighter" id="stat-content">{{ stats.total_lessons }}</div>
                </div>
            </div>
            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                <div class="h-full bg-purple-500" style="width: 60%"></div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <div class="p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-2xl">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-xl font-black text-white tracking-tight">Xu hướng báo cáo</h3>
                    <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Dữ liệu 7 ngày gần nhất</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/40">
                    <i class="bi bi-graph-up"></i>
                </div>
            </div>
            <div class="h-[300px] w-full">
                <canvas id="reportsChart"></canvas>
            </div>
        </div>

        <div class="p-8 rounded-[2.5rem] bg-slate-900/40 border border-white/5 backdrop-blur-2xl">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-xl font-black text-white tracking-tight">Hoạt động Quét (Scan)</h3>
                    <p class="text-[10px] font-bold text-white/20 uppercase tracking-widest mt-1">Lưu lượng truy vấn AI</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-white/40">
                    <i class="bi bi-activity"></i>
                </div>
            </div>
            <div class="h-[300px] w-full">
                <canvas id="scansChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Management Navigation -->
    <h2 class="text-xs font-black text-white/20 uppercase tracking-[0.3em] mb-8 text-center italic">Trung Tâm Điều Hành ShieldCall</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Reports -->
        <a href="{% url 'admin-manage-reports' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-blue-500/20 to-transparent hover:from-blue-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:scale-110 group-hover:bg-blue-500 group-hover:text-white transition-all shadow-xl shadow-blue-500/0 group-hover:shadow-blue-500/20">
                        <i class="bi bi-file-earmark-text text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-blue-400 transition-colors tracking-tight">Quản Lý Báo Cáo</h4>
                        <div class="text-[10px] font-bold text-blue-500/50 uppercase tracking-widest">Community Verification</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Phê duyệt và xác minh các báo cáo từ cộng đồng. Sử dụng AI để đánh giá mức độ rủi ro tự động.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-blue-400 group-hover:border-blue-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>

        <!-- Learn Content -->
        <a href="{% url 'admin-manage-learn' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-purple-500/20 to-transparent hover:from-purple-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:scale-110 group-hover:bg-purple-500 group-hover:text-white transition-all shadow-xl shadow-purple-500/0 group-hover:shadow-purple-500/20">
                        <i class="bi bi-mortarboard text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-purple-400 transition-colors tracking-tight">Nội Dung Đào Tạo</h4>
                        <div class="text-[10px] font-bold text-purple-500/50 uppercase tracking-widest">Educational CMS</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Tổ chức các bài học về bảo mật. Cập nhật các kịch bản lừa đảo mới nhất cho người dùng.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-purple-400 group-hover:border-purple-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>

        <!-- RAG Brain -->
        <a href="{% url 'core:admin-rag' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-cyan-500/20 to-transparent hover:from-cyan-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 group-hover:scale-110 group-hover:bg-cyan-500 group-hover:text-black transition-all shadow-xl shadow-cyan-500/0 group-hover:shadow-cyan-500/20">
                        <i class="bi bi-cpu text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-cyan-400 transition-colors tracking-tight">Trí Tuệ RAG</h4>
                        <div class="text-[10px] font-bold text-cyan-500/50 uppercase tracking-widest">Vector Knowledge</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Quản lý "não bộ" của AI. Đồng bộ hóa FAISS Vector Database để AI trả lời chính xác và thực tế.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-cyan-400 group-hover:border-cyan-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>

        <!-- News / Articles -->
        <a href="{% url 'admin-manage-articles' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-indigo-500/20 to-transparent hover:from-indigo-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-indigo-500/10 flex items-center justify-center text-indigo-400 group-hover:scale-110 group-hover:bg-indigo-500 group-hover:text-white transition-all shadow-xl shadow-indigo-500/0 group-hover:shadow-indigo-500/20">
                        <i class="bi bi-newspaper text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-indigo-400 transition-colors tracking-tight">Tin Tức / Cảnh Báo</h4>
                        <div class="text-[10px] font-bold text-indigo-500/50 uppercase tracking-widest">Global Newsroom</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Phát hành các bài viết cảnh báo nóng. Cập nhật tin tức an ninh mạng theo thời gian thực.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-indigo-400 group-hover:border-indigo-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>

        <!-- Scenarios Management -->
        <a href="{% url 'admin-manage-scenarios' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-emerald-500/20 to-transparent hover:from-emerald-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 group-hover:scale-110 group-hover:bg-emerald-500 group-hover:text-black transition-all shadow-xl shadow-emerald-500/0 group-hover:shadow-emerald-500/20">
                        <i class="bi bi-controller text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-emerald-400 transition-colors tracking-tight">Kịch Bản Tương Tác</h4>
                        <div class="text-[10px] font-bold text-emerald-500/50 uppercase tracking-widest">Interactive Training</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Quản lý và thiết kế các tình huống giả định lừa đảo để người dùng luyện tập kỹ năng phòng chống.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-emerald-400 group-hover:border-emerald-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>

        <!-- Super Admin Controls -->
        {% if user.profile.is_super_admin %}
        <a href="{% url 'admin-manage-users' %}" class="mgmt-card group p-1 rounded-[2.5rem] bg-gradient-to-br from-red-500/20 to-transparent hover:from-red-500/40 transition-all duration-500">
            <div class="bg-slate-950/80 rounded-[2.3rem] p-8 h-full flex flex-col gap-5 backdrop-blur-3xl">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-400 group-hover:scale-110 group-hover:bg-red-500 group-hover:text-white transition-all shadow-xl shadow-red-500/0 group-hover:shadow-red-500/20">
                        <i class="bi bi-person-badge text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-black text-white group-hover:text-red-400 transition-colors tracking-tight">Hệ Thống & User</h4>
                        <div class="text-[10px] font-bold text-red-500/50 uppercase tracking-widest">Super Admin Only</div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-relaxed">Kiểm soát người dùng, phân quyền Admin và tinh chỉnh các cấu hình hệ thống cốt lõi.</p>
                <div class="flex justify-end pt-2">
                    <div class="w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-white/20 group-hover:text-red-400 group-hover:border-red-500/30 transition-all">
                        <i class="bi bi-arrow-right"></i>
                    </div>
                </div>
            </div>
        </a>
        {% endif %}
    </div>
</div>

<!-- Scripts Section -->
{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let reportsChart, scansChart;

    const chartConfig = (label, color) => ({
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: color,
                backgroundColor: `${color}20`,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 10, weight: '900' } } },
                x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 10, weight: '900' } } }
            }
        }
    });

    function initCharts() {
        const ctxReports = document.getElementById('reportsChart').getContext('2d');
        const ctxScans = document.getElementById('scansChart').getContext('2d');
        reportsChart = new Chart(ctxReports, chartConfig('Báo cáo', '#3b82f6'));
        scansChart = new Chart(ctxScans, chartConfig('Lượt quét', '#06b6d4'));
    }

    async function updateDashboardData() {
        try {
            const response = await fetch("{% url 'admin-dashboard-stats' %}");
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update Numeric Stats with Animation
                animateNumber('stat-users', data.stats.users);
                animateNumber('stat-reports', data.stats.reports);
                animateNumber('stat-scans', data.stats.scans);
                
                // Update Charts
                reportsChart.data.labels = data.charts.labels;
                reportsChart.data.datasets[0].data = data.charts.reports;
                reportsChart.update();

                scansChart.data.labels = data.charts.labels;
                scansChart.data.datasets[0].data = data.charts.scans;
                scansChart.update();

                document.getElementById('connection-status').className = 'px-4 py-2 rounded-xl bg-green-500/10 border border-green-500/20 text-[10px] font-black text-green-400 uppercase flex items-center gap-2';
                document.getElementById('connection-status').innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Đã kết nối';
            }
        } catch (error) {
            console.error('Stats Update Error:', error);
            document.getElementById('connection-status').className = 'px-4 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-[10px] font-black text-red-400 uppercase flex items-center gap-2';
            document.getElementById('connection-status').innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Mất kết nối';
        }
    }

    function animateNumber(id, val) {
        const el = document.getElementById(id);
        const start = parseInt(el.innerText) || 0;
        const duration = 1500;
        const startTime = performance.now();

        function step(timestamp) {
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const current = Math.floor(progress * (val - start) + start);
            el.innerText = current;
            if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        updateDashboardData();
        setInterval(updateDashboardData, 5000); // 5s Polling
    });
</script>
<style>
    .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    .mgmt-card:hover { transform: translateY(-4px); }
</style>
{% endblock %}
{% endblock %}
