{% extends 'base.html' %}
{% load static %}

{% block title %}Hỏi đáp AI - ShieldCall VN{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-80px)] overflow-hidden bg-transparent text-slate-200 font-inter relative">
    <!-- Sidebar: Liquid Glass History List -->
    <div id="chat-sidebar" class="w-80 border-r border-white/10 bg-white/[0.03] backdrop-blur-3xl flex flex-col hidden md:flex transition-all duration-300 z-30">
        <div class="p-5 border-b border-white/10">
            <button id="new-chat-btn" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-cyan-500/20 to-blue-500/20 text-cyan-400 border border-cyan-500/30 hover:from-cyan-500/30 hover:to-blue-500/30 transition-all flex items-center justify-center gap-3 font-semibold text-sm group shadow-lg shadow-cyan-500/10">
                <i class="bi bi-plus-lg group-hover:rotate-90 transition-transform duration-300"></i>
                Hội thoại mới
            </button>
        </div>
        
        <div class="px-5 py-4 flex items-center justify-between">
            <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] text-cyan-400/60">Lịch sử trò chuyện</h3>
            <div class="flex items-center gap-2">
                <span id="session-count" class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-slate-400 font-bold">0</span>
                <button onclick="clearHistory()" title="Xóa toàn bộ lịch sử" class="text-slate-500 hover:text-red-400 transition-colors p-1">
                    <i class="bi bi-trash-fill text-[10px]"></i>
                </button>
            </div>
        </div>

        <div id="history-container" class="flex-1 overflow-y-auto px-3 space-y-1.5 custom-scrollbar">
            <!-- Sessions list will be loaded here -->
            <div class="p-8 text-center">
                <div class="inline-block animate-spin w-4 h-4 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full mb-2"></div>
                <p class="text-[10px] text-slate-500 italic">Đang tải dữ liệu...</p>
            </div>
        </div>

        <!-- User Profile Card -->
        <div class="p-5 bg-white/[0.02] border-t border-white/10">
            <div class="flex items-center gap-4 p-3 rounded-xl bg-white/[0.05] border border-white/10 group hover:bg-white/[0.08] transition-all cursor-pointer">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-600/20 flex items-center justify-center text-cyan-400 font-black border border-cyan-500/30 shadow-inner">
                    {{ user.username|slice:":1"|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-slate-100 truncate group-hover:text-cyan-400 transition-colors">{{ user.username }}</p>
                    <p class="text-[10px] text-slate-500">Người dùng ShieldCall</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Implementation -->
    <div class="flex-1 flex flex-col relative bg-transparent">
        <!-- Top Toolbar -->
        <div class="h-16 border-b border-white/10 px-6 flex items-center justify-between bg-white/[0.02] backdrop-blur-2xl sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button id="mobile-sidebar-toggle" class="md:hidden p-2 rounded-xl bg-white/5 text-slate-300 hover:text-white transition-colors">
                    <i class="bi bi-list text-xl"></i>
                </button>
                <div class="flex flex-col">
                    <h1 id="chat-title" class="text-sm font-bold text-slate-100 truncate max-w-[180px] md:max-w-md">Cuộc trò chuyện mới</h1>
                    <div id="chat-status" class="text-[9px] text-cyan-500/70 font-medium hidden">ShieldCall AI đang phân tích...</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex -space-x-2">
                    <div class="w-7 h-7 rounded-full border-2 border-[#020617] bg-slate-800 flex items-center justify-center text-[8px] font-bold text-slate-400">RAG</div>
                    <div class="w-7 h-7 rounded-full border-2 border-[#020617] bg-cyan-600 flex items-center justify-center text-[8px] font-black text-white shadow-lg shadow-cyan-500/20">AI</div>
                </div>
                <div class="h-4 w-[1px] bg-white/10 mx-1"></div>
                <button title="Lưu cuộc hội thoại" class="p-2 text-slate-500 hover:text-cyan-400 transition-colors"><i class="bi bi-bookmark"></i></button>
                <button title="Cài đặt AI" class="p-2 text-slate-500 hover:text-cyan-400 transition-colors"><i class="bi bi-gear"></i></button>
            </div>
        </div>

        <!-- Chat Content Window -->
        <div id="messages-wrapper" class="flex-1 overflow-y-auto custom-scrollbar relative px-4">
            <!-- Background Decorative Elements -->
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-cyan-500/5 blur-[120px] rounded-full -z-10 pointer-events-none"></div>
            <div class="absolute bottom-1/4 right-1/4 w-[500px] h-[500px] bg-blue-600/5 blur-[150px] rounded-full -z-10 pointer-events-none"></div>

            <div id="messages-container" class="max-w-4xl mx-auto py-10 space-y-10">
                <!-- Welcome State -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-1000">
                    <div class="relative">
                        <div class="absolute inset-0 bg-cyan-500/20 blur-2xl rounded-full scale-150 animate-pulse"></div>
                        <div class="w-20 h-20 rounded-[2rem] bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center shadow-2xl relative border border-white/20">
                            <i class="bi bi-shield-lock-fill text-4xl text-white"></i>
                        </div>
                        <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-slate-900 border-2 border-cyan-500 flex items-center justify-center shadow-lg">
                            <i class="bi bi-stars text-cyan-400 text-xs animate-spin-slow"></i>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h2 class="text-3xl font-black tracking-tight bg-gradient-to-r from-white via-slate-200 to-slate-500 bg-clip-text text-transparent italic">
                            ShieldCall Intelligence
                        </h2>
                        <p class="text-slate-400 text-sm max-w-md mx-auto leading-relaxed">
                            Trợ lý ảo thông minh sử dụng công nghệ RAG và dữ liệu bảo mật ShieldCall VN để bảo vệ bạn trong không gian số.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl mt-4">
                        <button onclick="setPrompt('Làm thế nào để nhận biết một kịch bản gọi lừa đảo mạo danh công an?')" 
                                class="flex flex-col p-4 rounded-2xl bg-white/[0.03] border border-white/5 text-left hover:bg-white/[0.06] hover:border-cyan-500/30 transition-all group active:scale-[0.98]">
                            <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-400 w-fit mb-3 group-hover:bg-cyan-500 group-hover:text-white transition-all">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-200 group-hover:text-cyan-400 transition-colors">Nhận diện mạo danh</span>
                            <span class="text-[10px] text-slate-500 mt-1">Tìm hiểu các kịch bản lừa đảo phổ biến nhất hiện nay.</span>
                        </button>
                        
                        <button onclick="setPrompt('Tôi muốn quét số điện thoại này: 0912345678')" 
                                class="flex flex-col p-4 rounded-2xl bg-white/[0.03] border border-white/5 text-left hover:bg-white/[0.06] hover:border-cyan-500/30 transition-all group active:scale-[0.98]">
                            <div class="p-2 rounded-lg bg-orange-500/10 text-orange-400 w-fit mb-3 group-hover:bg-orange-500 group-hover:text-white transition-all">
                                <i class="bi bi-search"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-200 group-hover:text-orange-400 transition-colors">Truy vấn rủi ro</span>
                            <span class="text-[10px] text-slate-500 mt-1">Quét SĐT, URL hoặc tài khoản trực tiếp trong ô chat.</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Padding for fixed input -->
            <div class="h-40"></div>
        </div>

        <!-- Float Input Section -->
        <div class="absolute bottom-0 left-0 right-0 p-6 pointer-events-none z-40">
            <div class="max-w-4xl mx-auto pointer-events-auto">
                <div class="relative group bg-white/[0.05] backdrop-blur-3xl border border-white/10 rounded-3xl p-4 shadow-[var(--glass-shadow)] transition-all focus-within:ring-2 focus-within:ring-cyan-500/20">
                    
                    <!-- Previews Area -->
                    <div id="image-previews" class="flex flex-wrap gap-3 mb-3 shrink-0"></div>

                    <div class="flex items-end gap-3">
                        <div class="flex-1 min-h-[48px] overflow-hidden">
                            <textarea id="user-input" rows="1" placeholder="Nhập tin nhắn..." 
                                class="w-full bg-transparent border-0 focus:ring-0 text-slate-100 py-3 px-1 resize-none custom-scrollbar text-sm placeholder:text-slate-600 min-h-[48px] max-h-48"></textarea>
                        </div>
                        
                        <div class="flex items-center gap-1.5 pb-1 pr-1">
                            <label class="cursor-pointer p-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all" title="Đính kèm ảnh/chụp màn hình">
                                <i class="bi bi-image text-lg"></i>
                                <input type="file" id="image-input" multiple accept="image/*" class="hidden">
                            </label>
                            
                            <button id="send-btn" class="w-12 h-12 rounded-[1.25rem] bg-gradient-to-tr from-cyan-600 to-blue-600 text-white hover:scale-105 active:scale-95 transition-all disabled:opacity-30 disabled:grayscale disabled:scale-100 shadow-xl shadow-cyan-500/20 flex items-center justify-center" disabled>
                                <div id="send-icon"><i class="bi bi-arrow-up-circle-fill text-2xl"></i></div>
                                <div id="loading-icon" class="hidden"><i class="bi bi-three-dots text-2xl animate-pulse"></i></div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Feature Tags & Options -->
                    <div class="mt-3 flex items-center gap-4 px-1">
                        <div class="flex items-center gap-1.5 hover:text-cyan-400 transition-all cursor-help" title="Phân tích ngữ cảnh từ bài học & tin tức">
                            <i class="bi bi-lightning-charge-fill text-[10px] text-cyan-400"></i>
                            <span class="text-[9px] font-black uppercase text-slate-400">RAG Enabled</span>
                        </div>
                        
                        <label class="flex items-center gap-2 cursor-pointer group/opt">
                            <div class="relative w-6 h-3 bg-white/10 rounded-full transition-colors group-hover/opt:bg-white/20">
                                <input type="checkbox" id="preview-ocr-toggle" class="sr-only peer">
                                <div class="absolute left-0.5 top-0.5 w-2 h-2 bg-slate-400 rounded-full transition-all peer-checked:left-3.5 peer-checked:bg-cyan-400"></div>
                            </div>
                            <span class="text-[9px] font-black uppercase text-slate-400 group-hover/opt:text-cyan-400 transition-colors">Preview OCR</span>
                        </label>

                        <div class="flex-1"></div>
                        <span class="text-[9px] text-slate-600 italic">Nhấn Shift+Enter để xuống dòng</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    .font-inter { font-family: 'Inter', sans-serif; }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.1); }

    .typing-cursor {
        display: inline-block;
        width: 3px;
        height: 15px;
        background: #06b6d4;
        margin-left: 2px;
        animation: blink 0.8s infinite;
        vertical-align: middle;
        border-radius: 10px;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }

    /* Message Bubbles - Premium Theme */
    .msg-anim { animation: msg-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes msg-pop {
        from { opacity: 0; transform: translateY(15px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .markdown-content h1, .markdown-content h2 { font-weight: 800; margin: 1.25rem 0 0.5rem; color: #fff; font-size: 1.1rem; }
    .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
    .markdown-content p:last-child { margin-bottom: 0; }
    .markdown-content code { background: rgba(255,255,255,0.08); padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.9em; color: #38bdf8; font-family: monospace; }
    .markdown-content pre { background: #000; padding: 1.25rem; border-radius: 1rem; overflow-x: auto; margin: 1rem 0; border: 1px solid rgba(255,255,255,0.05); }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 1rem; list-style: inherit; }
    .markdown-content li { margin-bottom: 0.4rem; }
    .markdown-content blockquote { border-left: 3px solid #06b6d4; padding-left: 1rem; color: #94a3b8; font-style: italic; margin: 1rem 0; }
    .markdown-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.8rem; }
    .markdown-content th, .markdown-content td { padding: 0.75rem; border: 1px solid rgba(255,255,255,0.05); text-align: left; }
    .markdown-content th { background: rgba(255,255,255,0.03); font-weight: bold; }

    /* Action Widget */
    .tool-widget {
        background: linear-gradient(135deg, rgba(8, 145, 178, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
        border: 1px solid rgba(6, 182, 212, 0.2);
        border-radius: 1.25rem;
        padding: 1rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        animation: msg-pop 0.5s ease-out;
    }
</style>

<!-- Marked for optimized UI -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    let currentSessionId = null;
    let isStreaming = false;
    let pendingImages = [];
    let lastRenderedTime = 0;
    const RENDER_THROTTLE_MS = 60; // Smooth out rendering to save CPU/Battery

    const messagesContainer = document.getElementById('messages-container');
    const welcomeScreen = document.getElementById('welcome-screen');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const sendIcon = document.getElementById('send-icon');
    const loadingIcon = document.getElementById('loading-icon');
    const historyContainer = document.getElementById('history-container');
    const imageInput = document.getElementById('image-input');
    const imagePreviews = document.getElementById('image-previews');
    const chatTitle = document.getElementById('chat-title');
    const chatStatus = document.getElementById('chat-status');
    const sidebar = document.getElementById('chat-sidebar');
    const mobileToggle = document.getElementById('mobile-sidebar-toggle');

    document.addEventListener('DOMContentLoaded', () => {
        loadSessions();
        userInput.focus();
        
        if (mobileToggle) {
            mobileToggle.addEventListener('click', () => sidebar.classList.toggle('hidden'));
        }

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 192) + 'px';
            updateSendBtnState();
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.onclick = sendMessage;
        document.getElementById('new-chat-btn').onclick = startNewChat;
        imageInput.onchange = handleImageUpload;
    });

    function updateSendBtnState() {
        sendBtn.disabled = !userInput.value.trim() && pendingImages.length === 0;
    }

    async function clearHistory() {
        if (!confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử trò chuyện?')) return;
        try {
            const res = await fetch('/api/v1/chat/sessions/clear_all/', {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.ok) {
                startNewChat();
                showToast('Đã xóa toàn bộ lịch sử', 'success');
            }
        } catch (err) { showToast('Lỗi khi xóa lịch sử', 'error'); }
    }

    async function loadSessions() {
        try {
            const res = await fetch('/api/v1/chat/sessions/');
            const data = await res.json();
            document.getElementById('session-count').innerText = data.length;
            
            if (data.length === 0) {
                historyContainer.innerHTML = '<div class="p-8 text-center text-slate-600 text-[10px] italic">Chưa có lịch sử hội thoại.</div>';
                return;
            }

            historyContainer.innerHTML = '';
            data.forEach(s => {
                const isActive = currentSessionId == s.id;
                const item = document.createElement('div');
                item.className = `group relative p-3 rounded-2xl cursor-pointer transition-all duration-300 ${isActive ? 'bg-cyan-500/10 border border-cyan-500/20' : 'hover:bg-white/[0.03] border border-transparent'}`;
                item.innerHTML = `
                    <div class="flex items-center gap-3" onclick="loadSessionDetail('${s.id}')">
                        <div class="w-8 h-8 rounded-xl bg-slate-900 flex items-center justify-center shrink-0 border border-white/5">
                            <i class="bi bi-chat-text ${isActive ? 'text-cyan-400' : 'text-slate-500'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-[11px] font-semibold ${isActive ? 'text-slate-100' : 'text-slate-400'} truncate">${s.title || 'Cuộc trò chuyện mới'}</p>
                            <p class="text-[9px] text-slate-600 mt-0.5">${new Date(s.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                historyContainer.appendChild(item);
            });
        } catch (err) { console.error(err); }
    }

    async function loadSessionDetail(sessionId) {
        if (isStreaming) return;
        currentSessionId = sessionId;
        welcomeScreen.classList.add('hidden');
        messagesContainer.innerHTML = '<div class="flex flex-col items-center py-20 gap-4"><div class="animate-spin w-6 h-6 border-2 border-cyan-500 border-t-transparent rounded-full"></div><p class="text-xs text-slate-500">Đang đồng bộ tin nhắn...</p></div>';
        
        try {
            const res = await fetch(`/api/v1/chat/sessions/${sessionId}/`);
            const data = await res.json();
            chatTitle.innerText = data.title;
            messagesContainer.innerHTML = '';
            data.messages.forEach(m => addMessage(m.role, m.message, [], false));
            scrollToBottom();
            loadSessions();
        } catch (err) { console.error(err); }
    }

    function startNewChat() {
        if (isStreaming) return;
        currentSessionId = null;
        welcomeScreen.classList.remove('hidden');
        messagesContainer.innerHTML = '';
        chatTitle.innerText = "Cuộc trò chuyện mới";
        userInput.value = '';
        updateSendBtnState();
        loadSessions();
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        const images = [...pendingImages];
        if ((!text && images.length === 0) || isStreaming) return;

        isStreaming = true;
        sendBtn.disabled = true;
        sendIcon.classList.add('hidden');
        loadingIcon.classList.remove('hidden');
        welcomeScreen.classList.add('hidden');
        chatStatus.classList.remove('hidden');

        addMessage('user', text, images);
        
        userInput.value = '';
        userInput.style.height = '48px';
        pendingImages = [];
        imagePreviews.innerHTML = '';

        const assistantMsgDiv = addMessage('assistant', '', [], true);
        const contentDiv = assistantMsgDiv.querySelector('.markdown-content');
        let fullContent = "";

        const previewOcr = document.getElementById('preview-ocr-toggle').checked;

        try {
            const response = await fetch('/api/v1/chat/stream/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ 
                    user_message: text, 
                    session_id: currentSessionId, 
                    images: images,
                    preview_ocr: previewOcr
                })
            });

            if (!response.ok) throw new Error("Connection failed");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep partial line in buffer
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(trimmedLine.substring(6));
                            if (data.chunk) {
                                // Clear status when content starts
                                updateChatStatus('active');
                                fullContent += data.chunk;
                                throttleRender(contentDiv, fullContent);
                            }
                            if (data.status) {
                                let statusText = "AI đang xử lý...";
                                if (data.status === 'searching_knowledge') statusText = "AI đang tìm kiếm thông tin...";
                                if (data.status === 'thinking') statusText = "AI đang suy nghĩ...";
                                if (data.status === 'processing_images') statusText = "AI đang phân tích ảnh...";
                                updateChatStatus('waiting', statusText);
                            }
                            if (data.annotated_image) {
                                addAnnotatedImage(assistantMsgDiv, data.annotated_image);
                            }
                            if (data.session_id) currentSessionId = data.session_id;
                            if (data.title) chatTitle.innerText = data.title;
                            if (data.done) {
                                updateChatStatus('idle');
                                finishStream(contentDiv, assistantMsgDiv, fullContent);
                            }
                            if (data.error) throw new Error(data.error);
                        } catch (e) { console.warn("JSON parse error", e); }
                    }
                }
                scrollToBottom();
            }
        } catch (err) {
            contentDiv.innerHTML = `<p class="text-red-400">⚠️ Error: ${err.message}</p>`;
            finalizeState();
        }
    }

    function throttleRender(el, text) {
        const now = Date.now();
        if (now - lastRenderedTime > RENDER_THROTTLE_MS) {
            el.innerHTML = marked.parse(text) + '<span class="typing-cursor"></span>';
            lastRenderedTime = now;
        }
    }

    function finishStream(el, container, text) {
        el.innerHTML = marked.parse(text);
        processToolInText(container, text);
        finalizeState();
        loadSessions();
    }

    function finalizeState() {
        isStreaming = false;
        sendBtn.disabled = false;
        sendIcon.classList.remove('hidden');
        loadingIcon.classList.add('hidden');
        chatStatus.classList.add('hidden');
    }

    function addMessage(role, text, images = [], isNew = false) {
        const div = document.createElement('div');
        div.className = `flex w-full gap-4 ${role === 'user' ? 'flex-row-reverse' : ''} msg-anim`;
        
        const avatar = role === 'user' 
            ? `<div class="w-8 h-8 rounded-full bg-slate-800 border border-white/5 flex items-center justify-center shrink-0"><i class="bi bi-person text-slate-500"></i></div>`
            : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-600 to-blue-600 border border-white/10 flex items-center justify-center shrink-0 shadow-lg shadow-cyan-500/20"><i class="bi bi-cpu-fill text-white text-xs"></i></div>`;

        const bubbleClass = role === 'user' 
            ? 'bg-cyan-600/90 text-white rounded-[1.5rem] rounded-tr-none' 
            : 'bg-white/[0.03] border border-white/5 text-slate-200 rounded-[1.5rem] rounded-tl-none backdrop-blur-md';

        let imgHtml = images.length ? `<div class="flex gap-2 mb-3">${images.map(i => `<img src="${i}" class="w-32 h-32 object-cover rounded-xl border border-white/10 shadow-lg">`).join('')}</div>` : '';

        div.innerHTML = `
            ${avatar}
            <div class="max-w-[85%] md:max-w-[75%] px-0.5">
                <div class="${bubbleClass} p-4 shadow-xl">
                    ${imgHtml}
                    <div class="markdown-content prose prose-invert text-[13.5px]">${isNew ? '<span class="typing-cursor"></span>' : marked.parse(text)}</div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(div);
        return div;
    }

    function addAnnotatedImage(container, base64) {
        const bubble = container.querySelector('.bg-white\\/\\[0\\.03\\]');
        if (!bubble) return;
        const imgDiv = document.createElement('div');
        imgDiv.className = 'mt-3 mb-4 rounded-xl overflow-hidden border border-cyan-500/30 shadow-lg shadow-cyan-500/10 animate-in fade-in zoom-in duration-500';
        imgDiv.innerHTML = `
            <div class="bg-cyan-500/10 px-3 py-1.5 border-b border-cyan-500/20 flex items-center justify-between">
                <span class="text-[9px] font-black uppercase text-cyan-400 tracking-widest flex items-center gap-1.5">
                    <i class="bi bi-cpu"></i> OCR RAW ANALYSIS
                </span>
                <span class="text-[8px] text-cyan-400/60 font-medium">Click to expand</span>
            </div>
            <img src="${base64}" class="w-full h-auto cursor-zoom-in hover:brightness-110 transition-all" onclick="window.open(this.src)">
        `;
        bubble.insertBefore(imgDiv, bubble.querySelector('.markdown-content'));
    }

    function processToolInText(div, text) {
        const types = { 'SCAN_PHONE': 'phone', 'SCAN_DOMAIN': 'domain', 'SCAN_ACCOUNT': 'account' };
        for (const [key, type] of Object.entries(types)) {
            const match = text.match(new RegExp(`\\[\\[${key}:(.*?)\\]\\]`));
            if (match) {
                const widget = document.createElement('div');
                widget.className = 'tool-widget';
                const icons = { 'phone': 'bi-phone-vibrate', 'domain': 'bi-globe-central-south', 'account': 'bi-bank' };
                widget.innerHTML = `
                    <div class="w-12 h-12 rounded-2xl bg-cyan-500/20 flex items-center justify-center text-cyan-400 border border-cyan-500/30"><i class="bi ${icons[type]} text-xl"></i></div>
                    <div class="flex-1"><p class="text-[9px] font-black uppercase text-cyan-500 tracking-widest">Phát hiện mục tiêu</p><p class="text-xs font-bold text-white">${match[1]}</p></div>
                    <button onclick="window.open('/dashboard/?scan=${encodeURIComponent(match[1])}&type=${type}', '_blank')" class="px-4 py-2 rounded-xl bg-cyan-600 text-[10px] font-black hover:bg-cyan-500 transition-all shadow-lg active:scale-95">KIỂM TRA</button>
                `;
                div.querySelector('.max-w-\\[85\\%\\]').appendChild(widget);
            }
        }
    }

    function setPrompt(t) {
        userInput.value = t;
        userInput.dispatchEvent(new Event('input'));
        userInput.focus();
    }

    function scrollToBottom() {
        const w = document.getElementById('messages-wrapper');
        w.scrollTo({ top: w.scrollHeight, behavior: 'smooth' });
    }

    function handleImageUpload(e) {
        Array.from(e.target.files).forEach(f => {
            const r = new FileReader();
            r.onload = ev => {
                pendingImages.push(ev.target.result);
                const p = document.createElement('div');
                p.className = 'relative w-16 h-16 rounded-xl overflow-hidden border border-white/10 group';
                p.innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-cover">
                               <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer" onclick="this.parentElement.remove(); pendingImages=pendingImages.filter(i=>i!=='${ev.target.result}'); updateSendBtnState();">
                               <i class="bi bi-x-circle text-white"></i></div>`;
                imagePreviews.appendChild(p);
                updateSendBtnState();
            };
            r.readAsDataURL(f);
        });
    }

    function getCookie(n) {
        let v = null;
        if(document.cookie && document.cookie!=='') {
            document.cookie.split(';').forEach(c=>{
                let t = c.trim();
                if(t.substring(0,n.length+1)===(n+'=')) v=decodeURIComponent(t.substring(n.length+1));
            });
        }
        return v;
    }
</script>
{% endblock %}
