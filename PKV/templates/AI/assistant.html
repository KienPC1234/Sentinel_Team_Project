{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hỏi đáp AI - ShieldCall VN</title>
    
    <script>
        (function() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            if (saved === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        })();
    </script>

    {% tailwind_css %}
    <link rel="icon" type="image/png" href="{% static 'logo.png' %}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Liquid Glass Redesign */
        :root, [data-theme="dark"] {
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(40px) saturate(180%);
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --body-bg: #020617;
        }

        [data-theme="light"] {
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.08);
            --glass-blur: blur(20px);
            --glass-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            --text-primary: #1a1a2e;
            --text-secondary: #475569;
            --body-bg: #f8fafc;
        }

        .markdown-content hr {
            border: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-cyan), transparent);
            margin: 1.5rem 0;
            opacity: 0.4;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--body-bg);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .mesh-bg {
            position: fixed;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background-color: var(--body-bg);
            background-image: 
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%);
            z-index: -10;
        }

        [data-theme="light"] .mesh-bg {
            background-image: none;
        }

        .msg-assistant {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            backdrop-filter: var(--glass-blur);
            color: var(--text-primary);
        }

        /* Light mode specific text overrides */
        [data-theme="light"] .text-white { color: var(--text-primary) !important; }
        [data-theme="light"] .text-white\/40 { color: var(--text-secondary) !important; }
        [data-theme="light"] .text-white\/70 { color: var(--text-secondary) !important; }
        [data-theme="light"] .bg-white\/5 { background-color: rgba(0,0,0,0.05) !important; }
        [data-theme="light"] .border-white\/10 { border-color: rgba(0,0,0,0.1) !important; }
        [data-theme="light"] h1, [data-theme="light"] h2 { color: var(--text-primary) !important; }
        [data-theme="light"] .markdown-content { color: var(--text-primary) !important; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.01); }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, transparent, rgba(6, 182, 212, 0.2), transparent);
            border-radius: 10px;
        }

        /* Message Bubbles - Liquid Glass Variant */
        .msg-group {
            position: relative;
            padding: 0.5rem;
            height: 100%;
        }

        .msg-actions {
            position: absolute;
            bottom: -20px;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px);
            pointer-events: none;
        }
        .msg-actions-user { right: 0; }
        .msg-actions-assistant { left: 0; }

        .msg-group:hover .msg-actions {
            opacity: 1;
            transform: translateY(0);
            bottom: -15px;
            pointer-events: auto;
        }

        .msg-bubble {
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            max-width: 85%;
            line-height: 1.6;
            position: relative;
            box-shadow: var(--glass-shadow);
        }

        .msg-user {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.4) 0%, rgba(37, 99, 235, 0.4) 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
            color: white !important;
        }

        /* Assistants bubble is handled above via .msg-assistant */

        /* Thinking Block */
        .thinking-container {
            margin-bottom: 0.75rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .thinking-header {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            background: rgba(255, 255, 255, 0.02);
        }
        .thinking-header:hover { background: rgba(255, 255, 255, 0.04); }
        .thinking-header i.bi-chevron-down { transition: transform 0.3s ease; }
        .thinking-container.collapsed i.bi-chevron-down { transform: rotate(-90deg); }
        .thinking-content {
            padding: 0.75rem;
            font-size: 11px;
            color: rgba(203, 213, 225, 0.7);
            font-style: italic;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.03);
            display: block;
        }
        .thinking-container.collapsed .thinking-content { display: none; }
        
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 15px;
            background: #06b6d4;
            margin-left: 2px;
            animation: blink 0.8s infinite;
            vertical-align: middle;
            border-radius: 10px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        @keyframes title-reveal {
            from { opacity: 0; transform: translateY(-8px); filter: blur(3px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }
        .title-reveal {
            animation: title-reveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        .markdown-content h1, .markdown-content h2 { font-weight: 800; margin: 1.25rem 0 0.5rem; color: #fff; font-size: 1.1rem; }
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content code { background: rgba(255,255,255,0.08); padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.9em; color: #38bdf8; font-family: monospace; }
        .markdown-content pre { background: #000; padding: 1.25rem; border-radius: 1rem; overflow-x: auto; margin: 1rem 0; border: 1px solid rgba(255,255,255,0.05); }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 1rem; list-style: inherit; }
        .markdown-content li { margin-bottom: 0.4rem; }
        .markdown-content blockquote { border-left: 3px solid #06b6d4; padding-left: 1rem; color: #94a3b8; font-style: italic; margin: 1rem 0; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.8rem; }
        .markdown-content th, .markdown-content td { padding: 0.75rem; border: 1px solid rgba(255,255,255,0.05); text-align: left; }
        .markdown-content th { background: rgba(255,255,255,0.03); font-weight: bold; }

        /* Action Widget */
        .tool-widget {
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 1.25rem;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        textarea:focus {
            outline: none !important;
            border: 1px solid rgba(6, 182, 212, 0.4) !important;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1) !important;
        }
        textarea {
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            background: rgba(255, 255, 255, 0.02) !important;
        }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 antialiased h-screen overflow-hidden">
    <div class="mesh-bg"></div>
    
    <div class="flex h-screen overflow-hidden bg-transparent relative">
        <script>
            // Pass Django context to JS
            const INITIAL_SESSION_ID = "{{ initial_session_id|default:'' }}";
            const CURRENT_USER = "{{ user.username|default:'Bạn' }}";
        </script>
        
        <!-- Sidebar: Liquid Glass History List -->
        <div id="chat-sidebar" class="w-80 border-r border-white/10 bg-white/[0.03] backdrop-blur-3xl flex flex-col hidden md:flex transition-all duration-300 z-30">
            <div class="p-5 border-b border-white/10">
                <button id="new-chat-btn" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-cyan-500/20 to-blue-500/20 text-cyan-400 border border-cyan-500/30 hover:from-cyan-500/30 hover:to-blue-500/30 transition-all flex items-center justify-center gap-3 font-semibold text-sm group shadow-lg shadow-cyan-500/10">
                    <i class="bi bi-plus-lg group-hover:rotate-90 transition-transform duration-300"></i>
                    Hội thoại mới
                </button>
            </div>
            
            <div class="px-5 py-4 flex items-center justify-between">
                <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] text-cyan-400/60">Lịch sử trò chuyện</h3>
                <div class="flex items-center gap-2">
                    <span id="session-count" class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-slate-400 font-bold">0</span>
                    <button onclick="clearHistory()" title="Xóa toàn bộ lịch sử" class="text-slate-500 hover:text-red-400 transition-colors p-1">
                        <i class="bi bi-trash-fill text-[10px]"></i>
                    </button>
                </div>
            </div>

            <div id="history-container" class="flex-1 overflow-y-auto px-3 space-y-1.5 custom-scrollbar">
                <!-- Sessions list will be loaded here -->
            </div>

            <!-- User Profile Card -->
            <div class="p-5 bg-white/[0.02] border-t border-white/10">
                <div class="flex items-center gap-4 p-3 rounded-xl bg-white/[0.05] border border-white/10 group hover:bg-white/[0.08] transition-all cursor-pointer" onclick="window.location.href='/profile/'">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-600/20 flex items-center justify-center text-cyan-400 font-black border border-cyan-500/30 shadow-inner">
                        {{ user.username|slice:":1"|upper }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-slate-100 truncate group-hover:text-cyan-400 transition-colors">{{ user.get_full_name|default:user.username }}</p>
                        <p class="text-[10px] text-slate-500">Người dùng ShieldCall</p>
                    </div>
                </div>
            </div>

            <div class="px-5 py-3 border-t border-white/5 bg-black/10">
                <a href="/" class="flex items-center gap-3 w-full p-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                    <i class="bi bi-house-door text-lg group-hover:scale-110 transition-transform"></i>
                    <span class="text-[11px] font-semibold">Trang chủ ShieldCall</span>
                </a>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col relative bg-transparent">
            <!-- Top Toolbar -->
            <div class="h-16 border-b border-white/10 px-6 flex items-center justify-between bg-white/[0.02] backdrop-blur-2xl sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <button id="mobile-sidebar-toggle" class="md:hidden p-2 rounded-xl bg-white/5 text-slate-300 hover:text-white transition-colors">
                        <i class="bi bi-list text-xl"></i>
                    </button>
                    <div class="flex flex-col">
                        <h1 id="chat-title" class="text-sm font-bold text-slate-100 truncate max-w-[180px] md:max-w-md">Cuộc trò chuyện mới</h1>
                        <div id="chat-status" class="text-[9px] text-cyan-500/70 font-medium hidden">AI đang xử lý...</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex -space-x-2">
                        <div class="w-7 h-7 rounded-full border-2 border-[#020617] bg-slate-800 flex items-center justify-center text-[8px] font-bold text-slate-400">RAG</div>
                        <div class="w-7 h-7 rounded-full border-2 border-[#020617] bg-cyan-600 flex items-center justify-center text-[8px] font-black text-white shadow-lg shadow-cyan-500/20">AI</div>
                    </div>
                </div>
            </div>

            <!-- Chat Content Window -->
            <div id="messages-wrapper" class="flex-1 overflow-y-auto custom-scrollbar relative px-4">
                <div id="messages-container" class="max-w-4xl mx-auto py-10 space-y-10">
                    <!-- Welcome State -->
                    <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-1000">
                        <div class="relative">
                            <div class="absolute inset-0 bg-cyan-500/20 blur-2xl rounded-full scale-150 animate-pulse"></div>
                            <i class="bi bi-shield-lock-fill text-7xl text-cyan-500 drop-shadow-[0_0_15px_rgba(6,182,212,0.5)]"></i>
                        </div>
                        <div class="space-y-3">
                            <h2 class="text-4xl font-black tracking-tight text-white glow-text">ShieldCall Intelligence</h2>
                            <p class="text-slate-400 text-sm max-w-lg mx-auto leading-relaxed">Trợ lý ảo thông minh sử dụng công nghệ RAG và dữ liệu bảo mật ShieldCall VN để bảo vệ bạn trong không gian số.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl px-4">
                            <div onclick="setPrompt('Kiểm tra số điện thoại 0123456789 có lừa đảo không?')" class="group p-5 rounded-2xl bg-white/[0.03] border border-white/10 hover:bg-white/[0.06] hover:border-cyan-500/30 transition-all cursor-pointer text-left">
                                <i class="bi bi-search text-cyan-400 text-xl mb-3 block"></i>
                                <p class="text-sm font-bold text-slate-200 mb-1">Truy vấn rủi ro</p>
                                <p class="text-[10px] text-slate-500">Quét SĐT, URL hoặc tài khoản trực tiếp trong ô chat.</p>
                            </div>
                            <div onclick="setPrompt('Các kịch bản lừa đảo phổ biến nhất hiện nay là gì?')" class="group p-5 rounded-2xl bg-white/[0.03] border border-white/10 hover:bg-white/[0.06] hover:border-cyan-500/30 transition-all cursor-pointer text-left">
                                <i class="bi bi-journal-text text-cyan-400 text-xl mb-3 block"></i>
                                <p class="text-sm font-bold text-slate-200 mb-1">Nhận diện mạo danh</p>
                                <p class="text-[10px] text-slate-500">Tìm hiểu các kịch bản lừa đảo phổ biến nhất hiện nay.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-40"></div>
            </div>

            <!-- Float Input Section -->
            <div class="absolute bottom-0 left-0 right-0 p-6 pointer-events-none z-40">
                <div class="max-w-4xl mx-auto pointer-events-auto">
                    <div class="relative group bg-white/[0.05] backdrop-blur-3xl border border-white/10 rounded-3xl p-4 shadow-[var(--glass-shadow)] transition-all focus-within:ring-2 focus-within:ring-cyan-500/20">
                        <div id="image-previews" class="flex flex-wrap gap-3 mb-3 shrink-0"></div>

                        <div class="flex items-end gap-3">
                            <div class="flex-1 min-h-[48px] overflow-hidden">
                                <textarea id="user-input" rows="1" placeholder="Nhập tin nhắn..." 
                                    class="w-full bg-transparent border-0 focus:ring-0 text-slate-100 py-3 px-1 resize-none custom-scrollbar text-sm placeholder:text-slate-600 min-h-[48px] max-h-48"></textarea>
                            </div>
                            
                            <div class="flex items-center gap-1.5 pb-1 pr-1">
                                <label class="cursor-pointer p-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all" title="Đính kèm ảnh">
                                    <i class="bi bi-image text-lg"></i>
                                    <input type="file" id="image-input" multiple accept="image/*" class="hidden">
                                </label>
                                
                                <button id="send-btn" class="w-12 h-12 rounded-[1.25rem] bg-gradient-to-tr from-cyan-600 to-blue-600 text-white hover:scale-105 active:scale-95 transition-all disabled:opacity-30 disabled:grayscale disabled:scale-100 shadow-xl shadow-cyan-500/20 flex items-center justify-center font-bold" disabled>
                                    <div id="send-icon"><i class="bi bi-arrow-up-circle-fill text-2xl"></i></div>
                                    <div id="stop-icon" class="hidden text-white"><i class="bi bi-stop-circle-fill text-2xl"></i></div>
                                    <div id="loading-icon" class="hidden"><i class="bi bi-three-dots text-2xl animate-pulse"></i></div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex items-center gap-4 px-1">
                            <div class="flex items-center gap-1.5">
                                <i class="bi bi-lightning-charge-fill text-[10px] text-cyan-400"></i>
                                <span class="text-[9px] font-black uppercase text-slate-400 tracking-tighter">ShieldCall RAG Enabled</span>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer group/opt">
                                <div class="relative w-6 h-3 bg-white/10 rounded-full transition-colors group-hover/opt:bg-white/20">
                                    <input type="checkbox" id="preview-ocr-toggle" class="sr-only peer">
                                    <div class="absolute left-0.5 top-0.5 w-2 h-2 bg-slate-400 rounded-full transition-all peer-checked:left-3.5 peer-checked:bg-cyan-400"></div>
                                </div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">Preview Image OCR</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = INITIAL_SESSION_ID;
        let isStreaming = false;
        let abortController = null;
        let pendingImages = [];
        let lastRenderedTime = 0;
        let editModeMessageId = null;
        const RENDER_THROTTLE_MS = 60;

        const messagesContainer = document.getElementById('messages-container');
        const messagesWrapper = document.getElementById('messages-wrapper');
        const welcomeScreen = document.getElementById('welcome-screen');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendIcon = document.getElementById('send-icon');
        const stopIcon = document.getElementById('stop-icon');
        const loadingIcon = document.getElementById('loading-icon');
        const historyContainer = document.getElementById('history-container');
        const imageInput = document.getElementById('image-input');
        const imagePreviews = document.getElementById('image-previews');
        const chatTitle = document.getElementById('chat-title');
        const chatStatus = document.getElementById('chat-status');
        const sidebar = document.getElementById('chat-sidebar');
        const mobileToggle = document.getElementById('mobile-sidebar-toggle');

        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            if (INITIAL_SESSION_ID) {
                loadSessionDetail(INITIAL_SESSION_ID);
            }
            userInput.focus();

            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
                updateSendBtnState();
            });

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) sendMessage();
                }
            });

            sendBtn.onclick = () => {
                if (isStreaming) {
                    stopGeneration();
                } else {
                    sendMessage();
                }
            };
            
            document.getElementById('new-chat-btn').onclick = startNewChat;
            imageInput.onchange = handleImageUpload;
            if (mobileToggle) {
                mobileToggle.onclick = () => sidebar.classList.toggle('hidden');
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            const images = [...pendingImages];
            if (!text && images.length === 0) return;

            isStreaming = true;
            updateSendBtnState();
            sendIcon.classList.add('hidden');
            stopIcon.classList.remove('hidden');
            welcomeScreen.classList.add('hidden');
            chatStatus.classList.remove('hidden');

            addMessage('user', text, images);
            
            if (editModeMessageId) {
                try {
                    await fetch(`/api/v1/chat/messages/${editModeMessageId}/delete_after/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });
                    clearEditMode();
                } catch (err) { console.error("Truncation failed", err); }
            }

            userInput.value = '';
            userInput.style.height = '48px';
            pendingImages = [];
            imagePreviews.innerHTML = '';
            abortController = new AbortController();

            const assistantMsgDiv = addMessage('assistant', '', [], true);
            if (!assistantMsgDiv) {
                console.error("Failed to create assistant message div");
                isStreaming = false;
                updateSendBtnState();
                return;
            }
            const contentDiv = assistantMsgDiv.querySelector('.markdown-content');
            let fullContent = "";

            const previewOcr = document.getElementById('preview-ocr-toggle').checked;

            try {
                const response = await fetch('/api/v1/chat/stream/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    signal: abortController.signal,
                    body: JSON.stringify({ 
                        user_message: text, 
                        session_id: currentSessionId, 
                        images: images,
                        preview_ocr: previewOcr
                    })
                });

                if (!response.ok) throw new Error("Connection failed");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let currentThinking = "";
                const thinkingBox = assistantMsgDiv.querySelector('.thinking-container');
                const thinkingContentDiv = assistantMsgDiv.querySelector('.thinking-content');

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(trimmedLine.substring(6));
                                if (data.chunk && !data.chunk.startsWith('__')) {
                                    chatStatus.innerText = "AI đang trả lời...";
                                    if (currentThinking && !thinkingBox.classList.contains('collapsed')) {
                                        thinkingBox.classList.add('collapsed');
                                    }
                                    fullContent += data.chunk;
                                    throttleRender(contentDiv, fullContent);
                                }
                                if (data.chunk && data.chunk.startsWith('__THINK__:')) {
                                    currentThinking += data.chunk.substring(10);
                                    thinkingBox.classList.remove('hidden');
                                    thinkingContentDiv.innerText = currentThinking;
                                    scrollToBottom();
                                }
                                if (data.status) {
                                    let statusText = "AI đang xử lý...";
                                    if (data.status === 'searching_knowledge') statusText = "AI đang tìm thông tin...";
                                    if (data.status === 'thinking') {
                                        statusText = "AI đang suy nghĩ...";
                                        thinkingBox.classList.remove('hidden');
                                    }
                                    chatStatus.innerText = statusText;
                                }
                                if (data.chunk && (data.chunk.startsWith('__SEARCH_RESULTS__:') || data.chunk.startsWith('__METADATA__:'))) {
                                    const marker = data.chunk.startsWith('__METADATA__:') ? '__METADATA__:' : '__SEARCH_RESULTS__:';
                                    const metaStr = data.chunk.substring(marker.length);
                                    try {
                                        const metaData = JSON.parse(metaStr);
                                        // If it's __SEARCH_RESULTS__, it's just the web search array
                                        // If it's __METADATA__, it might contain both web_search and internal_knowledge
                                        const processedMeta = marker === '__SEARCH_RESULTS__:' ? { web_search: metaData } : metaData;
                                        renderSearchResults(assistantMsgDiv, processedMeta);
                                    } catch (e) { console.warn("Meta parse error", e); }
                                }
                                if (data.annotated_image) {
                                    addAnnotatedImage(assistantMsgDiv, data.annotated_image);
                                }
                                if (data.session_id) currentSessionId = data.session_id;
                                if (data.title && data.title !== 'Guest Session') {
                                    if (data.title !== chatTitle.innerText) {
                                        chatTitle.classList.remove('title-reveal');
                                        void chatTitle.offsetWidth; // Trigger reflow for animation restart
                                        chatTitle.innerText = data.title;
                                        chatTitle.classList.add('title-reveal');
                                        
                                        if (data.title !== 'Cuộc trò chuyện mới') {
                                            loadSessions(); // Update sidebar list
                                        }
                                    }
                                }
                                if (data.done) {
                                    finishStream(contentDiv, assistantMsgDiv, fullContent);
                                }
                            } catch (e) { console.warn("Parse error", e); }
                        }
                    }
                    scrollToBottom();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    contentDiv.innerHTML = `<p class="text-red-400 italic">⚠️ Lỗi: ${err.message}</p>`;
                    showToast('Lỗi kết nối AI', 'error');
                }
                finishStream(contentDiv, assistantMsgDiv, fullContent);
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                isStreaming = false;
                showToast('Đã dừng phản hồi', 'info');
                finishStream();
            }
        }

        function finishStream(contentDiv, assistantMsgDiv, fullContent) {
            isStreaming = false;
            sendIcon.classList.remove('hidden');
            stopIcon.classList.add('hidden');
            chatStatus.classList.add('hidden');
            updateSendBtnState();
            
            if (contentDiv && fullContent) {
                contentDiv.innerHTML = marked.parse(fullContent);
                processToolInText(assistantMsgDiv, fullContent);
                // Update raw text for copying
                const actions = assistantMsgDiv.querySelector('.msg-actions');
                if (actions) actions.dataset.rawText = encodeURIComponent(fullContent);
            }
            scrollToBottom();
            loadSessions();
        }

        function addMessage(role, text, images = [], isNew = false, messageId = null, metadata = null) {
            const div = document.createElement('div');
            div.className = `msg-group flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            if (messageId) div.dataset.messageId = messageId;
            
            const userDisplayName = "{{ user.get_full_name|default:user.first_name|default:user.username }}";
            const bubbleClass = role === 'user' ? 'msg-user' : 'msg-assistant';
            const label = role === 'user' ? 
                `<div class="text-[9px] font-black uppercase text-slate-500 mb-1.5 px-2 text-right">${userDisplayName}</div>` : 
                `<div class="text-[9px] font-black uppercase text-cyan-500 mb-1.5 px-2 flex items-center gap-1.5"><i class="bi bi-shield-check"></i> ShieldCall AI</div>`;

            let imgHtml = '';
            if (images && images.length > 0) {
                imgHtml = `<div class="flex flex-wrap gap-2 mb-3">`;
                images.forEach(src => {
                    imgHtml += `<img src="${src}" class="w-32 h-32 object-cover rounded-xl border border-white/10 hover:scale-105 transition-transform cursor-zoom-in" onclick="window.open(this.src)">`;
                });
                imgHtml += `</div>`;
            }

            div.innerHTML = `
                <div class="max-w-[85%] relative">
                    ${label}
                    <div class="msg-bubble ${bubbleClass} relative">
                        ${imgHtml}
                        ${role === 'assistant' ? `
                            <div class="thinking-container hidden">
                                <div class="thinking-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                    <i class="bi bi-chevron-down text-[10px] text-cyan-500/50"></i>
                                    <span class="text-[9px] font-bold uppercase tracking-widest text-cyan-500/50">Quá trình suy luận</span>
                                </div>
                                <div class="thinking-content"></div>
                            </div>
                        ` : ''}
                        <div class="markdown-content prose prose-invert text-[13.5px]">
                            ${isNew ? '<span class="typing-cursor"></span>' : (() => {
                                let content = text;
                                // Clean legacy SCAN tags if any leak
                                content = content.replace(/\[\[SCAN_[^\]]*\]\]/g, "");
                                
                                if (role === 'user' && content.includes('[Nội dung từ ảnh]')) {
                                    const ocrPart = text.match(/\[Nội dung từ ảnh\]:?([\s\S]*)/)?.[1] || "";
                                    content = content.replace(/\[Nội dung từ ảnh\]:?[\s\S]*/g, '').trim();
                                    return `
                                        <details class="mb-3 bg-white/5 rounded-xl overflow-hidden border border-white/10">
                                            <summary class="px-4 py-2 text-[10px] font-bold text-cyan-400 cursor-pointer hover:bg-white/5 transition-all flex items-center gap-2">
                                                <i class="bi bi-card-text"></i> Xem nội dung trích xuất từ ảnh
                                            </summary>
                                            <div class="px-4 py-3 text-[11px] text-slate-400 italic border-t border-white/5 bg-black/20">
                                                ${marked.parse(ocrPart)}
                                            </div>
                                        </details>
                                        ${marked.parse(content || "[Gửi ảnh]")}
                                    `;
                                }
                                return marked.parse(content);
                            })()}
                        </div>
                        <div class="search-results-container mt-4 space-y-2 empty:hidden"></div>
                    </div>
                    <div class="msg-actions ${role === 'user' ? 'msg-actions-user' : 'msg-actions-assistant'}" data-raw-text="${encodeURIComponent(text)}">
                        <button onclick="copyToClipboard(this)" class="p-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-slate-400 transition-all"><i class="bi bi-clipboard"></i></button>
                        ${role === 'user' ? `<button onclick="editMessage(this, ${messageId}, \`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="p-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-slate-400 transition-all"><i class="bi bi-pencil"></i></button>` : ''}
                    </div>
                </div>
            `;
            if (metadata) {
                renderSearchResults(div, metadata);
            }

            messagesContainer.appendChild(div);
            return div;
        }

        async function loadSessions() {
            try {
                const [sessRes, foldRes] = await Promise.all([
                    fetch('/api/v1/chat/sessions/'),
                    fetch('/api/v1/chat/folders/')
                ]);
                const sessions = await sessRes.json();
                const folders = await foldRes.json();

                historyContainer.innerHTML = '';
                
                // 1. Render Folders
                folders.forEach(f => {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder-item group mb-1';
                    folderDiv.innerHTML = `
                        <div class="flex items-center justify-between p-2 rounded-lg hover:bg-white/5 cursor-pointer text-slate-400 hover:text-cyan-400 transition-all border border-transparent hover:border-white/10" 
                             onclick="toggleFolder(this)" ondragover="event.preventDefault()" ondrop="handleDropToFolder(event, ${f.id})">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="bi bi-chevron-right text-[10px] transition-transform"></i>
                                <i class="bi bi-folder2 text-sm text-cyan-500/50"></i>
                                <span class="text-xs font-bold truncate">${f.name}</span>
                            </div>
                            <button onclick="event.stopPropagation(); deleteFolder(${f.id})" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400"><i class="bi bi-x"></i></button>
                        </div>
                        <div class="folder-content hidden pl-4 mt-1 space-y-1"></div>
                    `;
                    const contentDiv = folderDiv.querySelector('.folder-content');
                    sessions.filter(s => s.folder === f.id).forEach(s => {
                        contentDiv.appendChild(createSessionElement(s));
                    });
                    historyContainer.appendChild(folderDiv);
                });

                // 2. Render Ungrouped
                const ungrouped = sessions.filter(s => !s.folder);
                if (ungrouped.length > 0) {
                    const label = document.createElement('div');
                    label.className = 'text-[9px] font-bold uppercase tracking-wider text-slate-600 px-3 py-2 mt-4 mb-1';
                    label.innerText = 'Trò chuyện gần đây';
                    label.ondragover = (e) => e.preventDefault();
                    label.ondrop = (e) => handleDropToFolder(e, "");
                    historyContainer.appendChild(label);
                    
                    ungrouped.forEach(s => {
                        historyContainer.appendChild(createSessionElement(s));
                    });
                }
                
                document.getElementById('session-count').innerText = sessions.length;
            } catch (err) { console.error(err); }
        }

        function createSessionElement(s) {
            const d = document.createElement('div');
            d.className = `group flex items-center justify-between p-2.5 rounded-xl cursor-pointer transition-all border ${currentSessionId === s.id ? 'bg-cyan-500/10 border-cyan-500/30' : 'hover:bg-white/5 border-transparent'}`;
            d.draggable = true;
            d.ondragstart = (e) => { e.dataTransfer.setData('sessionId', s.id); d.classList.add('opacity-50'); };
            d.ondragend = () => d.classList.remove('opacity-50');
            d.onclick = (e) => { if (!e.target.closest('button')) loadSessionDetail(s.id); };
            d.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <i class="bi bi-chat-left-text text-[10px] ${currentSessionId === s.id ? 'text-cyan-400' : 'text-slate-500'}"></i>
                    <span class="text-[11px] font-semibold truncate ${currentSessionId === s.id ? 'text-cyan-100' : 'text-slate-400'}">${s.title}</span>
                </div>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                    <button onclick="event.stopPropagation(); renameSession('${s.id}', \`${s.title.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="p-1 text-slate-500 hover:text-cyan-400"><i class="bi bi-pencil text-[10px]"></i></button>
                    <button onclick="event.stopPropagation(); deleteSession('${s.id}')" class="p-1 text-slate-500 hover:text-red-400"><i class="bi bi-trash text-[10px]"></i></button>
                </div>
            `;
            return d;
        }

        function toggleFolder(el) {
            const content = el.nextElementSibling;
            const icon = el.querySelector('.bi-chevron-right');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        }

        async function createFolder() {
            const { value: name } = await Swal.fire({
                title: 'Tạo thư mục mới',
                input: 'text',
                inputPlaceholder: 'Tên thư mục...',
                showCancelButton: true,
                background: '#0f172a', color: '#f1f5f9',
                confirmButtonColor: '#06b6d4'
            });
            if (name) {
                await fetch('/api/v1/chat/folders/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ name })
                });
                loadSessions();
            }
        }

        async function handleDropToFolder(e, folderId) {
            e.preventDefault();
            const sessId = e.dataTransfer.getData('sessionId');
            if (!sessId) return;
            
            await fetch(`/api/v1/chat/sessions/${sessId}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ folder_id: folderId })
            });
            loadSessions();
        }

        async function deleteFolder(id) {
            Swal.fire({
                title: 'Xóa thư mục?',
                text: 'Các cuộc trò chuyện bên trong sẽ không bị xóa.',
                icon: 'warning',
                showCancelButton: true,
                background: '#0f172a', color: '#f1f5f9',
                confirmButtonColor: '#06b6d4'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch(`/api/v1/chat/folders/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                    loadSessions();
                }
            });
        }

        async function loadSessionDetail(id) {
            currentSessionId = id;
            window.history.pushState({}, '', `/ai-assistant/${id}/`);
            try {
                const res = await fetch(`/api/v1/chat/sessions/${id}/`);
                const data = await res.json();
                chatTitle.innerText = data.title;
                messagesContainer.innerHTML = '';
                data.messages.forEach(m => addMessage(m.role, m.message, m.images || [], false, m.id, m.metadata));
                welcomeScreen.classList.add('hidden');
                scrollToBottom();
                loadSessions();
            } catch (err) { console.error(err); }
        }

        async function deleteSession(id) {
            const { isConfirmed } = await Swal.fire({
                title: 'Xóa hội thoại?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#06b6d4',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Xóa',
                background: '#0f172a',
                color: '#f1f5f9'
            });
            if (isConfirmed) {
                await fetch(`/api/v1/chat/sessions/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                if (currentSessionId === id) startNewChat();
                else loadSessions();
            }
        }

        async function renameSession(id, currentTitle) {
            const { value: newTitle } = await Swal.fire({
                title: 'Đổi tên cuộc trò chuyện',
                input: 'text',
                inputValue: currentTitle,
                showCancelButton: true,
                background: '#0f172a',
                color: '#f1f5f9',
                confirmButtonColor: '#06b6d4'
            });
            if (newTitle && newTitle !== currentTitle) {
                await fetch(`/api/v1/chat/sessions/${id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ title: newTitle })
                });
                if (currentSessionId === id) chatTitle.innerText = newTitle;
                loadSessions();
            }
        }

        function startNewChat() {
            currentSessionId = null;
            window.history.pushState({}, '', `/ai-assistant/`);
            messagesContainer.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            chatTitle.innerText = "Cuộc trò chuyện mới";
            clearEditMode();
            loadSessions();
        }

        function clearEditMode() {
            editModeMessageId = null;
            userInput.placeholder = "Nhập tin nhắn...";
            userInput.parentElement.classList.remove('ring-2', 'ring-amber-500/50');
        }

        function updateSendBtnState() {
            sendBtn.disabled = !userInput.value.trim() && pendingImages.length === 0 && !isStreaming;
            if (isStreaming) sendBtn.disabled = false;
        }

        function throttleRender(el, text) {
            const now = Date.now();
            if (now - lastRenderedTime > RENDER_THROTTLE_MS) {
                el.innerHTML = marked.parse(text) + '<span class="typing-cursor"></span>';
                lastRenderedTime = now;
            }
        }

        function scrollToBottom() {
            messagesWrapper.scrollTo({ top: messagesWrapper.scrollHeight, behavior: 'smooth' });
        }

        function handleImageUpload(e) {
            Array.from(e.target.files).forEach(f => {
                if (pendingImages.length >= 4) return;
                const r = new FileReader();
                r.onload = ev => {
                    pendingImages.push(ev.target.result);
                    const p = document.createElement('div');
                    p.className = 'relative w-16 h-16 rounded-xl overflow-hidden border border-white/10 group';
                    p.innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer" onclick="this.parentElement.remove(); pendingImages=pendingImages.filter(i=>i!=='${ev.target.result}'); updateSendBtnState();">
                        <i class="bi bi-x-circle text-white"></i></div>`;
                    imagePreviews.appendChild(p);
                    updateSendBtnState();
                };
                r.readAsDataURL(f);
            });
        }

        function copyToClipboard(btn) {
            const actions = btn.closest('.msg-actions');
            const raw = actions.dataset.rawText;
            const text = decodeURIComponent(raw);
            navigator.clipboard.writeText(text).then(() => {
                const icon = btn.querySelector('i');
                icon.className = 'bi bi-check';
                setTimeout(() => icon.className = 'bi bi-clipboard', 2000);
            });
        }

        function editMessage(btn, id, text) {
            editModeMessageId = id;
            userInput.value = text;
            userInput.focus();
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            userInput.parentElement.classList.add('ring-2', 'ring-amber-500/50');
            userInput.placeholder = "Đang chỉnh sửa...";
        }

        function addAnnotatedImage(assistantMsgDiv, base64) {
            const bubble = assistantMsgDiv.querySelector('.msg-bubble');
            const imgDiv = document.createElement('div');
            imgDiv.className = 'mt-3 mb-4 rounded-xl overflow-hidden border border-cyan-500/30 shadow-lg';
            imgDiv.innerHTML = `<img src="${base64}" class="w-full h-auto cursor-zoom-in" onclick="window.open(this.src)">`;
            bubble.appendChild(imgDiv);
        }

        function renderSearchResults(assistantMsgDiv, metadata) {
            const container = assistantMsgDiv.querySelector('.search-results-container');
            if (!metadata) return;
            
            const results = [];
            if (metadata.internal_knowledge) {
                results.push(...metadata.internal_knowledge.map(r => ({ ...r, type: 'rag' })));
            }
            if (metadata.web_search) {
                results.push(...metadata.web_search.map(r => ({ ...r, type: 'web' })));
            }
            
            if (results.length === 0) return;

            let html = `<div class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2">
                <i class="bi bi-globe"></i> Nguồn tham khảo
            </div>`;

            results.forEach(res => {
                const isRag = res.type === 'rag';
                html += `
                <a href="${res.url}" target="_blank" class="block p-2 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 hover:border-cyan-500/20 transition-all text-xs mb-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[8px] px-1.5 py-0.5 rounded ${isRag ? 'bg-purple-500/20 text-purple-400' : 'bg-cyan-500/20 text-cyan-400'} font-bold uppercase">
                            ${isRag ? 'ShieldCall Knowledge' : 'Web Resource'}
                        </span>
                        <div class="font-bold text-slate-200 truncate flex-1">${res.title}</div>
                    </div>
                    ${res.text ? `<div class="text-[10px] text-slate-500 line-clamp-2 mb-1 font-medium italic">"${res.text}"</div>` : ''}
                    <div class="text-[9px] text-slate-600 truncate opacity-50">${res.url}</div>
                </a>`;
            });
            container.innerHTML = html;
            container.classList.remove('empty:hidden');
        }

        function processToolInText(assistantMsgDiv, text) {
            const bubble = assistantMsgDiv.querySelector('.msg-bubble');
            // Scan for [[SCAN_PHONE:xxx]] etc
            const phoneMatch = text.match(/\[\[SCAN_PHONE:(.*?)\]\]/);
            if (phoneMatch) createScannerWidget(bubble, 'phone', phoneMatch[1]);
            const domainMatch = text.match(/\[\[SCAN_DOMAIN:(.*?)\]\]/);
            if (domainMatch) createScannerWidget(bubble, 'domain', domainMatch[1]);
            const accountMatch = text.match(/\[\[SCAN_ACCOUNT:(.*?)\]\]/);
            if (accountMatch) createScannerWidget(bubble, 'account', accountMatch[1]);
        }

        function createScannerWidget(container, type, value) {
            const widget = document.createElement('div');
            widget.className = 'tool-widget';
            let icon = 'bi-telephone';
            let label = 'Kiểm tra SĐT';
            if (type === 'domain') { icon = 'bi-globe'; label = 'Kiểm tra Website'; }
            if (type === 'account') { icon = 'bi-bank'; label = 'Kiểm tra TK Ngân hàng'; }
            
            widget.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                    <i class="bi ${icon}"></i>
                </div>
                <div class="flex-1">
                    <div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">${label}</div>
                    <div class="text-sm font-bold text-slate-200">${value}</div>
                </div>
                <div class="text-[10px] px-2 py-1 rounded bg-green-500/20 text-green-400 font-bold">AN TOÀN</div>
            `;
            container.appendChild(widget);
        }

        function getCookie(n) {
            let v = null;
            if(document.cookie && document.cookie!=='') {
                document.cookie.split(';').forEach(c=>{
                    let t = c.trim();
                    if(t.substring(0,n.length+1)===(n+'=')) v=decodeURIComponent(t.substring(n.length+1));
                });
            }
            return v;
        }

        function setPrompt(p) {
            userInput.value = p;
            userInput.dispatchEvent(new Event('input'));
            userInput.focus();
        }

        function showToast(m, t) {
            Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, icon: t, title: m, background: '#1e293b', color: '#f8fafc' });
        }
    </script>
</body>
</html>
